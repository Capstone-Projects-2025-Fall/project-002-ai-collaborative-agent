<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AI Collab Agent - Team Platform</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      color: #333;
    }

    .container { max-width: 1200px; margin: 0 auto; padding: 20px; }

    .header { text-align: center; margin-bottom: 30px; color: white; }
    .header h1 {
      font-size: 2.5rem; font-weight: 700; margin-bottom: 8px;
      text-shadow: 0 2px 10px rgba(0,0,0,0.3);
    }
    .header p { font-size: 1.1rem; opacity: 0.9; }

    .tabs {
      display: flex; gap: 8px; margin-bottom: 25px; justify-content: center; flex-wrap: wrap;
    }
    .tab-button {
      padding: 12px 24px; background: rgba(255,255,255,0.1); border: none; border-radius: 25px; color: white;
      font-size: 0.95rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2);
    }
    .tab-button:hover { background: rgba(255,255,255,0.2); transform: translateY(-1px); }
    .tab-button.active { background: rgba(255,255,255,0.3); border-color: rgba(255,255,255,0.5); }

    .tab-content {
      display: none; background: rgba(255,255,255,0.95); border-radius: 15px; padding: 30px;
      box-shadow: 0 15px 35px rgba(0,0,0,0.1); backdrop-filter: blur(20px);
    }
    .tab-content.active { display: block; animation: slideIn 0.3s ease-out; }
    @keyframes slideIn { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }

    .form-grid { display: grid; gap: 20px; margin-bottom: 25px; }
    .form-group { display: flex; flex-direction: column; }
    .form-group label { font-weight: 600; margin-bottom: 6px; color: #374151; font-size: 0.9rem; }
    .form-group input, .form-group textarea, .form-group select {
      padding: 12px; border: 2px solid #e5e7eb; border-radius: 8px; font-size: 0.95rem; transition: all 0.3s ease; background: white;
    }
    .form-group input:focus, .form-group textarea:focus, .form-group select:focus {
      outline: none; border-color: #667eea; box-shadow: 0 0 0 3px rgba(102,126,234,0.1);
    }
    .form-group textarea { resize: vertical; min-height: 100px; font-family: inherit; }

    .button-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 20px; }
    .btn { padding: 12px 20px; border: none; border-radius: 8px; font-size: 0.9rem; font-weight: 600; cursor: pointer; transition: all 0.3s ease; }
    .btn-primary { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }
    .btn-primary:hover { transform: translateY(-1px); box-shadow: 0 4px 12px rgba(102,126,234,0.3); }
    .btn-secondary { background: #f1f5f9; color: #475569; }
    .btn-secondary:hover { background: #e2e8f0; }

    .user-list, .project-list { background: #f8fafc; border-radius: 12px; padding: 15px; margin: 15px 0; }
    .user-item, .project-item {
      background: white; border-radius: 8px; padding: 15px; margin: 8px 0; border-left: 4px solid #667eea; box-shadow: 0 2px 8px rgba(0,0,0,0.05);
    }
    .user-item h3, .project-item h3 { color: #1e293b; margin-bottom: 8px; font-size: 1.1rem; }
    .user-item p, .project-item p { color: #64748b; margin: 4px 0; font-size: 0.9rem; }

    .prompt-output {
      background: #1e293b; color: #e2e8f0; border-radius: 12px; padding: 20px; margin: 15px 0;
      font-family: 'Consolas','Monaco',monospace; white-space: pre-wrap; max-height: 400px; overflow-y: auto;
      font-size: 0.85rem; line-height: 1.4;
    }

    .status-message { padding: 12px; border-radius: 8px; margin: 10px 0; font-weight: 600; font-size: 0.9rem; }
    .status-success { background: #dcfce7; color: #166534; }
    .status-error { background: #fef2f2; color: #991b1b; }

    .multi-select { border: 2px solid #e5e7eb; border-radius: 8px; padding: 8px; max-height: 150px; overflow-y: auto; }
    .multi-select label { display: flex; align-items: center; padding: 6px; margin: 2px 0; border-radius: 4px; cursor: pointer; font-size: 0.9rem; }
    .multi-select label:hover { background: #f1f5f9; }
    .multi-select input[type="checkbox"] { margin-right: 8px; }

    .section-title {
      font-size: 1.3rem; font-weight: 700; color: #1e293b; margin-bottom: 15px; display: flex; align-items: center;
    }
    .section-title::before {
      content: ''; width: 3px; height: 24px; background: linear-gradient(135deg, #667eea, #764ba2);
      margin-right: 12px; border-radius: 2px;
    }

    .stats-grid {
      display: grid; grid-template-columns: repeat(auto-fit, minmax(150px,1fr)); gap: 15px; margin: 20px 0;
    }
    .stat-card {
      background: rgba(255,255,255,0.1); border-radius: 12px; padding: 20px; text-align: center; backdrop-filter: blur(10px);
      border: 1px solid rgba(255,255,255,0.2); color: white;
    }
    .stat-card h3 { font-size: 1.8rem; font-weight: 700; margin-bottom: 4px; }
    .stat-card p { opacity: 0.8; font-weight: 500; font-size: 0.9rem; }

    @media (max-width: 768px) {
      .container { padding: 10px; }
      .header h1 { font-size: 2rem; }
      .tab-content { padding: 20px; }
    }
  </style>
</head>
<body>
  <div class="container">
    <div class="header">
      <h1>ðŸš€ AI Collab Agent</h1>
      <p>Team Collaboration & AI-Powered Project Management</p>

      <div class="stats-grid">
        <div class="stat-card">
          <h3 id="userCount">0</h3>
          <p>Team Members</p>
        </div>
        <div class="stat-card">
          <h3 id="projectCount">0</h3>
          <p>Projects</p>
        </div>
        <div class="stat-card">
          <h3 id="promptCount">0</h3>
          <p>AI Prompts</p>
        </div>
      </div>
    </div>

    <div class="tabs">
      <button class="tab-button active" data-tab="users">ðŸ‘¥ Team Members</button>
      <button class="tab-button" data-tab="projects">ðŸ“‹ Projects</button>
      <button class="tab-button" data-tab="prompts">ðŸ¤– AI Prompts</button>
    </div>

    <!-- USERS TAB -->
    <div id="users" class="tab-content active">
      <div class="section-title">Add Team Member</div>
      <form class="form-grid">
        <div class="form-group">
          <label for="userName">Full Name *</label>
          <input type="text" id="userName" required placeholder="Enter full name">
        </div>
        <div class="form-group">
          <label for="userSkills">Skills *</label>
          <input type="text" id="userSkills" required placeholder="e.g., Leadership, Design, Analysis">
        </div>
        <div class="form-group">
          <label for="userLanguages">Programming Languages *</label>
          <input type="text" id="userLanguages" required placeholder="e.g., Python, JavaScript, TypeScript">
        </div>
        <div class="form-group">
          <label for="userWilling">Willing to Work On</label>
          <textarea id="userWilling" placeholder="Describe interests and preferred project types..."></textarea>
        </div>
      </form>

      <div class="button-group">
        <button id="add-user-btn" class="btn btn-primary">Add Member</button>
        <button id="clear-user-form-btn" class="btn btn-secondary">Clear Form</button>
      </div>

      <div id="userStatus" class="status-message" style="display: none;"></div>

      <div class="section-title">Team Members</div>
      <div id="userList" class="user-list">
        <p style="text-align:center; color:#64748b; padding:15px;">No team members yet</p>
      </div>
    </div>

    <!-- PROJECTS TAB -->
    <div id="projects" class="tab-content">
      <div class="section-title">Create Project</div>
      <form class="form-grid">
        <div class="form-group">
          <label for="projectName">Project Name *</label>
          <input type="text" id="projectName" required placeholder="Enter project name">
        </div>
        <div class="form-group">
          <label for="projectDescription">Description *</label>
          <textarea id="projectDescription" required placeholder="Describe the project..."></textarea>
        </div>
        <div class="form-group">
          <label for="projectGoals">Goals</label>
          <textarea id="projectGoals" placeholder="List main objectives..."></textarea>
        </div>
        <div class="form-group">
          <label for="projectRequirements">Requirements</label>
          <textarea id="projectRequirements" placeholder="Technical requirements and constraints..."></textarea>
        </div>
        <div class="form-group">
          <label>Select Team Members *</label>
          <div id="userSelection" class="multi-select">
            <p style="text-align: center; color:#64748b; padding:10px;">Add team members first</p>
          </div>
        </div>
      </form>

      <div class="button-group">
        <button id="create-project-btn" class="btn btn-primary">Create Project</button>
        <button id="clear-project-form-btn" class="btn btn-secondary">Clear Form</button>
      </div>

      <div id="projectStatus" class="status-message" style="display: none;"></div>

      <div class="section-title">Projects</div>
      <div id="projectList" class="project-list">
        <p style="text-align:center; color:#64748b; padding:15px;">No projects yet</p>
      </div>
    </div>

    <!-- PROMPTS TAB -->
    <div id="prompts" class="tab-content">
      <div class="section-title">AI Prompt Generator</div>

      <div class="form-group">
        <label for="promptProject">Select Project</label>
        <select id="promptProject">
          <option value="">Choose a project...</option>
        </select>
      </div>
      <div class="button-group">
        <button id="generate-prompt-btn" class="btn btn-primary">Generate AI Prompt</button>
        <button id="copy-prompt-btn" class="btn btn-secondary">Copy Prompt</button>
      </div>
      <div id="promptStatus" class="status-message" style="display: none;"></div>

      <!-- NEW: Freeform â†’ Create Jira Tasks -->
      <div class="section-title" style="margin-top:24px;">Create Jira Tasks from Description</div>
      <div class="form-group">
        <label for="freeformDescription">Describe your project</label>
        <textarea id="freeformDescription" placeholder="Type your project idea..."></textarea>
      </div>
      <div class="button-group">
        <button id="create-jira-from-text-btn" class="btn btn-primary">Create Jira Tasks</button>
      </div>

      <div class="section-title" style="margin-top:24px;">Generated Prompt</div>
      <div id="promptOutput" class="prompt-output">
        Select a project above to generate an AI-optimized prompt for team analysis and task allocation.

        The generated prompt will include:
        â€¢ Complete project information
        â€¢ Team member skills and preferences
        â€¢ Analysis requests for AI models
        â€¢ Task assignment recommendations
        â€¢ Risk assessment guidelines
      </div>

      <div class="button-group" style="justify-content: right">
        <button id="start-project" class="btn btn-primary">Start Project</button>
      </div>
    </div>
  </div>

  <script>
    // VS Code API
    const vscode = acquireVsCodeApi();

    // Classes
    class TeamMember {
      constructor(name, skills, programmingLanguages, willingToWorkOn) {
        this.name = name;
        this.skills = skills;
        this.programmingLanguages = programmingLanguages;
        this.willingToWorkOn = willingToWorkOn;
        this.id = Date.now() + Math.random();
        this.createdAt = new Date().toISOString();
      }
    }

    class Project {
      // Store selected member IDs on the project
      constructor(name, description, goals, requirements, selectedMemberIds = []) {
        this.name = name;
        this.description = description;
        this.goals = goals;
        this.requirements = requirements;
        this.selectedMemberIds = selectedMemberIds;
        this.id = Date.now() + Math.random();
        this.createdAt = new Date().toISOString();
      }
    }

    class TeamCollaborationApp {
      constructor() {
        this.users = [];
        this.projects = [];
        this.promptCount = 0;
        vscode.postMessage({ type: 'loadData' });
      }

      loadData(data) {
        if (data.users) {
          this.users = data.users.map(d => {
            const u = new TeamMember(d.name, d.skills, d.programmingLanguages, d.willingToWorkOn);
            u.id = d.id; u.createdAt = d.createdAt;
            return u;
          });
        }
        if (data.projects) {
          this.projects = data.projects.map(p => {
            const ids = Array.isArray(p.selectedMemberIds) ? p.selectedMemberIds : [];
            const proj = new Project(p.name, p.description, p.goals, p.requirements, ids);
            proj.id = p.id; proj.createdAt = p.createdAt;
            return proj;
          });
        }
        if (data.promptCount !== undefined) {
          this.promptCount = data.promptCount;
        }
        this.updateUI();
      }

      saveData() {
        vscode.postMessage({
          type: 'saveData',
          payload: { users: this.users, projects: this.projects, promptCount: this.promptCount }
        });
      }

      addUser(name, skills, programmingLanguages, willingToWorkOn) {
        if (!name || !skills || !programmingLanguages) throw new Error('Name, skills, and programming languages are required');
        const user = new TeamMember(name, skills, programmingLanguages, willingToWorkOn);
        this.users.push(user);
        this.saveData();
        this.updateUI();
        return user;
      }

      createProject(name, description, goals, requirements, selectedUserIds) {
        if (!name || !description) throw new Error('Project name and description are required');
        if (!selectedUserIds || selectedUserIds.length === 0) throw new Error('At least one team member must be selected');
        const project = new Project(name, description, goals, requirements, selectedUserIds);
        this.projects.push(project);
        this.saveData();
        this.updateUI();
        return project;
      }

      generateAIPrompt(projectId) {
        vscode.postMessage({ type: 'generatePrompt', payload: { projectId } });
        document.getElementById('promptOutput').textContent = 'Generating AI prompt... Please wait.';
        showStatus('promptStatus', 'Generating AI prompt...', 'success');
      }

      updateUI() {
        this.updateStats();
        this.updateUserList();
        this.updateProjectList();
        this.updateUserSelection();
        this.updateProjectSelection();
      }

      updateStats() {
        document.getElementById('userCount').textContent = this.users.length.toString();
        document.getElementById('projectCount').textContent = this.projects.length.toString();
        document.getElementById('promptCount').textContent = this.promptCount.toString();
      }

      updateUserList() {
        const list = document.getElementById('userList');
        if (this.users.length === 0) {
          list.innerHTML = '<p style="text-align:center; color:#64748b; padding:15px;">No team members yet</p>';
          return;
        }
        list.innerHTML = this.users.map(user => `
          <div class="user-item">
            <h3>ðŸ‘¤ ${user.name}</h3>
            <p><strong>Skills:</strong> ${user.skills}</p>
            <p><strong>Languages:</strong> ${user.programmingLanguages}</p>
            <p><strong>Interests:</strong> ${user.willingToWorkOn || 'Not specified'}</p>
            <p><strong>Added:</strong> ${new Date(user.createdAt).toLocaleString()}</p>
            <button class="btn btn-secondary remove-user-btn" data-user-id="${user.id}" style="margin-top:8px; padding:6px 12px; font-size:0.8rem;">Remove</button>
          </div>
        `).join('');
      }

      updateProjectList() {
        const list = document.getElementById('projectList');
        if (this.projects.length === 0) {
          list.innerHTML = '<p style="text-align:center; color:#64748b; padding:15px;">No projects yet</p>';
          return;
        }
        list.innerHTML = this.projects.map(project => {
          const members = this.users.filter(u => project.selectedMemberIds.includes(u.id));
          const names = members.map(m => m.name).join(', ') || 'No members assigned';
          return `
            <div class="project-item">
              <h3>ðŸ“‹ ${project.name}</h3>
              <p><strong>Description:</strong> ${project.description}</p>
              <p><strong>Goals:</strong> ${project.goals || 'Not specified'}</p>
              <p><strong>Requirements:</strong> ${project.requirements || 'Not specified'}</p>
              <p><strong>Team:</strong> ${names}</p>
              <p><strong>Created:</strong> ${new Date(project.createdAt).toLocaleString()}</p>
              <button class="btn btn-secondary remove-project-btn" data-project-id="${project.id}" style="margin-top:8px; padding:6px 12px; font-size:0.8rem;">Remove</button>
            </div>
          `;
        }).join('');
      }

      updateUserSelection() {
        const wrap = document.getElementById('userSelection');
        if (this.users.length === 0) {
          wrap.innerHTML = '<p style="text-align:center; color:#64748b; padding:10px;">Add team members first</p>';
          return;
        }
        wrap.innerHTML = this.users.map(u => `
          <label>
            <input type="checkbox" value="${u.id}">
            <span><strong>${u.name}</strong> - ${u.skills}</span>
          </label>
        `).join('');
      }

      updateProjectSelection() {
        const select = document.getElementById('promptProject');
        select.innerHTML = '<option value="">Choose a project...</option>' +
          this.projects.map(p => `<option value="${p.id}">${p.name}</option>`).join('');
      }

      removeUser(userId) {
        this.users = this.users.filter(u => u.id != userId);
        this.projects.forEach(p => { p.selectedMemberIds = p.selectedMemberIds.filter(id => id != userId); });
        this.saveData(); this.updateUI();
        showStatus('userStatus', 'Team member removed successfully!', 'success');
      }

      removeProject(projectId) {
        this.projects = this.projects.filter(p => p.id != projectId);
        this.saveData(); this.updateUI();
        showStatus('projectStatus', 'Project removed successfully!', 'success');
      }
    }

    // Global app instance
    const app = new TeamCollaborationApp();

    // Message handling from extension
    window.addEventListener('message', (event) => {
      const message = event.data;
      switch (message.type) {
        case 'requestData':
          vscode.postMessage({ type: 'loadData' });
          break;
        case 'dataLoaded':
          app.loadData(message.payload); // re-render
          break;
        case 'promptGeneratedFromExtension':
          document.getElementById('promptOutput').textContent = message.payload.prompt;
          showStatus('promptStatus', ' AI Prompt generated! See editor for markdown.', 'success');
          break;
        case 'aiResponseReceived': // kept from main
          const promptOutput = document.getElementById('promptOutput');
          if (promptOutput) {
            promptOutput.textContent = `${message.payload.prompt}\n\n${"=".repeat(80)}\nAI RESPONSE:\n${"=".repeat(80)}\n\n${message.payload.response}`;
          }
          showStatus('promptStatus', ' AI analysis complete! Tasks delegated to team members. Check editor for details.', 'success');
          break;
        case 'promptGenerationError':
          showStatus('promptStatus', `Error: ${message.payload.message}`, 'error');
          break;
        // NEW: Jira integration message cases
        case 'jiraCreated':
          showStatus('promptStatus', message.payload?.message || 'Jira issues created!', 'success');
          break;
        case 'jiraError':
          showStatus('promptStatus', message.payload?.message || 'Failed to create Jira issues.', 'error');
          break;
      }
    });

    // UI helpers
    function showTab(tabName, clickedButton) {
      document.querySelectorAll('.tab-content').forEach(t => t.classList.remove('active'));
      document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
      document.getElementById(tabName).classList.add('active');
      if (clickedButton) clickedButton.classList.add('active');
    }

    function showStatus(elementId, message, type = 'success') {
      const el = document.getElementById(elementId);
      el.textContent = message;
      el.className = 'status-message status-' + type;
      el.style.display = 'block';
      setTimeout(() => { el.style.display = 'none'; }, 5000);

      if (type === 'success') {
        vscode.postMessage({ type: 'showSuccess', payload: { message } });
      } else {
        vscode.postMessage({ type: 'showError', payload: { message } });
      }
    }

    function addUser() {
      try {
        const name = document.getElementById('userName').value.trim();
        const skills = document.getElementById('userSkills').value.trim();
        const languages = document.getElementById('userLanguages').value.trim();
        const willing = document.getElementById('userWilling').value.trim();
        const user = app.addUser(name, skills, languages, willing);
        clearUserForm();
        showStatus('userStatus', `${user.name} added successfully! Total: ${app.users.length}`, 'success');
      } catch (e) {
        showStatus('userStatus', 'Error: ' + (e && e.message ? e.message : e), 'error');
      }
    }

    function clearUserForm() {
      document.getElementById('userName').value = '';
      document.getElementById('userSkills').value = '';
      document.getElementById('userLanguages').value = '';
      document.getElementById('userWilling').value = '';
    }

    function createProject() {
      try {
        const name = document.getElementById('projectName').value.trim();
        const description = document.getElementById('projectDescription').value.trim();
        const goals = document.getElementById('projectGoals').value.trim();
        const requirements = document.getElementById('projectRequirements').value.trim();
        const selected = document.querySelectorAll('#userSelection input[type="checkbox"]:checked');
        const ids = Array.from(selected).map(cb => cb.value);
        const project = app.createProject(name, description, goals, requirements, ids);
        clearProjectForm();
        showStatus('projectStatus', 'ðŸš€ ' + project.name + ' created successfully! Total: ' + app.projects.length, 'success');
      } catch (e) {
        showStatus('projectStatus', 'Error: ' + (e && e.message ? e.message : e), 'error');
      }
    }

    function clearProjectForm() {
      document.getElementById('projectName').value = '';
      document.getElementById('projectDescription').value = '';
      document.getElementById('projectGoals').value = '';
      document.getElementById('projectRequirements').value = '';
      document.querySelectorAll('#userSelection input[type="checkbox"]').forEach(cb => { cb.checked = false; });
    }

    function generatePrompt() {
      try {
        const projectId = document.getElementById('promptProject').value;
        if (!projectId) throw new Error('Please select a project');
        app.generateAIPrompt(projectId);
      } catch (e) {
        showStatus('promptStatus', 'Error: ' + (e && e.message ? e.message : e), 'error');
      }
    }

    function copyPrompt() {
      const el = document.getElementById('promptOutput');
      const text = el.textContent || '';
      if (!text.trim() || text.includes('Select a project above') || text.includes('Generating AI prompt')) {
        showStatus('promptStatus', ' No prompt to copy. Generate a prompt first.', 'error');
        return;
      }
      navigator.clipboard.writeText(text)
        .then(() => showStatus('promptStatus', ' Prompt copied to clipboard!', 'success'))
        .catch(() => showStatus('promptStatus', ' Failed to copy to clipboard', 'error'));
    }

    function startProject() {
      try {
        const projectId = document.getElementById('promptProject').value;
        const project = app.projects.find(p => p.id == projectId);
        if (!projectId) throw new Error('Please select a project to start');
        vscode.postMessage({ type: 'startProject', payload: { projectId } });
        vscode.postMessage({ type: 'openFile', payload: { filePath: `projects/${projectId}/README.md` } });
        showStatus('promptStatus', 'Starting ' + (project ? project.name : 'Unknown Project'), 'success');
      } catch (error) {
        showStatus('promptStatus', 'Error: ' + error.message, 'error');
      }
    }

    // Event wiring
    document.addEventListener('DOMContentLoaded', () => {
      document.getElementById('add-user-btn')?.addEventListener('click', addUser);
      document.getElementById('clear-user-form-btn')?.addEventListener('click', clearUserForm);
      document.getElementById('create-project-btn')?.addEventListener('click', createProject);
      document.getElementById('clear-project-form-btn')?.addEventListener('click', clearProjectForm);
      document.getElementById('generate-prompt-btn')?.addEventListener('click', generatePrompt);
      document.getElementById('copy-prompt-btn')?.addEventListener('click', copyPrompt);
      document.getElementById('start-project')?.addEventListener('click', startProject);

      // NEW: freeform â†’ create Jira tasks
      document.getElementById('create-jira-from-text-btn')?.addEventListener('click', () => {
        const textarea = document.getElementById('freeformDescription');
        const text = textarea ? textarea.value.trim() : '';
        if (!text) { showStatus('promptStatus', 'Please enter a description', 'error'); return; }
        vscode.postMessage({ type: 'createJiraFromDescription', payload: { description: text } });
        showStatus('promptStatus', 'Creating Jira tasks from your descriptionâ€¦', 'success');
      });

      // Tabs + delegated click handlers
      document.body.addEventListener('click', (event) => {
        const target = event.target;
        if (target && target.matches('.tab-button')) {
          showTab(target.dataset.tab, target);
        }
        if (target && target.matches('.remove-user-btn')) {
          const userId = target.dataset.userId;
          if (userId) app.removeUser(userId);
        }
        if (target && target.matches('.remove-project-btn')) {
          const projectId = target.dataset.projectId;
          if (projectId) app.removeProject(projectId);
        }
      });

      app.updateUI();
      showTab('users', document.querySelector('.tab-button[data-tab="users"]'));
      console.log('ðŸš€ AI Collab Agent - Team Platform initialized!');
    });
  </script>
</body>
</html>
