<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Collab Agent - Team Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
            margin-top: 16px;
        }

        .tabs {
            display: flex;
            gap: 8px;
            margin-bottom: 25px;
            justify-content: center;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 12px 24px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            border-radius: 25px;
            color: white;
            font-size: 0.95rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        .tab-button:hover {
            background: rgba(255, 255, 255, 0.2);
            transform: translateY(-1px);
        }

        .tab-button.active {
            background: rgba(255, 255, 255, 0.3);
            border-color: rgba(255, 255, 255, 0.5);
        }

        .tab-button.tab-disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .tab-content {
            display: none;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.1);
            backdrop-filter: blur(20px);
        }

        .tab-content.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .label-with-action {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
            flex-wrap: wrap;
        }

        .label-with-action button {
            white-space: nowrap;
            font-size: 0.85rem;
            padding: 8px 14px;
        }

        .jira-setup-grid {
            display: flex;
            flex-direction: column;
            gap: 18px;
            align-items: stretch;
            margin-bottom: 22px;
            width: 100%;
        }

        .jira-hero-card {
            background: linear-gradient(135deg, #eef2ff, #e0f2fe);
            color: #000000;
            border-radius: 16px;
            padding: 18px 20px;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.35);
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .jira-hero-card h3 {
            font-size: 1.2rem;
            margin: 0;
            color: #000000;
        }

        .jira-hero-card p {
            margin: 0;
            line-height: 1.6;
            color: #000000;
        }

        .jira-hero-steps {
            display: grid;
            gap: 10px;
        }

        .jira-pill {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 12px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            color: #000000;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .jira-setup-actions {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
        }

        .jira-credentials-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px 20px;
            box-shadow: 0 15px 35px rgba(15, 23, 42, 0.12);
        }

        .jira-credentials-card input,
        .jira-credentials-card textarea,
        .jira-credentials-card select {
            color: #000000 !important;
            font-weight: 500;
        }

        .jira-credentials-card input::placeholder,
        .jira-credentials-card textarea::placeholder {
            color: #94a3b8 !important;
            opacity: 1;
        }

        .jira-credentials-card label {
            color: #000000 !important;
            font-weight: 600;
        }

        #jiraAssignableCard,
        #jiraBoard {
            width: 100%;
        }

        #jiraAssignableCard {
            margin-top: 18px;
        }

        #jiraBoard {
            margin-top: 18px;
        }

        #jiraTaskStatus,
        #jiraCredentialsWarning {
            margin: 10px 0 14px;
        }

        .jira-credentials-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            gap: 10px;
            flex-wrap: wrap;
        }

        .jira-credentials-body {
            margin-top: 14px;
        }

        .jira-credentials-card.collapsed .jira-credentials-body {
            display: none;
        }

        .jira-quick-actions {
            position: sticky;
            top: 8px;
            right: 0;
            z-index: 10;
            display: inline-flex;
            justify-content: flex-end;
            align-items: center;
            gap: 8px;
            padding: 4px 10px;
            margin: 0 0 6px auto;
            background: linear-gradient(135deg, #eef2ff, #fff);
            color: #000000;
            border-radius: 14px;
            box-shadow: 0 10px 24px rgba(99, 102, 241, 0.12);
            border: 1px solid rgba(99, 102, 241, 0.25);
            width: auto;
        }

        .jira-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            flex-wrap: wrap;
            gap: 12px;
            margin-bottom: 10px;
            position: sticky;
            top: 8px;
            z-index: 15;
            padding: 4px 8px;
            background: rgba(255, 255, 255, 0.96);
            backdrop-filter: blur(8px);
            border-radius: 12px;
            border: 1px solid rgba(219, 234, 254, 0.9);
        }

        .jira-header .section-title {
            margin-bottom: 0;
            color: #000000 !important;
        }

        /* Override CSS variables for Jira section headings */
        #jira .section-title,
        #jira .profile-card-title {
            color: #000000 !important;
        }

        #jira .jira-credentials-card .profile-card-title {
            color: #000000 !important;
        }

        /* Fix paragraph text in Jira sections */
        #jira p {
            color: #1e293b !important;
        }

        #jira .jira-credentials-card p {
            color: #1e293b !important;
        }

        /* Override inline styles for Jira paragraph text */
        #jiraAssignableCard p[style*="color"] {
            color: #1e293b !important;
        }

        .jira-quick-actions .quick-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-weight: 600;
            letter-spacing: 0.01em;
        }

        .jira-quick-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: #22c55e;
            box-shadow: 0 0 0 6px rgba(34, 197, 94, 0.18);
        }

        .button-group.compact {
            gap: 6px;
        }

        .button-group.compact .btn {
            padding: 6px 10px;
            font-size: 0.9rem;
        }

        .jira-collapsible-card {
            transition: border-color 0.2s ease, box-shadow 0.2s ease;
        }

        .jira-collapsible-card.collapsed {
            border-color: #e2e8f0;
            box-shadow: 0 5px 12px rgba(15, 23, 42, 0.06);
        }

        .collapsible-header {
            display: flex;
            align-items: flex-start;
            justify-content: space-between;
            gap: 12px;
        }

        .collapsible-body {
            margin-top: 12px;
        }

        .jira-collapsible-card.collapsed .collapsible-body {
            display: none;
        }

        .jira-layout {
            display: flex;
            gap: 24px;
            margin-top: 20px;
            flex-wrap: wrap;
            align-items: stretch;
        }

        .jira-column {
            flex: 1;
            min-width: 320px;
            background: rgba(248, 250, 252, 0.95);
            border: 1px solid #dbeafe;
            border-radius: 18px;
            padding: 20px;
            display: flex;
            flex-direction: column;
            min-height: 420px;
            height: 75vh;
            overflow: hidden;
            box-shadow: 0 20px 45px rgba(15, 23, 42, 0.08);
        }

        .jira-task-list {
            flex: 1;
            overflow-y: auto;
            margin-top: 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
            padding-right: 6px;
            min-height: 0;
        }

        .jira-task-list::-webkit-scrollbar {
            width: 6px;
        }

        .jira-task-list::-webkit-scrollbar-thumb {
            background: rgba(99, 102, 241, 0.4);
            border-radius: 999px;
        }

        .jira-task-row {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            gap: 14px;
            padding: 14px 16px;
            border: 1px solid rgba(99, 102, 241, 0.08);
            border-radius: 14px;
            cursor: pointer;
            transition: border 0.2s ease, background 0.2s ease, transform 0.2s ease, box-shadow 0.2s ease;
            background: white;
            box-shadow: 0 4px 14px rgba(15, 23, 42, 0.04);
            flex-wrap: wrap;
        }

        .jira-task-row:hover {
            border-color: rgba(99, 102, 241, 0.35);
            transform: translateY(-1px);
            box-shadow: 0 8px 20px rgba(15, 23, 42, 0.08);
        }

        .jira-task-row.selected {
            border-color: #6366f1;
            background: linear-gradient(135deg, rgba(238, 242, 255, 0.95), rgba(219, 234, 254, 0.7));
            box-shadow: 0 10px 30px rgba(99, 102, 241, 0.25);
        }

        .jira-task-content {
            flex: 1;
            min-width: 0;
        }

        .jira-task-summary {
            font-weight: 600;
            color: #000000;
            line-height: 1.4;
            word-break: break-word;
        }

        .jira-task-key {
            display: inline-block;
            padding: 2px 10px;
            margin-right: 8px;
            border-radius: 999px;
            background: rgba(99, 102, 241, 0.12);
            color: #000000;
            font-size: 0.78rem;
            font-weight: 700;
        }

        .jira-task-purpose {
            font-size: 0.85rem;
            color: #000000;
            margin-top: 8px;
            line-height: 1.4;
        }

        .jira-task-meta {
            font-size: 0.8rem;
            color: #000000;
            margin-top: 6px;
        }

        .jira-status-chip {
            background: linear-gradient(135deg, #f0f9ff, #dbeafe);
            color: #000000;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 0.78rem;
            font-weight: 600;
            white-space: nowrap;
            align-self: flex-start;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.8);
        }

        .jira-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
            margin-bottom: 12px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 14px;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.08);
        }

        .jira-controls select,
        .jira-controls input {
            flex: 1;
            min-width: 160px;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            color: #000000 !important;
            font-weight: 500;
        }

        .jira-controls select {
            color: #000000 !important;
        }

        .jira-controls input::placeholder {
            color: #94a3b8 !important;
            opacity: 1;
        }

        .jira-detail {
            display: flex;
            flex-direction: column;
            gap: 16px;
            background: white;
            border: 1px solid #e2e8f0;
            border-radius: 16px;
            padding: 18px;
            box-shadow: 0 12px 30px rgba(15, 23, 42, 0.08);
            flex: 1;
            min-height: 0;
            height: 100%;
            overflow-y: auto;
        }

        .jira-detail select,
        .jira-detail textarea,
        .jira-detail input {
            width: 100%;
            max-width: 100%;
            box-sizing: border-box;
            padding: 10px 12px;
            border-radius: 10px;
            border: 1px solid #e2e8f0;
            background: white;
            overflow: hidden;
            color: #000000 !important;
            font-weight: 500;
        }

        .jira-detail input::placeholder,
        .jira-detail textarea::placeholder {
            color: #94a3b8 !important;
            opacity: 1;
        }

        .jira-detail select {
            white-space: nowrap;
            text-overflow: ellipsis;
        }

        .jira-detail select option,
        .jira-controls select option {
            color: #000000;
            background: white;
        }

        .jira-detail textarea {
            min-height: 160px;
            resize: vertical;
        }

        #jiraDetailSummary {
            min-height: 90px;
            line-height: 1.45;
            font-weight: 600;
            color: #000000;
        }

        .jira-detail-title {
            font-size: 1.1rem;
            font-weight: 700;
            color: #000000;
            line-height: 1.5;
        }

        .jira-summary-hint {
            font-size: 0.78rem;
            color: #000000;
            margin-top: 6px;
        }

        .jira-purpose-card {
            border: 1px solid #e2e8f0;
            border-radius: 14px;
            padding: 12px 14px;
            background: #f8fafc;
            box-shadow: inset 0 1px 0 rgba(255, 255, 255, 0.7);
        }

        .jira-purpose-card label {
            font-size: 0.85rem;
            font-weight: 600;
            color: #000000;
            display: block;
            margin-bottom: 6px;
        }

        .jira-purpose-card p {
            margin: 0;
            color: #000000;
            line-height: 1.5;
        }

        .jira-empty-state {
            text-align: center;
            padding: 30px;
            color: #000000;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            animation: slideIn 0.3s ease-out;
        }

        .hidden {
            display: none !important;
        }

        .info-icon {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 18px;
            height: 18px;
            margin-left: 6px;
            border-radius: 50%;
            border: 1px solid #94a3b8;
            color: #475569;
            font-size: 0.75rem;
            cursor: pointer;
            position: relative;
            background: #e2e8f0;
            font-weight: 700;
        }

        .info-icon::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 115%;
            left: 50%;
            transform: translate(-50%, -10px);
            width: 250px;
            background: #0f172a;
            color: #f8fafc;
            padding: 10px 12px;
            border-radius: 8px;
            font-size: 0.75rem;
            line-height: 1.35;
            box-shadow: 0 10px 25px rgba(15, 23, 42, 0.25);
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease, transform 0.2s ease;
            white-space: pre-line;
            z-index: 50;
        }

        .info-icon::before {
            content: '';
            position: absolute;
            top: 105%;
            left: 50%;
            transform: translateX(-50%);
            width: 12px;
            height: 12px;
            background: #0f172a;
            clip-path: polygon(50% 0%, 0% 100%, 100% 100%);
            opacity: 0;
            transition: opacity 0.2s ease;
        }

        .info-icon:hover::after,
        .info-icon:hover::before,
        .info-icon:focus-visible::after,
        .info-icon:focus-visible::before {
            opacity: 1;
            transform: translate(-50%, 0);
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateY(15px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .form-grid {
            display: grid;
            gap: 20px;
            margin-bottom: 25px;
        }

        .profile-card {
            margin-top: 20px;
            padding: 18px 20px;
            border: 1px solid #e2e8f0;
            border-radius: 12px;
            background: #f8fafc;
        }

        .profile-card-title {
            font-size: 1.1rem;
            font-weight: 600;
            color: #1e293b;
            margin-bottom: 14px;
        }

        .profile-card .form-grid {
            margin-bottom: 0;
        }

        .profile-card .button-group {
            margin-top: 16px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
        }

        .form-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group textarea,
        .form-group select {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 100px;
            font-family: inherit;
        }

        .radio-group {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 12px;
            margin-bottom: 15px;
            padding: 15px;
            background: #f8fafc;
            border-radius: 8px;
            border: 2px solid #e5e7eb;
        }

        .radio-option {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .radio-option input[type="checkbox"],
        .radio-option input[type="radio"] {
            width: 18px;
            height: 18px;
            cursor: pointer;
            accent-color: #667eea;
            margin: 0;
            flex-shrink: 0;
        }

        .radio-option label {
            font-weight: 500;
            color: #475569;
            cursor: pointer;
            margin: 0;
            font-size: 0.9rem;
            user-select: none;
        }

        .radio-option:hover label {
            color: #667eea;
        }

        .radio-option input[type="checkbox"]:checked+label,
        .radio-option input[type="radio"]:checked+label {
            color: #667eea;
            font-weight: 600;
        }

        .other-input-group {
            margin-top: 10px;
        }

        .other-input-group label {
            font-weight: 600;
            margin-bottom: 6px;
            color: #374151;
            font-size: 0.9rem;
        }

        .other-input-group input {
            padding: 12px;
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            font-size: 0.95rem;
            transition: all 0.3s ease;
            background: white;
            width: 100%;
        }

        .other-input-group input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .button-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 20px;
        }

        .btn {
            padding: 12px 20px;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            font-weight: 600;
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
            color: white;
        }

        .btn-secondary {
            background: #f1f5f9;
            color: #000000 !important;
            font-weight: 600;
        }

        .btn-secondary:hover {
            background: #e2e8f0;
            color: #000000 !important;
        }

        /* Ensure all buttons in Jira section have good contrast */
        #jira .btn {
            font-weight: 600;
        }

        #jira .btn-primary {
            color: white !important;
        }

        #jira .btn-secondary {
            color: #000000 !important;
        }

        .user-list,
        .project-list {
            background: #f8fafc;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
        }

        .user-item,
        .project-item {
            background: white;
            border-radius: 8px;
            padding: 15px;
            margin: 8px 0;
            border-left: 4px solid #667eea;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.05);
        }

        .user-item h3,
        .project-item h3 {
            color: #1e293b;
            margin-bottom: 8px;
            font-size: 1.1rem;
        }

        .user-item p,
        .project-item p {
            color: #64748b;
            margin: 4px 0;
            font-size: 0.9rem;
        }

        .team-members-section {
            margin-top: 15px;
            padding-top: 12px;
            border-top: 1px solid #e2e8f0;
        }

        .team-member-cards {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 10px;
            margin-top: 8px;
        }

        .team-member-card {
            background: #f8fafc;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            padding: 10px;
            font-size: 0.9rem;
        }

        .team-member-card>div:first-child {
            font-weight: 600;
            margin-bottom: 6px;
            color: #1e293b;
        }

        .prompt-output {
            background: #1e293b;
            color: #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', monospace;
            white-space: pre-wrap;
            max-height: 400px;
            overflow-y: auto;
            font-size: 0.85rem;
            line-height: 1.4;
        }

        .empty-state-message {
            color: #e2e8f0;
            line-height: 1.4;
            font-size: 0.9rem;
            padding: 15px;
        }

        .empty-state-message p {
            margin: 0 0 8px 0;
        }

        .empty-state-message ul {
            margin: 5px 0 0 20px;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 4px 10px;
        }

        .empty-state-message li {
            margin: 0;
            font-size: 0.85rem;
        }

        /* Terminal-like Status Display */
        .terminal-output {
            background: #0f172a;
            color: #94a3b8;
            border-radius: 12px;
            padding: 15px;
            margin: 15px 0;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
            font-size: 0.8rem;
            line-height: 1.6;
            max-height: 400px;
            overflow-y: auto;
            border: 1px solid #1e293b;
            box-shadow: inset 0 2px 8px rgba(0,0,0,0.3);
        }

        .terminal-line {
            margin: 2px 0;
            padding: 2px 0;
            display: flex;
            align-items: flex-start;
            gap: 8px;
        }

        .terminal-timestamp {
            color: #94a3b8;
            font-size: 0.75rem;
            flex-shrink: 0;
            min-width: 50px;
        }

        .terminal-icon {
            flex-shrink: 0;
            font-size: 0.75rem;
            font-weight: bold;
            min-width: 50px;
            font-family: 'Consolas', 'Monaco', 'Courier New', monospace;
        }

        .terminal-message {
            flex: 1;
            word-break: break-word;
        }

        .terminal-line.info .terminal-message {
            color: #60a5fa;
        }

        .terminal-line.success .terminal-message {
            color: #34d399;
        }

        .terminal-line.warning .terminal-message {
            color: #fbbf24;
        }

        .terminal-line.error .terminal-message {
            color: #f87171;
        }

        .terminal-line.processing .terminal-message {
            color: #a78bfa;
        }

        @keyframes blink {
            0%, 50% { opacity: 1; }
            51%, 100% { opacity: 0; }
        }

        .terminal-cursor {
            display: inline-block;
            width: 8px;
            height: 14px;
            background: #60a5fa;
            margin-left: 4px;
            animation: blink 1s infinite;
        }

        /* AI Analysis Visualization Styles */
        #aiAnalysisVisualization {
            margin-top: 20px;
        }

        /* Past Analysis Styles */
        .past-analysis-item {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 12px 15px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .past-analysis-item:hover {
            background: rgba(255, 255, 255, 0.1);
            border-color: rgba(255, 255, 255, 0.2);
            transform: translateX(5px);
        }

        .past-analysis-item.selected {
            background: rgba(102, 126, 234, 0.2);
            border-color: #667eea;
        }

        .past-analysis-date {
            font-size: 0.75rem;
            color: #94a3b8;
            margin-bottom: 4px;
        }

        .past-analysis-preview {
            color: #e2e8f0;
            font-size: 0.85rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* RAG Toggle Switch */
        .rag-toggle {
            position: relative;
            display: inline-block;
            width: 44px;
            height: 24px;
        }

        .rag-toggle input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .rag-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(148, 163, 184, 0.3);
            transition: 0.3s;
            border-radius: 24px;
        }

        .rag-slider:before {
            position: absolute;
            content: "";
            height: 18px;
            width: 18px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.3s;
            border-radius: 50%;
        }

        .rag-toggle input:checked + .rag-slider {
            background-color: #10b981;
        }

        .rag-toggle input:checked + .rag-slider:before {
            transform: translateX(20px);
        }

        .rag-toggle input:disabled + .rag-slider {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Details/Summary Styling */
        details summary::-webkit-details-marker {
            display: none;
        }

        details summary {
            outline: none;
        }

        details[open] summary span:first-child {
            transform: rotate(90deg);
        }

        details summary:hover {
            background: #f8fafc;
            border-radius: 4px;
        }

        /* Analysis Details Styling */
        .analysis-details {
            margin-bottom: 12px;
            border: 1px solid #e2e8f0;
            border-radius: 6px;
            background: #ffffff;
        }

        .analysis-summary {
            cursor: pointer;
            padding: 10px 12px;
            user-select: none;
            list-style: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            color: #1e293b;
            transition: background 0.15s;
        }

        .analysis-summary:hover {
            background: #f8fafc;
        }

        .analysis-details[open] .analysis-summary {
            border-bottom: 1px solid #e2e8f0;
        }

        .summary-arrow {
            transition: transform 0.2s;
            font-size: 0.7rem;
            color: #64748b;
        }

        .analysis-details[open] .summary-arrow {
            transform: rotate(90deg);
        }

        .summary-title {
            flex: 1;
        }

        .summary-badge {
            padding: 3px 8px;
            border-radius: 3px;
            font-size: 0.7rem;
            font-weight: 600;
        }

        .summary-badge.success {
            background: #d1fae5;
            color: #065f46;
        }

        .summary-badge.warning {
            background: #fef3c7;
            color: #92400e;
        }

        .summary-badge.info {
            background: #dbeafe;
            color: #1e40af;
        }

        .analysis-content {
            padding: 12px;
        }

        .member-card-compact {
            padding: 12px;
            background: #f8fafc;
            border-radius: 6px;
            margin-bottom: 10px;
            border: 1px solid #e2e8f0;
        }

        /* RAG Info Icon */
        .info-icon-rag {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: rgba(148, 163, 184, 0.3);
            color: #cbd5e1;
            font-size: 0.7rem;
            font-weight: bold;
            cursor: help;
            position: relative;
        }

        .info-icon-rag:hover::after {
            content: attr(data-tooltip);
            position: absolute;
            top: 120%;
            left: 50%;
            transform: translateX(-50%);
            width: 280px;
            background: #1e293b;
            color: #f1f5f9;
            padding: 12px 14px;
            border-radius: 8px;
            font-size: 0.75rem;
            line-height: 1.5;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
            white-space: pre-line;
            z-index: 1000;
            border: 1px solid rgba(148, 163, 184, 0.2);
            font-weight: normal;
        }

        /* Minimal Button */
        .btn-minimal {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #e2e8f0;
            padding: 4px 10px;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s;
        }

        .btn-minimal:hover {
            background: rgba(255, 255, 255, 0.15);
            border-color: rgba(255, 255, 255, 0.3);
        }

        .btn-minimal:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .analysis-section {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        }

        .analysis-section h3 {
            color: #667eea;
            font-size: 1.2rem;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .analysis-section h3::before {
            content: '';
            width: 4px;
            height: 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 2px;
        }

        .feasibility-badge {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 0.85rem;
            margin-bottom: 10px;
        }

        .feasibility-badge.positive {
            background: #dcfce7;
            color: #166534;
        }

        .feasibility-badge.negative {
            background: #fef2f2;
            color: #991b1b;
        }

        .member-card {
            background: linear-gradient(135deg, #f8fafc 0%, #e2e8f0 100%);
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            padding: 20px;
            margin-bottom: 15px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .member-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.15);
        }

        .member-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            padding-bottom: 10px;
            border-bottom: 2px solid #e2e8f0;
        }

        .member-name {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
        }

        .member-role {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 6px 14px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
        }

        .task-section {
            margin-top: 15px;
        }

        .task-section h4 {
            color: #475569;
            font-size: 1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .task-list {
            list-style: none;
            padding: 0;
        }

        .task-list li {
            background: white;
            padding: 10px 15px;
            margin-bottom: 8px;
            border-radius: 8px;
            border-left: 4px solid #667eea;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .task-list li::before {
            content: 'âœ“';
            color: #667eea;
            font-weight: bold;
            margin-right: 10px;
        }

        .challenge-item,
        .risk-item,
        .recommendation-item {
            background: #fef3c7;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #f59e0b;
        }

        .mitigation-item {
            background: #dbeafe;
            padding: 12px;
            margin-bottom: 10px;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        .deliverable-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 1px solid #bae6fd;
            border-radius: 10px;
            padding: 15px;
            margin-bottom: 12px;
        }

        .deliverable-name {
            font-weight: 700;
            color: #0369a1;
            margin-bottom: 8px;
        }

        .deliverable-meta {
            display: flex;
            gap: 15px;
            font-size: 0.85rem;
            color: #64748b;
            margin-top: 8px;
        }

        .deliverable-meta span {
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .status-message {
            padding: 12px;
            border-radius: 8px;
            margin: 10px 0;
            font-weight: 600;
            font-size: 0.9rem;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
        }

        .status-error {
            background: #fef2f2;
            color: #991b1b;
        }

        .multi-select {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            padding: 8px;
            max-height: 150px;
            overflow-y: auto;
        }

        .multi-select label {
            display: flex;
            align-items: center;
            padding: 6px;
            margin: 2px 0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .multi-select label:hover {
            background: #f1f5f9;
        }

        .multi-select input[type="checkbox"] {
            margin-right: 8px;
        }

        .section-title {
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            margin-bottom: 15px;
            display: flex;
            align-items: center;
        }

        .section-title::before {
            content: '';
            width: 3px;
            height: 24px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            margin-right: 12px;
            border-radius: 2px;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 15px;
            margin: 20px 0;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: white;
        }

        .stat-card h3 {
            font-size: 1.8rem;
            font-weight: 700;
            margin-bottom: 4px;
        }

        .stat-card p {
            opacity: 0.8;
            font-weight: 500;
            font-size: 0.9rem;
        }

        @media (max-width: 768px) {
            .container {
                padding: 10px;
            }

            .header h1 {
                font-size: 2rem;
            }

            .tab-content {
                padding: 20px;
            }

            .jira-setup-grid {
                grid-template-columns: 1fr;
            }
        }

        .timeline-viewer {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin-top: 20px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.1);
            display: none;
        }

        .timeline-viewer.active {
            display: block;
            animation: slideIn 0.3s ease-out;
        }

        .timeline-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 2px solid #e5e7eb;
        }

        .timeline-header h3 {
            color: #1e293b;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .timeline-close-btn {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .timeline-close-btn:hover {
            background: #dc2626;
        }

        .timeline-container {
            position: relative;
            padding: 20px 0;
        }

        .timeline-line {
            position: absolute;
            left: 30px;
            top: 0;
            bottom: 0;
            width: 3px;
            background: linear-gradient(180deg, #667eea, #764ba2);
        }

        .timeline-item {
            position: relative;
            padding-left: 70px;
            margin-bottom: 30px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .timeline-item:hover {
            transform: translateX(5px);
        }

        .timeline-dot {
            position: absolute;
            left: 20px;
            top: 5px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            border: 3px solid white;
            box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            z-index: 2;
        }

        .timeline-dot.major {
            width: 32px;
            height: 32px;
            left: 16px;
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% {
                box-shadow: 0 2px 8px rgba(102, 126, 234, 0.3);
            }
            50% {
                box-shadow: 0 2px 16px rgba(102, 126, 234, 0.6);
            }
        }

        .timeline-content {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            border-left: 3px solid #667eea;
        }

        .timeline-content:hover {
            background: #f1f5f9;
        }

        .timeline-time {
            color: #667eea;
            font-weight: 600;
            font-size: 0.9rem;
            margin-bottom: 5px;
        }

        .timeline-description {
            color: #1e293b;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .timeline-details {
            color: #64748b;
            font-size: 0.85rem;
            margin-bottom: 8px;
        }

        .timeline-stats {
            display: flex;
            gap: 15px;
            margin-top: 10px;
        }

        .timeline-stat {
            display: flex;
            align-items: center;
            gap: 5px;
            font-size: 0.8rem;
            color: #64748b;
        }

        .timeline-stat.added {
            color: #16a34a;
        }

        .timeline-stat.removed {
            color: #dc2626;
        }

        .timeline-change-types {
            margin-top: 10px;
            padding: 10px;
            background: #fff;
            border-radius: 6px;
            border-left: 3px solid #667eea;
        }

        .change-type-item {
            color: #475569;
            font-size: 0.85rem;
            margin: 4px 0;
            line-height: 1.4;
        }

        .change-type-item:first-child {
            margin-top: 0;
        }

        .timeline-badge {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.75rem;
            font-weight: 600;
            margin-left: 8px;
        }

        .timeline-category-badge {
            display: inline-block;
            padding: 3px 10px;
            border-radius: 4px;
            font-size: 0.7rem;
            font-weight: 700;
            color: white;
            text-transform: uppercase;
            letter-spacing: 0.5px;
            margin-right: 8px;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.2);
        }

        .timeline-empty {
            text-align: center;
            padding: 40px;
            color: #64748b;
        }

        .timeline-empty-icon {
            font-size: 3rem;
            margin-bottom: 10px;
            opacity: 0.5;
        }

        /* Loading Behavior for AI Prompt button */
        body.ai-loading,
        body.ai-loading * {
            cursor: wait !important;
        }

        #generate-prompt-btn[disabled] {
            opacity: 0.6;
            pointer-events: none;
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
            width: 100%;

            flex-wrap: wrap;
            gap: 20px; 
            margin-bottom: 20px; 
        }

        .header-top h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 8px;
            text-shadow: 0 2px 10px rgba(0, 0, 0, 0.3);
            min-width: 0;
            text-align: left; 
        }

        .signout-btn {
            padding: 8px 16px;
            font-size: 0.85rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .signout-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        /* CODE DIFF VIEWER STYLES */
        .diff-viewer-modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
            animation: fadeIn 0.2s ease;
        }

        .diff-viewer-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .diff-viewer-content {
            background: white;
            border-radius: 15px;
            width: 90%;
            max-width: 1200px;
            max-height: 85vh;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            display: flex;
            flex-direction: column;
            animation: slideUp 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        .diff-viewer-header {
            padding: 20px 25px;
            border-bottom: 2px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .diff-viewer-header h2 {
            margin: 0;
            color: #1e293b;
            font-size: 1.3rem;
        }

        .diff-viewer-close {
            background: #ef4444;
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 600;
            font-size: 0.9rem;
            transition: all 0.2s;
        }

        .diff-viewer-close:hover {
            background: #dc2626;
            transform: scale(1.05);
        }

        .diff-viewer-body {
            padding: 25px;
            overflow-y: auto;
            flex: 1;
        }

        .diff-info {
            background: #f8fafc;
            border-radius: 8px;
            padding: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #667eea;
        }

        .diff-info p {
            margin: 5px 0;
            color: #475569;
        }

        .diff-info strong {
            color: #1e293b;
        }

        .diff-comparison {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .diff-panel {
            background: #1e293b;
            border-radius: 8px;
            overflow: hidden;
        }

        .diff-panel-header {
            padding: 10px 15px;
            font-weight: 600;
            font-size: 0.9rem;
            color: white;
        }

        .diff-panel-header.before {
            background: #dc2626;
        }

        .diff-panel-header.after {
            background: #16a34a;
        }

        .diff-code {
            padding: 15px;
            font-family: 'Consolas', 'Monaco', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e2e8f0;
            white-space: pre-wrap;
            word-wrap: break-word;
            max-height: 400px;
            overflow-y: auto;
        }

        .diff-empty {
            color: #94a3b8;
            font-style: italic;
            padding: 30px;
            text-align: center;
        }

        .diff-stats {
            display: flex;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: #f1f5f9;
            border-radius: 8px;
        }

        .diff-stat {
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
        }

        .diff-stat.added {
            color: #16a34a;
        }

        .diff-stat.removed {
            color: #dc2626;
        }

        .diff-stat-icon {
            font-size: 1.2rem;
        }

        @media (max-width: 768px) {
            .diff-comparison {
                grid-template-columns: 1fr;
            }
            
            .diff-viewer-content {
                width: 95%;
                max-height: 90vh;
            }
        }

        .profile-dropdown-container {
            position: relative;
            display: inline-block;
        }

        .profile-button {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            font-size: 0.9rem;
            border: 1px solid rgba(255, 255, 255, 0.3);
            background: rgba(255, 255, 255, 0.2);
            color: white;
            border-radius: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            font-weight: 600;
        }

        .profile-button:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: translateY(-1px);
        }

        .profile-button .profile-icon {
            font-size: 1.2rem;
        }

        .profile-dropdown {
            display: none;
            position: absolute;
            top: calc(100% + 8px);
            left: 0;
            min-width: 320px;
            background: white;
            border-radius: 12px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
            z-index: 1000;
            animation: dropdownSlide 0.2s ease-out;
        }

        .profile-dropdown.show {
            display: block;
        }

        @keyframes dropdownSlide {
            from {
                opacity: 0;
                transform: translateY(-10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .profile-dropdown-header {
            padding: 20px;
            border-bottom: 1px solid #e2e8f0;
        }

        .profile-dropdown-header h3 {
            margin: 0 0 8px 0;
            color: #1e293b;
            font-size: 1.1rem;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .profile-dropdown-content {
            padding: 15px 20px;
            max-height: 400px;
            overflow-y: auto;
        }

        .profile-dropdown-item {
            margin-bottom: 12px;
        }

        .profile-dropdown-item label {
            display: block;
            font-weight: 600;
            color: #475569;
            font-size: 0.85rem;
            margin-bottom: 4px;
        }

        .profile-dropdown-item p {
            color: #64748b;
            margin: 0;
            font-size: 0.9rem;
            line-height: 1.5;
        }

        .profile-dropdown-footer {
            padding: 15px 20px;
            border-top: 1px solid #e2e8f0;
        }

        .profile-dropdown-footer .btn {
            width: 100%;
            justify-content: center;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .edit-profile-link {
            display: block;
            text-align: center;
            padding: 10px;
            color: #667eea;
            text-decoration: none;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .edit-profile-link:hover {
            background: #f8fafc;
            color: #764ba2;
        }

        .app-logo {
            height: 120px;
            width: auto;
            margin-right: 0;
            padding: 0;
            vertical-align: middle;
        }

        .projects-layout {
            display: grid;
            grid-template-columns: minmax(0, 1.4fr) minmax(0, 1fr);
            gap: 24px;
            align-items: flex-start;
        }

        @media (max-width: 1000px) {
            .projects-layout {
                grid-template-columns: 1fr;
            }
        }

        #projects .project-list {
            max-height: 55vh;
            overflow-y: auto;
            margin-bottom: 0;

            /* Firefox */
            scrollbar-width: thin;
            scrollbar-color: rgba(148, 163, 184, 0.4) transparent;
        }

        /* Chrome / Edge / VS Code webview (WebKit-based) */
        #projects .project-list::-webkit-scrollbar {
            width: 4px;
        }

        #projects .project-list::-webkit-scrollbar-track {
            background: transparent;
        }

        #projects .project-list::-webkit-scrollbar-thumb {
            background: rgba(148, 163, 184, 0.35);
            border-radius: 999px;
        }

        #projects .project-list::-webkit-scrollbar-thumb:hover {
            background: rgba(148, 163, 184, 0.6);
        }

        /* =========================
        Pallas palette overrides
        (paste at END of <style>)
        ========================= */
        :root{
        --p-bg: #212227;
        --p-surface-1: #484F57;
        --p-surface-2: #637074;
        --p-border: #6F7B87;
        --p-accent: #FFC82F;

        --p-text: #F4F6F8;
        --p-text-muted: rgba(244,246,248,0.72);
        --p-ink: #212227;

        --p-shadow: 0 14px 40px rgba(0,0,0,0.35);
        --p-radius: 14px;
        --p-focus: 0 0 0 3px rgba(255, 200, 47, 0.22);

        color-scheme: dark;
        }

        body{
        background:
            radial-gradient(900px 500px at 18% -10%, rgba(255,200,47,0.10), transparent 60%),
            linear-gradient(135deg, var(--p-bg) 0%, var(--p-surface-1) 100%);
        color: var(--p-text);
        }

        /* Header stays readable */
        .header{ color: var(--p-text); }
        .header h1{ text-shadow: 0 2px 12px rgba(0,0,0,0.55); }

        /* Top-right buttons */
        .profile-button,
        .signout-btn{
        background: rgba(72,79,87,0.45);
        border: 1px solid rgba(111,123,135,0.45);
        color: var(--p-text);
        }
        .profile-button:hover,
        .signout-btn:hover{
        background: rgba(99,112,116,0.45);
        }

        /* Tabs */
        .tab-button{
        background: rgba(72,79,87,0.35);
        border: 1px solid rgba(111,123,135,0.35);
        color: var(--p-text);
        }
        .tab-button:hover{
        background: rgba(99,112,116,0.45);
        transform: translateY(-1px);
        }
        .tab-button.active{
        background: rgba(72,79,87,0.70);
        border-color: rgba(255,200,47,0.55);
        box-shadow: 0 0 0 1px rgba(255,200,47,0.12) inset;
        }

        /* Main content panels */
        .tab-content{
        background: rgba(72,79,87,0.92);
        border: 1px solid rgba(111,123,135,0.30);
        box-shadow: var(--p-shadow);
        color: var(--p-text);
        border-radius: var(--p-radius);
        }

        /* Section titles */
        .section-title{ color: var(--p-text); }
        .section-title::before{ background: var(--p-accent); }

        /* Forms */
        .form-group label,
        .other-input-group label,
        .profile-dropdown-item label{
        color: var(--p-text);
        opacity: 0.92;
        }

        .form-group input,
        .form-group textarea,
        .form-group select,
        .other-input-group input{
        background: rgba(33,34,39,0.55);
        border-color: rgba(111,123,135,0.45);
        color: var(--p-text);
        }
        .form-group input:focus,
        .form-group textarea:focus,
        .form-group select:focus,
        .other-input-group input:focus{
        border-color: rgba(255,200,47,0.70);
        box-shadow: var(--p-focus);
        }
        input::placeholder, textarea::placeholder{
        color: rgba(244,246,248,0.45);
        }

        /* Checkbox/radio accents */
        .radio-option input[type="checkbox"],
        .radio-option input[type="radio"]{
        accent-color: var(--p-accent);
        }
        .radio-group{
        background: rgba(33,34,39,0.25);
        border-color: rgba(111,123,135,0.35);
        }
        .radio-option label{ color: var(--p-text-muted); }
        .radio-option:hover label,
        .radio-option input[type="checkbox"]:checked + label,
        .radio-option input[type="radio"]:checked + label{
        color: var(--p-accent);
        }

        /* Buttons */
        .btn{ border-radius: 10px; }
        .btn-primary{
        background: var(--p-accent);
        color: var(--p-ink);
        box-shadow: 0 6px 16px rgba(0,0,0,0.22);
        }
        .btn-primary:hover{
        transform: translateY(-1px);
        box-shadow: 0 10px 24px rgba(0,0,0,0.28);
        }
        .btn-secondary{
        background: rgba(33,34,39,0.35);
        color: var(--p-text);
        border: 1px solid rgba(111,123,135,0.45);
        }
        .btn-secondary:hover{ background: rgba(99,112,116,0.40); }

        /* Cards / lists */
        .profile-card,
        .user-list, .project-list{
        background: rgba(33,34,39,0.25);
        border: 1px solid rgba(111,123,135,0.25);
        }
        .profile-card-title{ color: var(--p-text); }

        .user-item, .project-item{
        background: rgba(33,34,39,0.36);
        border-left: 4px solid var(--p-accent);
        }
        .user-item h3, .project-item h3{ color: var(--p-text); }
        .user-item p,  .project-item p { color: var(--p-text-muted); }

        /* Placeholder â€œNo projects yetâ€ etc (inline colors) */
        #projectList > p,
        #currentUserDisplay > p{
        color: var(--p-text-muted) !important;
        }

        /* Team cards */
        .team-member-card{
        background: rgba(72,79,87,0.55);
        border-color: rgba(111,123,135,0.30);
        }
        .team-member-card > div:first-child{ color: var(--p-text); }

        /* Prompt output */
        .prompt-output{
        background: rgba(33,34,39,0.70);
        border: 1px solid rgba(111,123,135,0.25);
        color: var(--p-text);
        }

        /* Analysis sections */
        .analysis-section{
        background: rgba(33,34,39,0.35);
        color: var(--p-text);
        border: 1px solid rgba(111,123,135,0.25);
        }
        .analysis-section h3{ color: var(--p-accent); }
        .analysis-section h3::before{ background: var(--p-accent); }

        .member-card{
        background: rgba(72,79,87,0.45);
        border-color: rgba(111,123,135,0.28);
        }
        .member-card:hover{
        transform: translateY(-2px);
        box-shadow: 0 10px 24px rgba(0,0,0,0.30);
        }
        .member-header{ border-bottom-color: rgba(111,123,135,0.28); }
        .member-name{ color: var(--p-text); }
        .member-role{
        background: rgba(255,200,47,0.14);
        border: 1px solid rgba(255,200,47,0.28);
        color: var(--p-accent);
        }

        .task-section h4{ color: var(--p-text); }
        .task-list li{
        background: rgba(33,34,39,0.40);
        border-left-color: var(--p-accent);
        color: var(--p-text);
        }
        .task-list li::before{ color: var(--p-accent); }

        /* Callouts inside analysis */
        .challenge-item,
        .risk-item,
        .recommendation-item{
        background: rgba(255,200,47,0.12);
        border-left-color: var(--p-accent);
        color: var(--p-text);
        }
        .mitigation-item{
        background: rgba(99,112,116,0.25);
        border-left-color: rgba(111,123,135,0.70);
        color: var(--p-text);
        }
        .feasibility-badge.positive{
        background: rgba(255,200,47,0.16);
        color: var(--p-accent);
        border: 1px solid rgba(255,200,47,0.25);
        }
        .feasibility-badge.negative{
        background: rgba(239,68,68,0.18);
        color: #fecaca;
        border: 1px solid rgba(239,68,68,0.25);
        }

        /* Deliverables */
        .deliverable-card{
        background: rgba(33,34,39,0.35);
        border-color: rgba(111,123,135,0.25);
        }
        .deliverable-name{ color: var(--p-text); }
        .deliverable-meta{ color: var(--p-text-muted); }

        /* Status: add missing info style (you use 'info' in JS) */
        .status-info{
        background: rgba(255,200,47,0.14);
        color: var(--p-accent);
        border: 1px solid rgba(255,200,47,0.25);
        }

        /* Dropdown + modal (override inline white backgrounds) */
        .profile-dropdown{
        background: rgba(72,79,87,0.95);
        border: 1px solid rgba(111,123,135,0.30);
        }
        .profile-dropdown-header h3{ color: var(--p-text); }
        .profile-dropdown-item p{ color: var(--p-text-muted); }
        .edit-profile-link{ color: var(--p-accent); }
        .edit-profile-link:hover{ background: rgba(33,34,39,0.35); color: var(--p-accent); }

        .modal-content{
        background: rgba(72,79,87,0.96) !important;
        color: var(--p-text);
        border: 1px solid rgba(111,123,135,0.30);
        box-shadow: var(--p-shadow);
        }
        #closeEditModal{ color: var(--p-text-muted) !important; }

        /* Fix inline title color inside AI visualization header */
        #aiAnalysisVisualization h2{ color: var(--p-text) !important; }
        #aiAnalysisVisualization > div > p{ color: var(--p-text-muted) !important; }

        /* Info tooltip icon */
        .info-icon{
        background: rgba(33,34,39,0.35);
        border-color: rgba(111,123,135,0.55);
        color: var(--p-text);
        }
        .info-icon::after,
        .info-icon::before{ background: rgba(33,34,39,0.92); }

        /* Scrollbars */
        #projects .project-list{
        scrollbar-color: rgba(111,123,135,0.45) transparent;
        }
        #projects .project-list::-webkit-scrollbar-thumb{
        background: rgba(111,123,135,0.35);
        }
        #projects .project-list::-webkit-scrollbar-thumb:hover{
        background: rgba(111,123,135,0.60);
        }

        /* Override inline-colored action buttons inside project HTML */
        .edit-project-btn{
        background: var(--p-accent) !important;
        color: var(--p-ink) !important;
        }
        .leave-project-btn{
        background: rgba(33,34,39,0.35) !important;
        color: var(--p-text) !important;
        border: 1px solid rgba(111,123,135,0.45) !important;
        }
        .project-item code{
        background: rgba(33,34,39,0.55) !important;
        color: var(--p-text) !important;
        border: 1px solid rgba(111,123,135,0.25);
        }

    </style>
</head>

<body>
    <div class="container">
        <div class="header">
            <div class="header-top">
                <div class="profile-dropdown-container">
                    <button id="profileBtn" class="profile-button">
                        <span class="profile-icon">ðŸ‘¤</span>
                        <span id="profileBtnName">Profile</span>
                    </button>
                    <div id="profileDropdown" class="profile-dropdown">
                        <div class="profile-dropdown-header">
                            <h3><span>ðŸ‘¤</span> <span id="dropdownUserName">User</span></h3>
                        </div>
                        <div class="profile-dropdown-content">
                            <div class="profile-dropdown-item">
                                <label>Skills</label>
                                <p id="dropdownSkills">Not specified</p>
                            </div>
                            <div class="profile-dropdown-item">
                                <label>Programming Languages</label>
                                <p id="dropdownLanguages">Not specified</p>
                            </div>
                            <div class="profile-dropdown-item">
                                <label>Willing to Work On</label>
                                <p id="dropdownWilling">Not specified</p>
                            </div>
                        </div>
                        <a class="edit-profile-link" id="editProfileLink">âœï¸ Edit Profile</a>
                        <div class="profile-dropdown-footer">
                            <button id="signOutBtn" class="btn btn-secondary">
                                <span>ðŸšª</span>
                                <span>Sign Out</span>
                            </button>
                        </div>
                    </div>
                </div>


                <h1><img src="{{logoUri}}" alt="AI Collab Agent logo" class="app-logo">Pallas AI</h1>
                <div style="width: 140px;"></div> <!-- Spacer -->
            </div>
            <p>VSCode Collaboration Agent</p>

        </div>

        <div class="tabs">
            <button class="tab-button" data-tab="projects">ðŸ“‹ Projects</button>
            <button class="tab-button" data-tab="prompts">ðŸ¤– Workspace</button>
            <button class="tab-button" data-tab="jira">ðŸ—‚ï¸ Jira Tasks</button>
            <button class="tab-button" data-tab="timeline">ðŸ“… Timeline</button>
        </div>

        <div id="users" class="tab-content">
            <div class="section-title">My Profile</div>

            <form class="form-grid" id="profile-form">
                <div class="form-group">
                    <label for="userName">Full Name</label>
                    <input type="text" id="userName" placeholder="Enter your name">
                </div>

                <div class="form-group">
                    <label for="userSkills">Skills</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="checkbox" id="skill-ml" name="skills" value="Machine Learning">
                            <label for="skill-ml">Machine Learning</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-db" name="skills" value="Databases">
                            <label for="skill-db">Databases</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-cloud" name="skills" value="Cloud Computing">
                            <label for="skill-cloud">Cloud Computing</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-frontend" name="skills" value="Frontend Development">
                            <label for="skill-frontend">Frontend Development</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-backend" name="skills" value="Backend Development">
                            <label for="skill-backend">Backend Development</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-devops" name="skills" value="DevOps">
                            <label for="skill-devops">DevOps</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-security" name="skills" value="Security">
                            <label for="skill-security">Security</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-mobile" name="skills" value="Mobile Development">
                            <label for="skill-mobile">Mobile Development</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-testing" name="skills" value="Testing">
                            <label for="skill-testing">Testing</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-uiux" name="skills" value="UI/UX Design">
                            <label for="skill-uiux">UI/UX Design</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-data" name="skills" value="Data Science">
                            <label for="skill-data">Data Science</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="skill-architecture" name="skills" value="Software Architecture">
                            <label for="skill-architecture">Software Architecture</label>
                        </div>
                    </div>
                    <div class="other-input-group">
                        <label for="userSkillsOther">Other Skills (comma-separated)</label>
                        <input type="text" id="userSkillsOther" placeholder="e.g., Leadership, Design, Analysis">
                    </div>
                </div>

                <div class="form-group">
                    <label for="userLanguages">Programming Languages</label>
                    <div class="radio-group">
                        <div class="radio-option">
                            <input type="checkbox" id="lang-python" name="languages" value="Python">
                            <label for="lang-python">Python</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-java" name="languages" value="Java">
                            <label for="lang-java">Java</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-javascript" name="languages" value="JavaScript">
                            <label for="lang-javascript">JavaScript</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-typescript" name="languages" value="TypeScript">
                            <label for="lang-typescript">TypeScript</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-cpp" name="languages" value="C++">
                            <label for="lang-cpp">C++</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-csharp" name="languages" value="C#">
                            <label for="lang-csharp">C#</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-go" name="languages" value="Go">
                            <label for="lang-go">Go</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-rust" name="languages" value="Rust">
                            <label for="lang-rust">Rust</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-php" name="languages" value="PHP">
                            <label for="lang-php">PHP</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-ruby" name="languages" value="Ruby">
                            <label for="lang-ruby">Ruby</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-swift" name="languages" value="Swift">
                            <label for="lang-swift">Swift</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-kotlin" name="languages" value="Kotlin">
                            <label for="lang-kotlin">Kotlin</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-sql" name="languages" value="SQL">
                            <label for="lang-sql">SQL</label>
                        </div>
                        <div class="radio-option">
                            <input type="checkbox" id="lang-html" name="languages" value="HTML/CSS">
                            <label for="lang-html">HTML/CSS</label>
                        </div>
                    </div>
                    <div class="other-input-group">
                        <label for="userLanguagesOther">Other Languages (comma-separated)</label>
                        <input type="text" id="userLanguagesOther" placeholder="e.g., R, Scala, Dart">
                    </div>
                </div>

                <div class="form-group">
                    <label for="userWilling">Willing to Work On</label>
                    <textarea id="userWilling"
                        placeholder="Describe your interests and preferred project types..."></textarea>
                </div>
            </form>
            <div class="button-group">
                <button id="update-profile-btn" class="btn btn-primary">Update Profile</button>
                <button id="clear-profile-form-btn" class="btn btn-secondary">Reset Form</button>
            </div>

            <div id="userStatus" class="status-message" style="display: none;"></div>

        </div>

        <div id="projects" class="tab-content">
            <div class="projects-layout">
                <!-- Left Column -->
                <div>
                    <div class="section-title">Create Project</div>

                    <form class="form-grid">

                        <div class="form-group">
                            <label for="projectName">Project Name *</label>
                            <input type="text" id="projectName" required placeholder="Enter project name">
                        </div>

                        <div class="form-group">
                            <label for="projectDescription">Description *</label>
                            <textarea id="projectDescription" required placeholder="Describe the project..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="projectGoals">Goals</label>
                            <textarea id="projectGoals" placeholder="List main objectives..."></textarea>
                        </div>

                        <div class="form-group">
                            <label for="projectRequirements">Requirements</label>
                            <textarea id="projectRequirements"
                                placeholder="Technical requirements and constraints..."></textarea>
                        </div>
                    </form>

                    <div class="button-group">
                        <button id="create-project-btn" class="btn btn-primary">Create Project</button>
                        <button id="clear-project-form-btn" class="btn btn-secondary">Clear Form</button>
                    </div>

                    <div id="projectStatus" class="status-message" style="display: none;"></div>

                </div>

                <!-- Right Column -->
                <div>
                    <div class="section-title">Join Project</div>

                    <div class="form-group">
                        <label for="inviteCode">Invite Code</label>
                        <input type="text" id="inviteCode" placeholder="Enter 6-character invite code" maxlength="6"
                            style="text-transform: uppercase;">
                    </div>

                    <div class="button-group">
                        <button id="join-project-btn" class="btn btn-primary">Join Project</button>
                    </div>

                    <div id="joinStatus" class="status-message" style="display: none;"></div>

                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin: 25px 0 15px;">
                        <div class="section-title" style="margin-bottom: 0;">Projects</div>
                        <button id="refresh-projects-btn" class="btn btn-secondary"
                            style="padding: 8px 16px; font-size: 0.85rem;" title="Refresh projects from database">ðŸ”„
                            Refresh</button>
                    </div>

                    <div id="projectList" class="project-list">
                        <p style="text-align: center; color: #64748b; padding: 15px;">No projects yet</p>
                    </div>
                    <div id="projectRefreshStatus" class="status-message" style="display: none;"></div>
                </div>
            </div>

        </div>

        <!-- Edit Project Modal -->
        <div id="editProjectModal" class="modal" style="display: none;">
            <div class="modal-content"
                style="max-width: 600px; margin: 50px auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 10px 40px rgba(0,0,0,0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                    <h2 style="margin: 0;">Edit Project</h2>
                    <button id="closeEditModal"
                        style="background: none; border: none; font-size: 24px; cursor: pointer; color: #64748b;">&times;</button>
                </div>

                <form id="editProjectForm">
                    <input type="hidden" id="editProjectId">

                    <div class="form-group">
                        <label for="editProjectName">Project Name *</label>
                        <input type="text" id="editProjectName" required placeholder="Enter project name">
                    </div>

                    <div class="form-group">
                        <label for="editProjectDescription">Description *</label>
                        <textarea id="editProjectDescription" required placeholder="Describe the project..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editProjectGoals">Goals</label>
                        <textarea id="editProjectGoals" placeholder="List main objectives..."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="editProjectRequirements">Requirements</label>
                        <textarea id="editProjectRequirements"
                            placeholder="Technical requirements and constraints..."></textarea>
                    </div>

                    <div class="form-group" id="memberManagementSection" style="display: none;">
                        <label>Team Members (Owner can remove members)</label>
                        <div id="editProjectMembers" style="margin-top: 10px;">
                            <!-- Members will be populated here -->
                        </div>
                    </div>
                </form>

                <div class="button-group" style="margin-top: 20px;">
                    <button id="saveProjectBtn" class="btn btn-primary">Save Changes</button>
                    <button id="cancelEditBtn" class="btn btn-secondary">Cancel</button>
                </div>
            </div>
        </div>

        <div id="prompts" class="tab-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <div class="section-title" style="margin: 0; color: #000000;">AI Analysis Generator</div>
                <button id="start-project" class="btn btn-primary" style="padding: 8px 20px; font-size: 0.9rem;">Start Project</button>
            </div>

            <!-- Compact Card Layout -->
            <div style="background: #ffffff; border: 1px solid #e2e8f0; border-radius: 8px; padding: 16px; margin-bottom: 15px;">
                <!-- Project & Mode (2-column grid) -->
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 12px; margin-bottom: 12px;">
                    <div class="form-group" style="margin: 0;">
                        <label for="promptProject" style="font-size: 0.85rem; margin-bottom: 4px; color: #000000; font-weight: 600;">Project</label>
                        <select id="promptProject" style="font-size: 0.9rem; padding: 8px 10px; color: #000000; background: #ffffff; border: 1px solid #cbd5e1;">
                            <option value="">Choose project...</option>
                </select>
            </div>

                    <div class="form-group" style="margin: 0;">
                        <label for="analysis-mode" style="font-size: 0.85rem; margin-bottom: 4px; color: #000000; font-weight: 600;">Analysis Mode</label>
                        <select id="analysis-mode" style="font-size: 0.9rem; padding: 8px 10px; color: #000000; background: #ffffff; border: 1px solid #cbd5e1;">
                            <option value="initial">Initial Planning</option>
                            <option value="progress">Progress Update</option>
                </select>
                </div>
            </div>

                <!-- Workspace Link (compact, inline) -->
                <div id="workspace-link-info" style="display: none; padding: 6px 10px; background: #f0f9ff; border-left: 2px solid #3b82f6; border-radius: 4px; margin-bottom: 12px;">
                    <div style="display: flex; align-items: center; justify-content: space-between; font-size: 0.75rem;">
                        <div id="workspace-link-text" style="color: #1e40af; flex: 1;"></div>
                        <button id="unlink-workspace-btn" class="btn-minimal" style="font-size: 0.7rem; padding: 2px 8px; color: #dc2626;">Unlink</button>
                </div>
            </div>

                <div id="link-workspace-container" style="display: none; margin-bottom: 12px;">
                    <button id="link-workspace-btn" class="btn-minimal" style="font-size: 0.8rem; padding: 4px 10px; color: #3b82f6;">Link Workspace</button>
            </div>

                <!-- Collapsible Mode Details -->
                <details id="mode-details" style="margin-bottom: 12px;" open>
                    <summary style="cursor: pointer; font-size: 0.85rem; color: #000000; font-weight: 700; padding: 6px 0; user-select: none; list-style: none; display: flex; align-items: center; gap: 6px;">
                        <span style="transition: transform 0.2s;">â–¶</span>
                        <span id="mode-summary-text">Mode Details</span>
                    </summary>
                    <div id="mode-description" style="margin-top: 8px; padding: 10px; background: #f8fafc; border-radius: 4px; font-size: 0.85rem;">
                        <div style="color: #1e293b; line-height: 1.5; font-weight: 500;" id="mode-desc-text"></div>
                        <div id="mode-rag-requirement" style="display: none; color: #059669; font-size: 0.8rem; margin-top: 6px; font-weight: 700; padding: 6px; background: #f0fdf4; border-radius: 3px;">
                            âœ“ Uses Smart Context
                </div>
                    </div>
                </details>

                <!-- Collapsible Smart Context -->
                <details id="rag-details" style="margin-bottom: 12px;">
                    <summary style="cursor: pointer; font-size: 0.85rem; color: #000000; font-weight: 700; padding: 6px 0; user-select: none; list-style: none; display: flex; align-items: center; gap: 6px;">
                        <span style="transition: transform 0.2s;">â–¶</span>
                        Smart Context
                        <span id="rag-status-badge" style="font-size: 0.75rem; color: #64748b; font-weight: 600; margin-left: 4px;">(Not indexed)</span>
                    </summary>
                    <div id="rag-control" style="padding: 10px; background: #f8fafc; border-radius: 4px; margin-top: 8px;">
                        <div style="display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 8px;">
                            <div style="font-size: 0.8rem; color: #1e293b; font-weight: 500; flex: 1;">
                                Scans code once, sends only relevant snippets. Saves 60-80% tokens.
                            </div>
                            <div style="display: flex; align-items: center; gap: 10px;">
                    <label class="rag-toggle">
                        <input type="checkbox" id="rag-toggle-switch" disabled>
                        <span class="rag-slider"></span>
                    </label>
                                <button id="index-workspace-btn" class="btn-minimal" style="display: none; padding: 4px 10px; font-size: 0.8rem;">Index</button>
                </div>
            </div>
                    </div>
                </details>

                <!-- Generate Button (prominent) -->
                <button id="generate-prompt-btn" class="btn btn-primary" style="width: 100%; padding: 10px; font-size: 0.9rem; font-weight: 600;">
                    Generate AI Analysis
                </button>
            </div>

            <div id="promptStatus" class="status-message" style="display: none;"></div>

            <!-- Terminal output -->
            <div id="promptOutput" class="prompt-output" style="display: none;"></div>

            <!-- Results Section -->
            <div id="results-section" style="display: none;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 30px; margin-bottom: 15px;">
                    <div class="section-title" style="margin: 0;">Latest Analysis</div>
                    <button id="clear-analysis-btn" class="btn-minimal" style="font-size: 0.85rem; padding: 6px 12px; color: #ef4444;" title="Clear and move to past analyses">
                        Ã— Clear
                    </button>
            </div>

                <!-- Analysis results visualization -->
                <div id="aiAnalysisVisualization"></div>
                </div>

            <!-- Past AI Analyses Section (minimal) -->
            <div style="margin-top: 40px; padding-top: 20px; border-top: 1px solid #e2e8f0;">
                <div style="font-size: 1.1rem; font-weight: 700; color: #ffffff; margin-bottom: 8px;">Past Analyses</div>
                <p style="color: #ffffff; font-size: 0.9rem; margin-bottom: 15px; font-weight: 500;">Previous task delegations for this project</p>

                <div id="pastAnalysisList" style="display: none; margin-top: 12px;">
                    <div id="pastAnalysisItems" style="max-height: 250px; overflow-y: auto; background: #f8fafc; border-radius: 6px; padding: 8px; border: 1px solid #e2e8f0;">
                        <!-- Will be populated dynamically -->
                    </div>
                </div>

                <div id="pastAnalysisView" style="display: none; margin-top: 15px;">
                    <!-- Selected analysis will be displayed here -->
                </div>
            </div>
        </div>

        <div id="jira" class="tab-content">
            <div class="jira-header">
                <div class="section-title">Jira Tasks</div>
            </div>

            <div class="jira-setup-grid">
                <div id="jiraCredentialsCard" class="jira-credentials-card">
                    <div class="jira-credentials-header">
                        <div class="profile-card-title">Jira Credentials</div>
                        <button type="button" id="toggle-jira-credentials-btn" class="btn btn-secondary" aria-expanded="true">Hide Jira setup</button>
                    </div>
                    <div id="jiraCredentialsBody" class="jira-credentials-body">
                        <div class="form-grid">
                            <div class="form-group">
                                <label for="jiraBaseUrl">
                                    Jira Cloud base URL (e.g. https://your-team.atlassian.net)
                                    <span class="info-icon" tabindex="0" role="button" aria-label="How to find your Jira Cloud base URL" data-tooltip="1. Sign in to Jira Cloud in your browser.&#10;2. Copy the site URL up to atlassian.net (e.g., https://team.atlassian.net).&#10;3. Remove everything after the domain before pasting here.">?</span>
                                </label>
                                <input type="text" id="jiraBaseUrl" placeholder="https://your-team.atlassian.net">
                            </div>
                            <div class="form-group">
                                <label for="jiraProjectKey">
                                    Jira Project Key (e.g. STAR, TUFF, ENG)
                                    <span class="info-icon" tabindex="0" role="button" aria-label="How to find your Jira Project Key" data-tooltip="1. In Jira, open Project settings &gt; Details.&#10;2. Find the Project key (2-10 uppercase letters shown under the project name).&#10;3. Paste that exact key hereâ€”do not use the project name.">?</span>
                                </label>
                                <input type="text" id="jiraProjectKey" placeholder="TEAM">
                            </div>
                            <div class="form-group">
                                <label for="jiraEmail">
                                    Jira account email (the one tied to the API token)
                                    <span class="info-icon" tabindex="0" role="button" aria-label="Which email to use for Jira" data-tooltip="1. Use the Atlassian account email tied to your API token.&#10;2. Confirm it from https://id.atlassian.com/manage-profile.&#10;3. This email must have access to the Jira site you entered.">?</span>
                                </label>
                                <input type="email" id="jiraEmail" placeholder="you@company.com">
                            </div>
                            <div class="form-group">
                                <label for="jiraApiToken">
                                    Jira API Token
                                    <span class="info-icon" tabindex="0" role="button" aria-label="How to generate a Jira API token" data-tooltip="1. Go to https://id.atlassian.com/manage-profile/security/api-tokens (while logged in).&#10;2. Click Create API token, give it a label, then Create.&#10;3. Copy the token once and paste it hereâ€”store it securely because it cannot be shown again.">?</span>
                                </label>
                                <input type="password" id="jiraApiToken" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                            </div>
                            <div class="form-group" style="grid-column: 1 / -1;">
                                <div class="label-with-action">
                                    <label for="jiraProjectPrompt">
                                        Project prompt (Describe your project to generate a Jira backlog)
                                        <span class="info-icon" tabindex="0" role="button" aria-label="What to include in the Jira project prompt" data-tooltip="Describe what Jira should build for you.&#10;Include the product vision, target users, tech stack, constraints, and any priority backlog items or milestones.">?</span>
                                    </label>
                                    <button type="button" id="jira-use-ai-prompt-btn" class="btn btn-secondary" title="Use the latest AI Analysis & Task Delegation output to populate your Jira backlog prompt">Use AI analysis output</button>
                                </div>
                                <textarea id="jiraProjectPrompt" placeholder="e.g., Build a fitness app that tracks workouts and suggests plansâ€¦" rows="4"></textarea>
                            </div>
                        </div>
                        <div class="button-group" style="justify-content: flex-end;">
                            <button type="button" id="jira-profile-create-btn" class="btn btn-primary">Create Jira Tasks</button>
                        </div>
                        <div id="jiraStatus" class="status-message" style="display: none;"></div>
                    </div>
                </div>
            </div>

            <div class="jira-credentials-card jira-collapsible-card" id="jiraAssignableCard">
                <div class="collapsible-header">
                    <div>
                        <div class="profile-card-title">Jira Users from linked Jira Board</div>
                        <p style="margin: 4px 0 0; color: #475569;">Pulled directly from Jira. Use the buttons below to refresh the roster.</p>
                    </div>
                    <button type="button" id="toggleAssignableCardBtn" class="btn btn-secondary" aria-expanded="true">Hide</button>
                </div>
                <div id="jiraAssignableBody" class="collapsible-body">
                    <div class="button-group" style="justify-content: flex-end;">
                        <button type="button" id="jiraRefreshAssignableBtn" class="btn btn-primary">Reload Assignable Users</button>
                        <button type="button" id="jiraSaveAssignableBtn" class="btn btn-secondary">Refresh from Jira</button>
                        <button type="button" id="jiraClearAssignableBtn" class="btn btn-secondary">Clear</button>
                    </div>
                    <div id="jiraAssignableList" class="project-list" style="margin-top: 12px; min-height: 40px;">
                        <p style="text-align: center; color: #64748b; padding: 10px;">Assignable users will appear here after you reload from Jira.</p>
                    </div>
                </div>
            </div>

            <div class="section-title">Task Board</div>
            <div id="jiraTaskStatus" class="status-message" style="display: none;"></div>
            <p id="jiraCredentialsWarning" class="status-message status-error" style="display: none;">Add your Jira workspace credentials above to view and manage tasks.</p>
            <div id="jiraBoard" class="jira-layout hidden">
                <div class="jira-column">
                    <div class="jira-controls">
                        <select id="jiraFilterStatus">
                            <option value="">All Statuses</option>
                        </select>
                        <input type="text" id="jiraSearchInput" placeholder="Search tasks...">
                        <button id="jiraRefreshBtn" class="btn btn-secondary" type="button">Refresh</button>
                        <button id="jiraNewTaskBtn" class="btn btn-primary" type="button">+ New Task</button>
                    </div>
                    <div id="jiraTaskList" class="jira-task-list">
                        <div class="jira-empty-state">
                            <p>No Jira tasks loaded yet.</p>
                        </div>
                    </div>
                </div>
                <div class="jira-column">
                    <div class="jira-detail" id="jiraTaskDetail">
                        <p class="jira-empty-state">Select a task to view and edit details.</p>
                    </div>
                </div>
            </div>
        </div>

        <div id="timeline" class="tab-content">
            <div class="section-title">Project Files Browser</div>
            
            <div class="form-group">
                <label for="timelineSearch">
                    ðŸ” Search Files
                    <span style="color: #64748b; font-weight: normal; font-size: 0.85rem;">
                        (by name or path)
                    </span>
                </label>
                <input 
                    type="text" 
                    id="timelineSearch" 
                    placeholder="Type to search files..."
                >
            </div>
            
            <div class="form-group" style="margin-top: 20px;">
                <label for="timelineFilter">
                    ðŸ“‚ Filter by File Type
                </label>
                <select id="timelineFilter">
                    <option value="">All File Types</option>
                    <option value="js">JavaScript</option>
                    <option value="ts">TypeScript</option>
                    <option value="py">Python</option>
                    <option value="html">HTML</option>
                    <option value="css">CSS</option>
                    <option value="json">JSON</option>
                    <option value="md">Markdown</option>
                </select>
            </div>
            
            <div class="button-group" style="margin-top: 15px;">
                <button id="refresh-files-btn" class="btn btn-primary">
                    ðŸ”„ Refresh Files
                </button>
                <button id="clear-timeline-search-btn" class="btn btn-secondary">
                    Clear Filters
                </button>
            </div>
            
            <div id="timelineStatus" class="status-message" style="display: none;"></div>
            
            <div class="section-title" style="margin-top: 30px;">
                Files in Workspace
                <span id="fileCount" style="margin-left: 10px; font-size: 0.8rem; color: #667eea; font-weight: normal;">
                    (0 files)
                </span>
            </div>
            <div id="timelineList" class="project-list">
                <p style="text-align: center; color: #64748b; padding: 15px;">
                    Loading files from workspace...
                </p>
            </div>
            <!-- This goes in your Timeline tab, after the timelineList div -->
            <div id="timelineViewer" class="timeline-viewer">
                <div class="timeline-header">
                    <h3>
                        <span id="timelineFileName">ðŸ“„ File.js</span>
                        <span class="timeline-badge" id="timelinePointCount">5 points</span>
                    </h3>
                    <button class="timeline-close-btn" id="closeTimelineBtn">âœ• Close</button>
                </div>
                
                <div class="timeline-container" id="timelinePoints">
                    <!-- Timeline points will be inserted here -->
                </div>
            </div>
        </div>
    </div>

    <!-- CODE DIFF VIEWER MODAL -->
    <div id="diffViewerModal" class="diff-viewer-modal">
        <div class="diff-viewer-content">
            <div class="diff-viewer-header">
                <h2 id="diffViewerTitle">ðŸ“ Code Changes</h2>
                <button class="diff-viewer-close" id="closeDiffViewer">âœ• Close</button>
            </div>
            <div class="diff-viewer-body" id="diffViewerBody">
                <!-- Content populated by JavaScript -->
            </div>
        </div>
    </div>

    <script>
        // VS Code API
        const vscode = acquireVsCodeApi();

        // TypeScript-like classes
        class TeamMember {
            constructor(name, skills, programmingLanguages, willingToWorkOn) {
                this.name = name;
                this.skills = skills;
                this.programmingLanguages = programmingLanguages;
                this.willingToWorkOn = willingToWorkOn;
                this.id = Date.now() + Math.random();
                this.createdAt = new Date().toISOString();
            }
        }

        class Project {
            // Constructor now takes selectedMemberIds and invite_code
            constructor(name, description, goals, requirements, selectedMemberIds = [], invite_code = '') {
                this.name = name;
                this.description = description;
                this.goals = goals;
                this.requirements = requirements;
                this.selectedMemberIds = selectedMemberIds; // Store IDs
                this.invite_code = invite_code; // Store invite code
                this.id = Date.now() + Math.random();
                this.createdAt = new Date().toISOString();
            }
        }

        class TeamCollaborationApp {
            constructor() {
                this.currentUser = null;
                this.users = [];
                this.projects = [];
                this.promptCount = 0;
                this.workspaceFiles = [];
                this.filteredFiles = [];
                this.aiAnalysisByProject = {};
                this.latestAiProjectId = null;
                this.jiraTasks = []; // Tasks pulled from Jira search endpoint
                this.jiraStatuses = []; // Status options fetched per project for filtering
                this.jiraSelectedTask = null; // Currently highlighted task in detail pane
                this.jiraLoading = false; // Prevents duplicate loads while waiting on Jira
                this.jiraTransitions = {}; // Cached transitions per issue id for status dropdown
                this.jiraFilters = { status: '', search: '' }; // Local filters applied to Jira list
                this.jiraActiveRequestId = 0; // Tracks in-flight Jira load to discard stale responses
                this.isCreatingJiraTask = false; // Toggle for new-task form vs editing existing
                this.jiraUnlocked = window.localStorage.getItem('jiraUnlocked') === 'true'; // Remembers if Jira tab has been shown already
                this.jiraAssignableEmails = []; // Roster fetched from Jira

                // Request data from VS Code extension
                vscode.postMessage({ type: 'loadData' });
                vscode.postMessage({ type: 'getWorkspaceFiles' });  // â† Is this line there?
            }

            // === TIMELINE FEATURE METHODS - ADD THESE ===
            
            loadWorkspaceFiles(files) {
                this.workspaceFiles = files || [];
                this.filteredFiles = [...this.workspaceFiles];
                this.updateTimelineList();
                this.updateFileCount();
            }

            searchFiles(query) {
                const searchTerm = query.toLowerCase();
                this.filteredFiles = this.workspaceFiles.filter(file => 
                    file.path.toLowerCase().includes(searchTerm) ||
                    file.name.toLowerCase().includes(searchTerm)
                );
                this.updateTimelineList();
                this.updateFileCount();
            }

            filterFilesByType(fileType) {
                if (!fileType) {
                    this.filteredFiles = [...this.workspaceFiles];
                } else {
                    this.filteredFiles = this.workspaceFiles.filter(file => 
                        file.type === fileType
                    );
                }
                this.updateTimelineList();
                this.updateFileCount();
            }

            updateTimelineList() {
                const timelineList = document.getElementById('timelineList');
                
                if (!this.filteredFiles || this.filteredFiles.length === 0) {
                    timelineList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 15px;">No files found</p>';
                    return;
                }

                let html = '';
                this.filteredFiles.forEach(file => {
                    const icon = this.getFileIcon(file.type);
                    const sizeKB = (file.size / 1024).toFixed(1);
                    
                    html += `
                        <div class="project-item file-item-clickable" 
                             data-file-path="${file.path}" 
                             data-file-name="${file.name}"
                             style="cursor: pointer; transition: all 0.2s;">
                            <h3>${icon} ${file.name}</h3>
                            <p><strong>Path:</strong> ${file.path}</p>
                            <p><strong>Type:</strong> ${file.type.toUpperCase()} | <strong>Size:</strong> ${sizeKB} KB</p>
                        </div>
                    `;
                });

                timelineList.innerHTML = html;

                // Attach click listeners to all file items
                document.querySelectorAll('.file-item-clickable').forEach(item => {
                    item.addEventListener('click', function() {
                        const filePath = this.getAttribute('data-file-path');
                        const fileName = this.getAttribute('data-file-name');
                        window.openFileTimeline(filePath, fileName);
                    });
                });
            }

            getFileIcon(type) {
                const icons = {
                    'js': 'ðŸ“œ', 'ts': 'ðŸ“˜', 'jsx': 'âš›ï¸', 'tsx': 'âš›ï¸',
                    'py': 'ðŸ', 'java': 'â˜•', 'cpp': 'âš™ï¸', 'c': 'âš™ï¸',
                    'html': 'ðŸŒ', 'css': 'ðŸŽ¨', 'json': 'ðŸ“‹', 'md': 'ðŸ“',
                    'txt': 'ðŸ“„', 'xml': 'ðŸ“°', 'sql': 'ðŸ—„ï¸', 'sh': 'âš¡'
                };
                return icons[type] || 'ðŸ“„';
            }

            updateFileCount() {
                const fileCount = document.getElementById('fileCount');
                if (fileCount) {
                    fileCount.textContent = `(${this.filteredFiles.length} files)`;
                }
            }

            // === END TIMELINE METHODS ===

            // Updated to handle currentUser separately
            loadData(data) {
                try {
                    // Remember if modal was open before reloading
                    const modal = document.getElementById('editProjectModal');
                    const wasModalOpen = modal && modal.style.display === 'block';
                    const openProjectId = wasModalOpen ? document.getElementById('editProjectId')?.value : null;
                    
                    // Close any open modals to prevent stale references
                    // But we'll reopen it after data reload if it was open
                    this.closeEditModal();
                    
                    // Load current user's profile
                    if (data.currentUser) {
                        this.currentUser = {
                            id: data.currentUser.id,
                            name: data.currentUser.name,
                            skills: data.currentUser.skills || '',
                            programmingLanguages: data.currentUser.programming_languages || '',
                            willingToWorkOn: data.currentUser.willing_to_work_on || '',
                            jiraBaseUrl: data.currentUser.jira_base_url || '',
                            jiraProjectKey: data.currentUser.jira_project_key || '',
                            jiraEmail: data.currentUser.jira_email || '',
                            jiraApiToken: data.currentUser.jira_api_token || '',
                            jiraProjectPrompt: data.currentUser.jira_project_prompt || '',
                            createdAt: data.currentUser.created_at
                        };
                        this.loadCurrentUserProfile();
                    }

                    if (data.users) {
                        this.users = data.users.map(userData => {
                            const user = new TeamMember(userData.name, userData.skills, userData.programming_languages, userData.willing_to_work_on);
                            user.id = userData.id;
                            user.createdAt = userData.created_at;
                            return user;
                        });
                    }

                    if (data.projects) {
                        // Get valid user IDs to filter out any invalid member references
                        const validUserIds = new Set(this.users.map(u => String(u.id)));
                        
                        this.projects = data.projects.map(projectData => {
                            // Ensure selectedMemberIds is an array
                            let memberIds = Array.isArray(projectData.selectedMemberIds) ? projectData.selectedMemberIds : [];
                            // Filter out any member IDs that don't exist in users array (defensive programming)
                            memberIds = memberIds.filter(id => validUserIds.has(String(id)));
                            
                            const project = new Project(
                                projectData.name,
                                projectData.description,
                                projectData.goals,
                                projectData.requirements,
                                memberIds,
                                projectData.invite_code || ''
                            );
                            project.id = projectData.id;
                            project.createdAt = projectData.created_at;
                            // CRITICAL: Copy owner_id to project object for ownership checks
                            project.owner_id = projectData.owner_id;
                            return project;
                        });
                    }

                    if (data.promptCount !== undefined) { // Check for undefined, not just falsy
                        this.promptCount = data.promptCount;
                    }

                    this.updateUI();
                    
                    // Reopen modal if it was open before, and the project still exists
                    if (wasModalOpen && openProjectId) {
                        const projectStillExists = this.projects.some(p => p.id === openProjectId);
                        if (projectStillExists) {
                            // Small delay to ensure UI is updated first
                            setTimeout(() => {
                                this.openEditModal(openProjectId);
                            }, 100);
                        }
                    }
                } catch (error) {
                    console.error('Error loading data:', error);
                    // Show error to user but don't crash
                    showStatus('userStatus', 'Error loading data. Please refresh.', 'error');
                }
                this.renderJiraBoard();
            }

            loadCurrentUserProfile() {
                if (!this.currentUser) return;

                document.getElementById('userName').value = this.currentUser.name;

                // Load skills - parse and set radio buttons + other
                this.loadSkillsFromString(this.currentUser.skills || '');

                // Load programming languages - parse and set radio buttons + other
                this.loadLanguagesFromString(this.currentUser.programmingLanguages || '');

                document.getElementById('userWilling').value = this.currentUser.willingToWorkOn;
                this.populateJiraCredentialsForm();
                updateProfileDropdown();
            }

            populateJiraCredentialsForm() {
                if (!this.currentUser) return;

                const jiraBaseUrlInput = document.getElementById('jiraBaseUrl');
                if (jiraBaseUrlInput) jiraBaseUrlInput.value = this.currentUser.jiraBaseUrl || '';

                const jiraProjectKeyInput = document.getElementById('jiraProjectKey');
                if (jiraProjectKeyInput) jiraProjectKeyInput.value = this.currentUser.jiraProjectKey || '';

                const jiraEmailInput = document.getElementById('jiraEmail');
                if (jiraEmailInput) jiraEmailInput.value = this.currentUser.jiraEmail || '';

                const jiraApiTokenInput = document.getElementById('jiraApiToken');
                if (jiraApiTokenInput) jiraApiTokenInput.value = this.currentUser.jiraApiToken || '';

                const jiraProjectPromptInput = document.getElementById('jiraProjectPrompt');
                if (jiraProjectPromptInput) jiraProjectPromptInput.value = this.currentUser.jiraProjectPrompt || '';
            }

            loadSkillsFromString(skillsString) {
                if (!skillsString) {
                    // Clear all selections
                    document.querySelectorAll('input[name="skills"]').forEach(radio => radio.checked = false);
                    document.getElementById('userSkillsOther').value = '';
                    return;
                }

                const skillsList = skillsString.split(',').map(s => s.trim()).filter(s => s);
                const predefinedSkills = [
                    'Machine Learning', 'Databases', 'Cloud Computing', 'Frontend Development',
                    'Backend Development', 'DevOps', 'Security', 'Mobile Development',
                    'Testing', 'UI/UX Design', 'Data Science', 'Software Architecture'
                ];

                const otherSkills = [];

                // First, uncheck all checkboxes
                document.querySelectorAll('input[name="skills"]').forEach(cb => cb.checked = false);

                skillsList.forEach(skill => {
                    if (predefinedSkills.includes(skill)) {
                        // Check the corresponding checkbox
                        const checkbox = document.querySelector(`input[name="skills"][value="${skill}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    } else {
                        otherSkills.push(skill);
                    }
                });

                // Set other skills
                document.getElementById('userSkillsOther').value = otherSkills.join(', ');
            }

            loadLanguagesFromString(languagesString) {
                if (!languagesString) {
                    // Clear all selections
                    document.querySelectorAll('input[name="languages"]').forEach(radio => radio.checked = false);
                    document.getElementById('userLanguagesOther').value = '';
                    return;
                }

                const languagesList = languagesString.split(',').map(l => l.trim()).filter(l => l);
                const predefinedLanguages = [
                    'Python', 'Java', 'JavaScript', 'TypeScript', 'C++', 'C#',
                    'Go', 'Rust', 'PHP', 'Ruby', 'Swift', 'Kotlin', 'SQL', 'HTML/CSS'
                ];

                const otherLanguages = [];

                // First, uncheck all checkboxes
                document.querySelectorAll('input[name="languages"]').forEach(cb => cb.checked = false);

                languagesList.forEach(language => {
                    if (predefinedLanguages.includes(language)) {
                        // Check the corresponding checkbox
                        const checkbox = document.querySelector(`input[name="languages"][value="${language}"]`);
                        if (checkbox) {
                            checkbox.checked = true;
                        }
                    } else {
                        otherLanguages.push(language);
                    }
                });

                // Set other languages
                document.getElementById('userLanguagesOther').value = otherLanguages.join(', ');
            }

            collectProfileFormData() {
                const name = (document.getElementById('userName')?.value || '').trim();

                // Collect selected skills from checkboxes
                const selectedSkills = Array.from(document.querySelectorAll('input[name="skills"]:checked'))
                    .map(checkbox => checkbox.value);
                const otherSkills = (document.getElementById('userSkillsOther')?.value || '').trim();
                const allSkills = [...selectedSkills];
                if (otherSkills) {
                    const otherSkillsList = otherSkills.split(',').map(s => s.trim()).filter(s => s);
                    allSkills.push(...otherSkillsList);
                }
                const skills = allSkills.join(', ');

                // Collect selected languages from checkboxes
                const selectedLanguages = Array.from(document.querySelectorAll('input[name="languages"]:checked'))
                    .map(checkbox => checkbox.value);
                const otherLanguages = (document.getElementById('userLanguagesOther')?.value || '').trim();
                const allLanguages = [...selectedLanguages];
                if (otherLanguages) {
                    const otherLanguagesList = otherLanguages.split(',').map(l => l.trim()).filter(l => l);
                    allLanguages.push(...otherLanguagesList);
                }
                const programmingLanguages = allLanguages.join(', ');

                const willingToWorkOn = (document.getElementById('userWilling')?.value || '').trim();
                return { name, skills, programmingLanguages, willingToWorkOn };
            }

            collectJiraCredentials(useFallback = false) {
                // Pull Jira credentials + backlog prompt from the form, optionally defaulting to currentUser values
                const fallback = useFallback && this.currentUser ? {
                    jiraBaseUrl: this.currentUser.jiraBaseUrl || '',
                    jiraProjectKey: this.currentUser.jiraProjectKey || '',
                    jiraEmail: this.currentUser.jiraEmail || '',
                    jiraApiToken: this.currentUser.jiraApiToken || '',
                    jiraProjectPrompt: this.currentUser.jiraProjectPrompt || ''
                } : {
                    jiraBaseUrl: '',
                    jiraProjectKey: '',
                    jiraEmail: '',
                    jiraApiToken: '',
                    jiraProjectPrompt: ''
                };

                const jiraBaseUrl = (document.getElementById('jiraBaseUrl')?.value || fallback.jiraBaseUrl || '').trim();
                const jiraProjectKey = (document.getElementById('jiraProjectKey')?.value || fallback.jiraProjectKey || '').trim();
                const jiraEmail = (document.getElementById('jiraEmail')?.value || fallback.jiraEmail || '').trim();
                const jiraApiToken = (document.getElementById('jiraApiToken')?.value || fallback.jiraApiToken || '').trim();
                const jiraProjectPrompt = (document.getElementById('jiraProjectPrompt')?.value || fallback.jiraProjectPrompt || '').trim();

                return { jiraBaseUrl, jiraProjectKey, jiraEmail, jiraApiToken, jiraProjectPrompt };
            }

            updateProfile() {
                const profileData = this.collectProfileFormData();
                const jiraData = this.collectJiraCredentials(true);
                const name = profileData.name || this.currentUser?.name || '';

                if (!name) {
                    showStatus('userStatus', 'Error: Name is required', 'error');
                    return;
                }

                if (this.currentUser) {
                    this.currentUser.name = name;
                    this.currentUser.skills = profileData.skills;
                    this.currentUser.programmingLanguages = profileData.programmingLanguages;
                    this.currentUser.willingToWorkOn = profileData.willingToWorkOn;
                    this.currentUser.jiraBaseUrl = jiraData.jiraBaseUrl;
                    this.currentUser.jiraProjectKey = jiraData.jiraProjectKey;
                    this.currentUser.jiraEmail = jiraData.jiraEmail;
                    this.currentUser.jiraApiToken = jiraData.jiraApiToken;
                    this.currentUser.jiraProjectPrompt = jiraData.jiraProjectPrompt;
                }

                // Send update to extension
                vscode.postMessage({
                    type: 'updateProfile',
                    payload: {
                        name,
                        skills: profileData.skills,
                        programmingLanguages: profileData.programmingLanguages,
                        willingToWorkOn: profileData.willingToWorkOn,
                        jiraBaseUrl: jiraData.jiraBaseUrl,
                        jiraProjectKey: jiraData.jiraProjectKey,
                        jiraEmail: jiraData.jiraEmail,
                        jiraApiToken: jiraData.jiraApiToken,
                        jiraProjectPrompt: jiraData.jiraProjectPrompt
                    }
                });

                showStatus('userStatus', 'Updating profile...', 'info');
            }

            resetProfileForm() {
                this.loadCurrentUserProfile();
                showStatus('userStatus', 'Form reset to saved values', 'info');
            }

            storeAiAnalysis(projectId, analysis) {
                if (!projectId || !analysis) {
                    return;
                }
                this.aiAnalysisByProject[projectId] = analysis;
                this.latestAiProjectId = projectId;
            }

            getProjectNameById(projectId) {
                if (!projectId) {
                    return '';
                }
                const matchingProject = this.projects.find(project => String(project.id) === String(projectId));
                return matchingProject ? matchingProject.name : '';
            }

            buildBacklogFromAnalysis(analysis) {
                if (!analysis) {
                    return '';
                }

                const tasks = [];
                const seen = new Set();
                const addTask = (text) => {
                    const cleaned = (text || '').replace(/\s+/g, ' ').trim();
                    if (!cleaned || seen.has(cleaned)) {
                        return;
                    }
                    seen.add(cleaned);
                    tasks.push(`- [ ] ${cleaned}`);
                };

                if (Array.isArray(analysis.roleAssignments)) {
                    analysis.roleAssignments.forEach(member => {
                        const memberPrefix = member?.memberName ? `${member.memberName}: ` : '';
                        const taskGroups = member?.tasks || {};

                        if (Array.isArray(taskGroups.immediate)) {
                            taskGroups.immediate.forEach(task => addTask(`${memberPrefix}${task}`));
                        }

                        if (Array.isArray(taskGroups.future)) {
                            taskGroups.future.forEach(task => addTask(`${memberPrefix}(Future) ${task}`));
                        }

                        if (Array.isArray(member?.responsibilities)) {
                            member.responsibilities.forEach(resp => addTask(`${memberPrefix}(Responsibility) ${resp}`));
                        }
                    });
                }

                if (Array.isArray(analysis.deliverables)) {
                    analysis.deliverables.forEach(deliverable => {
                        const parts = [];
                        if (deliverable?.name) {
                            parts.push(deliverable.name);
                        }
                        if (deliverable?.description) {
                            parts.push(deliverable.description);
                        }
                        if (deliverable?.assignedTo) {
                            parts.push(`Owner: ${deliverable.assignedTo}`);
                        }
                        if (deliverable?.milestone) {
                            parts.push(`Milestone: ${deliverable.milestone}`);
                        }
                        if (deliverable?.timeline) {
                            parts.push(`Timeline: ${deliverable.timeline}`);
                        }
                        if (parts.length > 0) {
                            addTask(parts.join(' | '));
                        }
                    });
                }

                return tasks.join('\n');
            }

            useAiAnalysisForJira() {
                const promptProjectSelect = document.getElementById('promptProject');
                const selectedProjectId = promptProjectSelect?.value?.trim() || '';
                const targetProjectId = selectedProjectId || this.latestAiProjectId;

                if (!targetProjectId) {
                    showStatus('jiraStatus', 'âŒ Please generate an AI analysis for a project first.', 'error');
                    return;
                }

                const analysis = this.aiAnalysisByProject[targetProjectId];
                if (!analysis) {
                    showStatus('jiraStatus', 'âŒ No AI analysis found for the selected project. Run the AI Analysis & Task Delegation feature first.', 'error');
                    return;
                }

                const backlog = this.buildBacklogFromAnalysis(analysis);
                if (!backlog) {
                    showStatus('jiraStatus', 'âŒ The AI analysis does not include any actionable tasks to send to Jira.', 'error');
                    return;
                }

                const projectPromptField = document.getElementById('jiraProjectPrompt');
                if (projectPromptField) {
                    projectPromptField.value = backlog;
                }

                const projectName = this.getProjectNameById(targetProjectId);
                showStatus('jiraStatus', `ðŸ§  Using AI-delegated tasks${projectName ? ` from ${projectName}` : ''}.`, 'info');

                this.createJiraTasksFromProfile();
            }

            createJiraTasksFromProfile() {
                // Validate Jira form inputs then send AI backlog â†’ Jira creation request to extension
                const profileData = this.collectProfileFormData();
                const jiraData = this.collectJiraCredentials();
                const name = profileData.name || this.currentUser?.name || '';
                const missingFields = [];

                if (!name) missingFields.push('Your name (set it in My Profile)');
                if (!jiraData.jiraBaseUrl) missingFields.push('Jira base URL');
                if (!jiraData.jiraProjectKey) missingFields.push('Jira project key');
                if (!jiraData.jiraEmail) missingFields.push('Jira account email');
                if (!jiraData.jiraApiToken) missingFields.push('Jira API token');
                if (!jiraData.jiraProjectPrompt) missingFields.push('project prompt');

                if (missingFields.length > 0) {
                    showStatus(
                        'jiraStatus',
                        `âŒ Please provide: ${missingFields.join(', ')}`,
                        'error'
                    );
                    return;
                }

                if (this.currentUser) {
                    this.currentUser.name = name;
                    this.currentUser.skills = profileData.skills;
                    this.currentUser.programmingLanguages = profileData.programmingLanguages;
                    this.currentUser.willingToWorkOn = profileData.willingToWorkOn;
                    this.currentUser.jiraBaseUrl = jiraData.jiraBaseUrl;
                    this.currentUser.jiraProjectKey = jiraData.jiraProjectKey;
                    this.currentUser.jiraEmail = jiraData.jiraEmail;
                    this.currentUser.jiraApiToken = jiraData.jiraApiToken;
                    this.currentUser.jiraProjectPrompt = jiraData.jiraProjectPrompt;
                }

                // Persist credentials to profile
                vscode.postMessage({
                    type: 'updateProfile',
                    payload: {
                        name,
                        skills: profileData.skills,
                        programmingLanguages: profileData.programmingLanguages,
                        willingToWorkOn: profileData.willingToWorkOn,
                        jiraBaseUrl: jiraData.jiraBaseUrl,
                        jiraProjectKey: jiraData.jiraProjectKey,
                        jiraEmail: jiraData.jiraEmail,
                        jiraApiToken: jiraData.jiraApiToken,
                        jiraProjectPrompt: jiraData.jiraProjectPrompt
                    }
                });

                // Trigger Jira task creation
                vscode.postMessage({
                    type: 'createJiraTasks',
                    payload: {
                        baseUrl: jiraData.jiraBaseUrl,
                        projectKey: jiraData.jiraProjectKey,
                        email: jiraData.jiraEmail,
                        token: jiraData.jiraApiToken,
                        description: jiraData.jiraProjectPrompt
                    }
                });

                showStatus('jiraStatus', 'ðŸš€ Creating Jira tasks...', 'info');
            }

            hasJiraCredentials() {
                return (
                    this.currentUser &&
                    this.currentUser.jiraBaseUrl &&
                    this.currentUser.jiraProjectKey &&
                    this.currentUser.jiraEmail &&
                    this.currentUser.jiraApiToken
                );
            }

            getJiraPayload(extra = {}) {
                if (!this.hasJiraCredentials()) {
                    throw new Error('Jira credentials are missing.');
                }
                return {
                    baseUrl: this.currentUser.jiraBaseUrl,
                    email: this.currentUser.jiraEmail,
                    token: this.currentUser.jiraApiToken,
                    projectKey: this.currentUser.jiraProjectKey, // Core fields the extension expects for Jira REST calls
                    ...extra
                };
            }

            fetchAssignableFromJira() {
                try {
                    const payload = this.getJiraPayload();
                    vscode.postMessage({
                        type: 'jiraFetchAssignable',
                        payload
                    });
                } catch (err) {
                    this.showJiraStatus(err.message || 'Add Jira credentials to load assignees.', 'error');
                }
            }

            renderJiraBoard() {
                const warning = document.getElementById('jiraCredentialsWarning');
                const board = document.getElementById('jiraBoard');
                if (!warning || !board) return;

                const hasCredentials = this.hasJiraCredentials();
                if (!hasCredentials) {
                    warning.textContent = 'Add your Jira credentials above to manage tasks.';
                    warning.style.display = 'block';
                    board.classList.add('hidden');
                    return;
                }

                if (!this.jiraUnlocked) {
                    this.unlockJiraTab();
                }

                warning.style.display = 'none';
                board.classList.remove('hidden');

                const statusSelect = document.getElementById('jiraFilterStatus');
                if (statusSelect) {
                    const currentValue = this.jiraFilters.status || '';
                    statusSelect.innerHTML = '<option value="">All Statuses</option>' +
                        this.jiraStatuses.map(status => `<option value="${status}">${status}</option>`).join('');
                    statusSelect.value = currentValue;
                }

                this.renderJiraTaskList();
                this.renderJiraTaskDetail();
            }

            renderJiraTaskList() {
                const listEl = document.getElementById('jiraTaskList');
                if (!listEl) return;

                if (this.jiraLoading) {
                    listEl.innerHTML = `<div class="jira-empty-state"><p>Loading Jira tasks...</p></div>`;
                    return;
                }

                if (!this.jiraTasks.length) {
                    listEl.innerHTML = `<div class="jira-empty-state"><p>No Jira tasks found.</p></div>`;
                    return;
                }

                listEl.innerHTML = this.jiraTasks.map(task => `
                    <div class="jira-task-row ${this.jiraSelectedTask && this.jiraSelectedTask.id === task.id ? 'selected' : ''}" data-issue-id="${task.id}">
                        <div class="jira-task-content">
                            <div class="jira-task-summary"><span class="jira-task-key">${task.key || 'Task'}</span>${this.getJiraTaskTitle(task)}</div>
                            ${this.renderJiraTaskPurpose(task)}
                            <div class="jira-task-meta">${this.getJiraAssigneeLabel(task.assignee)} Â· ${new Date(task.updated).toLocaleString()}</div>
                        </div>
                        <span class="jira-status-chip">${task.status?.name || 'Unknown'}</span>
                    </div>
                `).join('');
            }

            unlockJiraTab(autoShow = false) {
                if (this.jiraUnlocked) {
                    if (autoShow) {
                        const btn = document.querySelector('.tab-button[data-tab="jira"]');
                        showTab('jira', btn);
                        this.loadJiraTasks();
                        this.fetchAssignableFromJira();
                    }
                    return;
                }
                this.jiraUnlocked = true;
                try {
                    window.localStorage.setItem('jiraUnlocked', 'true');
                } catch (err) {
                    console.warn('Unable to persist Jira unlock state:', err);
                }
                const btn = document.querySelector('.tab-button[data-tab="jira"]');
                if (btn) {
                    btn.classList.remove('tab-disabled');
                    btn.removeAttribute('title');
                }
                this.renderJiraBoard();
                this.fetchAssignableFromJira();
                if (autoShow) {
                    showTab('jira', btn);
                    this.loadJiraTasks();
                }
            }

            renderJiraTaskDetail() {
                const detailEl = document.getElementById('jiraTaskDetail');
                if (!detailEl) return;

                if (this.isCreatingJiraTask) {
                    detailEl.innerHTML = this.renderJiraDetailForm({
                        summary: '',
                        description: '',
                        assigneeEmail: '',
                        status: '',
                        mode: 'create',
                        purpose: '',
                        assignee: null
                    });
                    return;
                }

                if (!this.jiraSelectedTask) {
                    detailEl.innerHTML = `<p class="jira-empty-state">Select a task to view and edit details.</p>`;
                    return;
                }

                detailEl.innerHTML = this.renderJiraDetailForm({
                    summary: this.jiraSelectedTask.summary || '',
                    description: this.extractDescription(this.jiraSelectedTask.description),
                    assigneeEmail: this.jiraSelectedTask.assignee?.email || '',
                    status: this.jiraSelectedTask.status?.name || '',
                    mode: 'edit',
                    key: this.jiraSelectedTask.key,
                    purpose: this.getJiraPurposeText(this.jiraSelectedTask),
                    assignee: this.jiraSelectedTask.assignee || null
                });

                if (!this.jiraTransitions[this.jiraSelectedTask.id]) {
                    this.requestJiraTransitions(this.jiraSelectedTask.id);
                }
            }

            renderJiraDetailForm(opts) {
                const teamOptions = this.users
                    .map(user => {
                        const email = user.jiraEmail || user.email || '';
                        const label = `${user.name}${email ? ` (${email})` : ''}`;
                        if (!email) {
                            return '';
                        }
                        return `<option value="${email}" ${opts.assigneeEmail === email ? 'selected' : ''}>${label}</option>`;
                    })
                    .filter(Boolean)
                    .join('');
                const assigneeOptions = this.getJiraAssigneeOptions();
                const activeProjectName = this.getProjectNameById(this.getActiveProjectIdForJira());
                const currentAssigneeLabel = this.getJiraAssigneeLabel(opts.assignee);
                const currentAssigneeEmail = opts.assigneeEmail || opts.assignee?.email || '';
                const currentAssigneeAccountId = opts.assignee?.accountId || '';
                const currentAssigneeValue = currentAssigneeEmail || currentAssigneeAccountId;
                const currentStatusName = opts.status || (this.jiraSelectedTask?.status?.name) || 'Unknown';
                const assigneeExists = assigneeOptions.some(option =>
                    (currentAssigneeEmail && option.email === currentAssigneeEmail) ||
                    (currentAssigneeAccountId && option.accountId === currentAssigneeAccountId)
                );

                // Ensure current Jira assignee (from server) appears in dropdown if it has an email
                const enrichedAssigneeOptions = [...assigneeOptions];
                if (currentAssigneeEmail && !assigneeOptions.some(option => option.email === currentAssigneeEmail)) {
                    enrichedAssigneeOptions.unshift({
                        email: currentAssigneeEmail,
                        name: currentAssigneeLabel || currentAssigneeEmail,
                        projectNames: [],
                        isProjectMember: false
                    });
                }

                const viewOnlyAssigneeOption = !assigneeExists && !currentAssigneeEmail && opts.assignee
                    ? `<option value="${opts.assignee.accountId || ''}" data-email="${opts.assignee.email || ''}" data-account-id="${opts.assignee.accountId || ''}" selected>${currentAssigneeLabel} (view only)</option>`
                    : '';

                const assigneeOptionsHtml = enrichedAssigneeOptions.length
                    ? enrichedAssigneeOptions.map(option => {
                        const identifier = option.email || option.accountId || '';
                        if (!identifier) {
                            return '';
                        }
                        const projectsLabel = option.projectNames && option.projectNames.length
                            ? ` â€” ${option.projectNames.join(', ')}`
                            : '';
                        const emailLabel = option.email ? `(${option.email})` : '';
                        const label = `${option.name} ${emailLabel}${projectsLabel}${option.isProjectMember ? ' â€” Project teammate' : ''}`;
                        const isSelected =
                            (currentAssigneeEmail && option.email && currentAssigneeEmail === option.email) ||
                            (!currentAssigneeEmail && currentAssigneeAccountId && option.accountId && currentAssigneeAccountId === option.accountId);
                        return `<option value="${identifier}" data-email="${option.email || ''}" data-account-id="${option.accountId || ''}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                    }).join('')
                    : '';
                const assigneeHint = assigneeOptions.length
                    ? `<p class="jira-summary-hint">Assignees pulled from Jira${activeProjectName ? ` for ${activeProjectName}` : ''}.</p>`
                    : `<p class="jira-summary-hint">Reload assignable users from Jira above to populate this list.</p>`;
                const externalAssigneeNote = (!currentAssigneeValue && !currentAssigneeLabel)
                    ? ''
                    : !assigneeExists
                        ? `<p class="jira-summary-hint">Current Jira assignee: ${currentAssigneeLabel || 'Unknown user'} (not in teammate list)</p>`
                        : '';

                const transitions = (this.jiraSelectedTask && this.jiraTransitions[this.jiraSelectedTask.id]) || [];

                const statusOptions = (transitions || []).map(t => `<option value="${t.id}" ${t.name === currentStatusName ? 'selected' : ''}>${t.name}</option>`).join('');
                const statusHint = `<p style="font-size:0.8rem; color:#94a3b8; margin-top:4px;">Status changes apply through Jira transitions. Current: ${currentStatusName}</p>`;

                const keyLine = opts.key ? `<p style="font-size:0.9rem; color:#64748b; margin-bottom:8px;">${opts.key}</p>` : '';
                const summaryHiddenField = `<input type="hidden" id="jiraDetailSummary" value="${opts.summary || ''}">`;
                const summaryDisplay = opts.summary
                    ? `<div class="jira-detail-title">${opts.summary}</div>`
                    : '';

                const descriptionField = opts.mode === 'create'
                    ? `
                    ${keyLine}
                    ${summaryHiddenField}
                    ${summaryDisplay}
                    ${opts.purpose ? `
                    <div class="jira-purpose-card">
                        <label>Task Purpose</label>
                        <p>${opts.purpose}</p>
                    </div>` : ''}
                    <div class="form-group">
                        <label>Description</label>
                        <textarea id="jiraDetailDescription">${opts.description || ''}</textarea>
                    </div>
                    `
                    : `
                    ${keyLine}
                    ${summaryHiddenField}
                    ${summaryDisplay}
                    ${opts.purpose ? `
                    <div class="jira-purpose-card">
                        <label>Task Purpose</label>
                        <p>${opts.purpose}</p>
                    </div>` : ''}
                    `;

                return `
                    ${descriptionField}
                    <div>
                        <label>Assignee</label>
                        <select id="jiraDetailAssignee">
                            <option value="" ${(!currentAssigneeEmail && !viewOnlyAssigneeOption) ? 'selected' : ''}>Unassigned</option>
                            ${viewOnlyAssigneeOption}
                            ${assigneeOptionsHtml || teamOptions}
                        </select>
                        ${assigneeHint}
                        ${externalAssigneeNote}
                    </div>
                    <div>
                        <label>Status</label>
                        <select id="jiraDetailStatus">
                            <option value="">--</option>
                            ${statusOptions}
                        </select>
                        ${statusHint}
                    </div>
                    <div class="button-group" style="justify-content:flex-end;">
                        ${opts.mode === 'edit'
                            ? `<button type="button" class="btn btn-danger" id="jiraDeleteTaskBtn">Delete</button>
                               <button type="button" class="btn btn-primary" id="jiraSaveTaskBtn">Save Changes</button>`
                            : `<button type="button" class="btn btn-secondary" id="jiraCancelCreateBtn">Cancel</button>
                               <button type="button" class="btn btn-primary" id="jiraCreateTaskBtn">Create Task</button>`}
                    </div>
                `;
            }

            extractDescription(descriptionNode) {
                if (!descriptionNode) {
                    return '';
                }
                if (typeof descriptionNode === 'string') {
                    return descriptionNode;
                }
                if (descriptionNode.content) {
                    return descriptionNode.content
                        .map((node) => node.content ? node.content.map(c => c.text || '').join(' ') : node.text || '')
                        .join('\n');
                }
                return '';
            }

            getJiraTaskTitle(task) {
                if (!task) {
                    return 'Untitled Task';
                }
                const text = (task.summary || '').replace(/\s+/g, ' ').trim();
                return text || 'Untitled Task';
            }

            getJiraPurposeText(task) {
                if (!task) {
                    return '';
                }
                const descriptionText = this.extractDescription(task.description);
                return this.formatJiraSummary(task.summary, descriptionText);
            }

            renderJiraTaskPurpose(task) {
                const purpose = this.getJiraPurposeText(task);
                if (!purpose) {
                    return '';
                }
                return `<div class="jira-task-purpose">${purpose}</div>`;
            }

            getJiraAssigneeLabel(assignee) {
                if (!assignee) {
                    return 'Unassigned';
                }
                return assignee.displayName || assignee.email || 'Assignee';
            }

            looksLikeEmail(value) {
                return /\S+@\S+\.\S+/.test(value || '');
            }

            formatJiraSummary(rawSummary, descriptionText = '') {
                const summary = (rawSummary || '').replace(/\s+/g, ' ').trim();
                const description = (descriptionText || '').replace(/\s+/g, ' ').trim();
                const firstSentence = this.extractFirstSentence(description);

                if (!summary && !description) {
                    return 'Clarify this task so that the AI collaboration experience stays on track.';
                }

                if (this.summaryHasReason(summary)) {
                    return this.ensureSentence(summary);
                }

                if (!summary && firstSentence) {
                    return this.combineSummaryClauses(firstSentence, this.extractReasonClause(description));
                }

                const reasonClause = this.extractReasonClause(description) ||
                    (firstSentence && firstSentence !== summary ? firstSentence : '');

                return this.combineSummaryClauses(summary || firstSentence || 'Document this task clearly', reasonClause);
            }

            summaryHasReason(text) {
                if (!text) {
                    return false;
                }
                return /(so that|because|to ensure|to support|to enable|allows|enables)/i.test(text);
            }

            extractFirstSentence(text) {
                const sentences = this.splitIntoSentences(text);
                return sentences.length ? sentences[0] : '';
            }

            extractReasonClause(text) {
                if (!text) {
                    return '';
                }
                const patterns = [
                    { regex: /so that\s+([^.!?]+)/i, extract: (m) => `so that ${m[1].trim()}` },
                    { regex: /so the\s+([^.!?]+)/i, extract: (m) => `so the ${m[1].trim()}` },
                    { regex: /because\s+([^.!?]+)/i, extract: (m) => `because ${m[1].trim()}` },
                    { regex: /in order to\s+([^.!?]+)/i, extract: (m) => `in order to ${m[1].trim()}` },
                    { regex: /to ensure\s+([^.!?]+)/i, extract: (m) => `to ensure ${m[1].trim()}` },
                    { regex: /allows?\s+([^.!?]+)/i, extract: (m) => m[0].trim() },
                    { regex: /enables?\s+([^.!?]+)/i, extract: (m) => m[0].trim() }
                ];

                for (const pattern of patterns) {
                    const match = text.match(pattern.regex);
                    if (match) {
                        return pattern.extract(match);
                    }
                }

                const sentences = this.splitIntoSentences(text);
                if (sentences.length > 1) {
                    return sentences[1];
                }

                return '';
            }

            combineSummaryClauses(actionClause, reasonClause) {
                const action = this.cleanClause(actionClause);
                const fallbackReason = 'the AI collaboration experience stays on track';
                const rawReason = (reasonClause || '').trim();
                if (!rawReason) {
                    return this.ensureSentence(`${action} so that ${fallbackReason}`);
                }
                const prefixPattern = /^(so\b|because\b|to\b|in order to\b|allows?\b|enables?\b)/i;
                if (prefixPattern.test(rawReason)) {
                    const adjusted = this.cleanClause(rawReason, true);
                    return this.ensureSentence(`${action} ${adjusted}`);
                }
                const normalized = this.cleanClause(rawReason, true);
                return this.ensureSentence(`${action} so that ${normalized}`);
            }

            cleanClause(text, lowercase = false) {
                let value = (text || '').replace(/\s+/g, ' ').trim();
                value = value.replace(/^[-â€“â€¢]+\s*/, '');
                value = value.replace(/[.?!]+$/, '');
                if (!value) {
                    return '';
                }
                if (lowercase) {
                    return value.charAt(0).toLowerCase() + value.slice(1);
                }
                return value.charAt(0).toUpperCase() + value.slice(1);
            }

            ensureSentence(text) {
                let value = (text || '').replace(/\s+/g, ' ').trim();
                if (!value) {
                    return '';
                }
                if (!/[.?!]$/.test(value)) {
                    value += '.';
                }
                return value;
            }

            splitIntoSentences(text) {
                if (!text) {
                    return [];
                }
                return text
                    .split(/(?<=[.?!])\s+/)
                    .map(sentence => sentence.trim())
                    .filter(Boolean);
            }

            loadJiraTasks(autoShowTab = false) {
                if (!this.jiraUnlocked) {
                    return;
                }
                if (!this.hasJiraCredentials()) {
                    this.renderJiraBoard();
                    this.showJiraStatus('Add Jira credentials to fetch tasks.', 'error');
                    return;
                }
                if (autoShowTab) {
                    const jiraTabBtn = document.querySelector('.tab-button[data-tab="jira"]');
                    showTab('jira', jiraTabBtn);
                }
                const requestId = ++this.jiraActiveRequestId; // Increment counter so stale responses can be ignored
                this.jiraLoading = true; // Show loading state while waiting on Jira
                this.renderJiraTaskList();
                vscode.postMessage({
                    type: 'loadJiraTasks',
                    payload: this.getJiraPayload({
                        requestId,
                        status: this.jiraFilters.status,
                        search: this.jiraFilters.search
                    })
                });
            }

            requestJiraTransitions(issueId) {
                if (!issueId || !this.hasJiraCredentials()) {
                    return;
                }
                vscode.postMessage({
                    type: 'jiraGetTransitions', // Ask extension for allowed status moves for this issue
                    payload: this.getJiraPayload({ issueId })
                });
            }

            selectJiraTask(issueId) {
                const task = this.jiraTasks.find(t => t.id === issueId);
                this.isCreatingJiraTask = false;
                this.jiraSelectedTask = task || null;
                this.renderJiraTaskList();
                this.renderJiraTaskDetail();
            }

            startCreatingJiraTask() {
                this.isCreatingJiraTask = true; // Switch detail pane into creation mode
                this.jiraSelectedTask = null; // Clear selection so form defaults are blank
                this.renderJiraTaskDetail();
            }

            submitJiraTaskForm() {
                try {
                    const summaryInput = document.getElementById('jiraDetailSummary');
                    const descriptionInput = document.getElementById('jiraDetailDescription');
                    const assigneeInput = document.getElementById('jiraDetailAssignee');
                    const assigneeSelectedOption = assigneeInput?.selectedOptions?.[0];
                    const statusInput = document.getElementById('jiraDetailStatus');

                    const descriptionSource = descriptionInput
                        ? descriptionInput.value
                        : this.extractDescription(this.jiraSelectedTask?.description);
                    const generatedSummary = summaryInput?.value?.trim()
                        || this.jiraSelectedTask?.summary
                        || this.extractFirstSentence(descriptionSource)
                        || 'New Jira Task';
                    const summary = generatedSummary.trim();
                    const description = this.formatJiraSummary(summary, descriptionSource); // Ensure summary is echoed in description when Jira renders
                    const selectedAssignee = assigneeInput ? assigneeInput.value : '';
                    const selectedAssigneeEmail = assigneeSelectedOption?.getAttribute('data-email') || (this.looksLikeEmail(selectedAssignee) ? selectedAssignee : '');
                    const selectedAssigneeAccountId = assigneeSelectedOption?.getAttribute('data-account-id') || (!this.looksLikeEmail(selectedAssignee) && selectedAssignee ? selectedAssignee : '');
                    const currentAssigneeEmail = this.jiraSelectedTask?.assignee?.email || '';
                    const currentAssigneeAccountId = this.jiraSelectedTask?.assignee?.accountId || '';
                    let selectedAssigneeIdentifier = selectedAssigneeAccountId || selectedAssigneeEmail || '';
                    const currentAssigneeIdentifier = currentAssigneeAccountId || currentAssigneeEmail || '';
                    // Keep current assignee when the dropdown shows a view-only option with empty value
                    if (!selectedAssigneeIdentifier && currentAssigneeIdentifier) {
                        selectedAssigneeIdentifier = currentAssigneeIdentifier;
                    }
                    // Only send an assignee update when the user explicitly changes the selection.
                    const assigneeChanged = this.isCreatingJiraTask
                        ? !!selectedAssigneeIdentifier
                        : (selectedAssigneeIdentifier !== currentAssigneeIdentifier);
                    const assigneeEmail = assigneeChanged ? (selectedAssigneeEmail || null) : undefined;
                    let assigneeAccountId;
                    if (assigneeChanged) {
                        if (selectedAssigneeAccountId) {
                            assigneeAccountId = selectedAssigneeAccountId;
                        } else if (selectedAssigneeEmail) {
                            assigneeAccountId = undefined; // let the extension resolve email â†’ accountId
                        } else {
                            assigneeAccountId = null; // explicit unassign
                        }
                    }
                    const transitionId = statusInput ? statusInput.value || null : null; // Track requested status change

                    if (!summary) {
                        this.showJiraStatus('Summary is required.', 'error');
                        return;
                    }

                    if (summaryInput) {
                        summaryInput.value = summary;
                    }
                    if (descriptionInput) {
                        descriptionInput.value = description;
                    }

                    if (this.isCreatingJiraTask) {
                        console.log('[Webview:Jira] Creating task', { assigneeChanged, assigneeEmail, assigneeAccountId });
                        vscode.postMessage({
                            type: 'jiraCreateTask',
                            payload: this.getJiraPayload({
                                summary,
                                description,
                                assigneeEmail,
                                assigneeAccountId
                            })
                        });
                    } else if (this.jiraSelectedTask) {
                        console.log('[Webview:Jira] Updating task', { issueId: this.jiraSelectedTask.id, assigneeChanged, assigneeEmail, assigneeAccountId, transitionId });
                        vscode.postMessage({
                            type: 'jiraUpdateTask',
                            payload: this.getJiraPayload({
                                issueId: this.jiraSelectedTask.id,
                                summary,
                                description,
                                assigneeEmail,
                                assigneeAccountId,
                                transitionId
                            })
                        });
                    }
                } catch (error) {
                    this.showJiraStatus(error.message || 'Failed to submit task.', 'error');
                }
            }

            deleteSelectedJiraTask() {
                if (!this.jiraSelectedTask) {
                    return;
                }
                if (!confirm('Delete this Jira task?')) {
                    return;
                }
                vscode.postMessage({
                    type: 'jiraDeleteTask',
                    payload: this.getJiraPayload({
                        issueId: this.jiraSelectedTask.id
                    })
                });
            }

            showJiraStatus(message, type = 'success') {
                const el = document.getElementById('jiraTaskStatus');
                if (!el) return;
                el.textContent = message;
                el.className = `status-message status-${type}`;
                el.style.display = 'block';
                setTimeout(() => {
                    el.style.display = 'none';
                }, 4000);
            }

            saveData() {
                vscode.postMessage({
                    type: 'saveData',
                    payload: {
                        users: this.users,
                        projects: this.projects,
                        promptCount: this.promptCount
                    }
                });
            }

            addUser(name, skills, programmingLanguages, willingToWorkOn) {
                if (!name || !skills || !programmingLanguages) {
                    throw new Error('Name, skills, and programming languages are required');
                }

                const user = new TeamMember(name, skills, programmingLanguages, willingToWorkOn);
                this.users.push(user);
                this.saveData();
                this.updateUI();
                return user;
            }

            // Updated to store selectedUserIds directly
            createProject(name, description, goals, requirements, selectedUserIds) {
                if (!name || !description) {
                    throw new Error('Project name and description are required');
                }

                if (!selectedUserIds || selectedUserIds.length === 0) {
                    throw new Error('At least one team member must be selected');
                }

                const project = new Project(name, description, goals, requirements, selectedUserIds); // Pass IDs
                this.projects.push(project);
                this.saveData();
                this.updateUI();
                return project;
            }

            // Webview now only requests prompt generation from extension
            generateAIPrompt(projectId, modeConfig) {
                // Set active project first
                vscode.postMessage({
                    type: 'setActiveProject',
                    payload: { projectId: projectId }
                });

                // Send projectId and mode configuration to the extension
                vscode.postMessage({
                    type: 'generatePrompt',
                    payload: { 
                        projectId: projectId,
                        analysisMode: modeConfig
                    }
                });

                // Initialize terminal display
                initTerminalDisplay();
                const modeName = modeConfig?.name || 'Analysis';
                addTerminalLine(`Starting ${modeName}`, 'info', 'START');
                addTerminalLine(`Project ID: ${projectId}`, 'info', 'INFO');
                showStatus('promptStatus', `Generating ${modeName}...`, 'info');
            }

            // Removed createComprehensivePrompt from webview as extension handles it

            updateUI() {
                try {
                    this.updateStats();
                    this.updateCurrentUserDisplay();
                    this.updateProjectList();
                    this.updateUserSelection();
                    this.updateProjectSelection();
                } catch (error) {
                    console.error('Error updating UI:', error);
                    // Try to show a basic error message
                    const projectList = document.getElementById('projectList');
                    if (projectList) {
                        projectList.innerHTML = '<p style="text-align: center; color: #ef4444; padding: 15px;">Error updating UI. Please refresh the panel.</p>';
                    }
                }
            }

            updateStats() {
                const userCountEl = document.getElementById('userCount');
                const projectCountEl = document.getElementById('projectCount');
                const promptCountEl = document.getElementById('promptCount');
                if (userCountEl) userCountEl.textContent = this.users.length.toString();
                if (projectCountEl) projectCountEl.textContent = this.projects.length.toString();
                if (promptCountEl) promptCountEl.textContent = this.promptCount.toString();
            }

            updateCurrentUserDisplay() {
                const userDisplay = document.getElementById('currentUserDisplay');
                if (!userDisplay) return; // Profile summary section removed to match demo3

                if (!this.currentUser) {
                    userDisplay.innerHTML = '<p style="text-align: center; color: #64748b; padding: 15px;">Please log in to view your profile</p>';
                    return;
                }

                userDisplay.innerHTML = `
                    <div class="user-item">
                        <h3>ðŸ‘¤ ${this.currentUser.name}</h3>
                        <p><strong>Skills:</strong> ${this.currentUser.skills || 'Not specified'}</p>
                        <p><strong>Languages:</strong> ${this.currentUser.programmingLanguages || 'Not specified'}</p>
                        <p><strong>Interests:</strong> ${this.currentUser.willingToWorkOn || 'Not specified'}</p>
                        <p><strong>Jira Setup:</strong> ${this.hasJiraCredentials() ? 'Ready in the Jira Tasks tab' : 'Set up Jira in the Jira Tasks tab'}</p>
                        <p><strong>Member Since:</strong> ${new Date(this.currentUser.createdAt).toLocaleString()}</p>
                    </div>
                `;
            }

            updateProjectList() {
                const projectList = document.getElementById('projectList');
                if (!projectList) return; // Safety check
                
                if (this.projects.length === 0) {
                    projectList.innerHTML = '<p style="text-align: center; color: #64748b; padding: 15px;">No projects yet</p>';
                    return;
                }

                // Create a set of valid user IDs for efficient lookup
                const validUserIds = new Set(this.users.map(u => String(u.id)));

                projectList.innerHTML = this.projects.map(project => {
                    // Ensure selectedMemberIds is an array and filter to only valid user IDs
                    const validMemberIds = (project.selectedMemberIds || []).filter(id => validUserIds.has(String(id)));
                    // Filter this.users by valid IDs stored in project.selectedMemberIds
                    const teamMembers = this.users.filter(user => validMemberIds.includes(String(user.id)));

                    // Create detailed team member cards
                    const teamMemberCards = teamMembers.length > 0 ? teamMembers.map(member => `
                        <div class="team-member-card">
                            <div style="font-weight: 600; margin-bottom: 4px;">ðŸ‘¤ ${member.name}</div>
                            <div style="font-size: 0.85rem; color: #64748b;">
                                <div><strong>Skills:</strong> ${member.skills || 'Not specified'}</div>
                                <div><strong>Languages:</strong> ${member.programmingLanguages || 'Not specified'}</div>
                            </div>
                        </div>
                    `).join('') : '<p style="color: #64748b; font-size: 0.9rem;">No members yet</p>';

                    // Ensure both values are strings for comparison (handle UUID type mismatches)
                    const currentUserId = this.currentUser ? String(this.currentUser.id) : null;
                    const projectOwnerId = project.owner_id ? String(project.owner_id) : null;
                    const isOwner = currentUserId && projectOwnerId && currentUserId === projectOwnerId;
                    const isMember = this.currentUser && (project.selectedMemberIds || []).includes(String(this.currentUser.id));
                    const ownerBadge = isOwner ? '<span style="background: #10b981; color: white; padding: 2px 8px; border-radius: 12px; font-size: 0.75rem; font-weight: 600; margin-left: 8px;">Owner</span>' : '';
                    const canEdit = isOwner || isMember;

                    return `
                        <div class="project-item">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 10px;">
                                <h3 style="margin: 0;">ðŸ“‹ ${project.name}${ownerBadge}</h3>
                                ${canEdit ? `<button class="btn edit-project-btn" data-project-id="${project.id}" style="padding: 4px 8px; font-size: 0.8rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer;">âœï¸ Edit</button>` : ''}
                            </div>
                            <p><strong>Description:</strong> ${project.description}</p>
                            <p><strong>Goals:</strong> ${project.goals || 'Not specified'}</p>
                            <p><strong>Requirements:</strong> ${project.requirements || 'Not specified'}</p>
                            <p><strong>Invite Code:</strong> <code style="background: #f1f5f9; padding: 2px 6px; border-radius: 4px; font-family: monospace;">${project.invite_code || 'N/A'}</code></p>
                            <div class="team-members-section" style="margin-top: 15px;">
                                <strong>Team Members:</strong>
                                <div class="team-member-cards" style="margin-top: 8px;">
                                    ${teamMemberCards}
                                </div>
                                ${isOwner ? '<p style="margin-top: 8px; font-size: 0.85rem; color: #64748b;">As owner, you can remove members by editing the project.</p>' : ''}
                            </div>
                            <p style="margin-top: 10px;"><strong>Created:</strong> ${new Date(project.createdAt).toLocaleString()}</p>
                            ${isOwner
                            ? `<button class="btn btn-danger delete-project-btn" data-project-id="${project.id}" style='margin-top: 8px; padding: 6px 12px; font-size: 0.8rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;'>Delete Project</button>`
                            : `<button class="btn btn-secondary leave-project-btn" data-project-id="${project.id}" style='margin-top: 8px; padding: 6px 12px; font-size: 0.8rem; border: none; border-radius: 4px; cursor: pointer;'>Leave Project</button>`
                        }
                        </div>
                    `;
                }).join('');
            }

            updateUserSelection() {
                const userSelection = document.getElementById('userSelection');
                if (!userSelection) {
                    // Element doesn't exist (might be commented out), skip updating
                    return;
                }

                if (this.users.length === 0) {
                    userSelection.innerHTML = '<p style="text-align: center; color: #64748b; padding: 10px;">Add team members first</p>';
                    return;
                }

                userSelection.innerHTML = this.users.map(user => `
                    <label>
                        <input type="checkbox" value="${user.id}">
                        <span><strong>${user.name}</strong> - ${user.skills}</span>
                    </label>
                `).join('');
            }

            updateProjectSelection() {
                const projectSelect = document.getElementById('promptProject');
                if (!projectSelect) {
                    return;
                }

                projectSelect.innerHTML = '<option value="">Choose a project...</option>' +
                    this.projects.map(project => `<option value="${project.id}">${project.name}</option>`).join('');

                // Add change listener to send setActiveProject message
                projectSelect.onchange = (e) => {
                    const selectedProjectId = e.target.value;
                    
                    // BUG FIX: We removed "if (selectedProjectId)" 
                    // We MUST send the message even if it is empty string (""), 
                    // so the backend knows to clear the active project.
                    vscode.postMessage({
                        type: 'setActiveProject',
                        payload: { projectId: selectedProjectId }
                    });
                };

                // Request workspace info after projects are loaded to enable auto-restoration
                requestWorkspaceInfo();
            }

            getActiveProjectIdForJira() {
                const projectSelect = document.getElementById('promptProject');
                const selectedId = projectSelect?.value?.trim();
                if (selectedId) {
                    return selectedId;
                }
                if (this.latestAiProjectId) {
                    return this.latestAiProjectId;
                }
                if (this.projects.length === 1) {
                    return this.projects[0].id;
                }
                return null;
            }

            getProjectMembersForJira(projectId) {
                if (!projectId) {
                    return [];
                }
                const project = this.projects.find(p => String(p.id) === String(projectId));
                if (!project || !Array.isArray(project.selectedMemberIds)) {
                    return [];
                }
                const memberIdSet = new Set(project.selectedMemberIds.map(id => String(id)));
                return this.users.filter(user => memberIdSet.has(String(user.id)));
            }

            getAllProjectMembersForJira() {
                const memberProjectMap = new Map();
                this.projects.forEach(project => {
                    const projectName = project.name || 'Project';
                    (project.selectedMemberIds || []).forEach(memberId => {
                        const member = this.users.find(u => String(u.id) === String(memberId));
                        if (!member) {
                            return;
                        }
                        const key = String(member.id);
                        const entry = memberProjectMap.get(key) || { member, projectNames: new Set() };
                        entry.projectNames.add(projectName);
                        memberProjectMap.set(key, entry);
                    });
                });
                return Array.from(memberProjectMap.values()).map(entry => ({
                    member: entry.member,
                    projectNames: Array.from(entry.projectNames)
                }));
            }

            getJiraAssigneeOptions() {
                const activeProjectId = this.getActiveProjectIdForJira();
                const projectMembers = this.getProjectMembersForJira(activeProjectId);
                const allProjectMembers = this.getAllProjectMembersForJira();
                const activeMemberIds = new Set(projectMembers.map(member => String(member.id)));
                const optionsByKey = new Map(); // key is email (lower) or accountId when email is missing

                const addCandidate = (user, projectNames = [], markAsProjectMember = false) => {
                    const email = user?.jiraEmail || user?.email || '';
                    const accountId = user?.accountId || user?.jiraAccountId || '';
                    if (!email && !accountId) {
                        return; // Need at least one identifier
                    }
                    const key = email ? email.toLowerCase() : `acct:${accountId.toLowerCase()}`;
                    if (!optionsByKey.has(key)) {
                        optionsByKey.set(key, {
                            email,
                            accountId,
                            name: user?.name || user?.displayName || email || accountId,
                            projectNames: new Set(projectNames),
                            isProjectMember: markAsProjectMember
                        });
                    } else {
                        const entry = optionsByKey.get(key);
                        projectNames.forEach(p => entry.projectNames.add(p));
                        entry.isProjectMember = entry.isProjectMember || markAsProjectMember;
                        if (entry.name === (entry.email || entry.accountId) && (user?.name || user?.displayName)) {
                            entry.name = user.name || user.displayName;
                        }
                        // Prefer email if it arrives later
                        if (!entry.email && email) {
                            entry.email = email;
                        }
                        if (!entry.accountId && accountId) {
                            entry.accountId = accountId;
                        }
                    }
                };

                projectMembers.forEach(member => addCandidate(member, [this.getProjectNameById(activeProjectId)], true));
                allProjectMembers.forEach(entry => {
                    addCandidate(entry.member, entry.projectNames, entry.projectNames.length > 0);
                });
                this.users.forEach(user => addCandidate(user, [], activeMemberIds.has(String(user.id))));
                if (this.currentUser) {
                    addCandidate({
                        id: this.currentUser.id,
                        name: this.currentUser.name,
                        jiraEmail: this.currentUser.jiraEmail || '',
                        email: this.currentUser.jiraEmail || '',
                        accountId: this.currentUser.jiraAccountId || ''
                    }, [], activeMemberIds.has(String(this.currentUser.id)));
                }

                // Jira assignable users fetched from the project
                (this.jiraAssignableEmails || []).forEach(entry => {
                    addCandidate(
                        { name: entry.name || entry.displayName || entry.email || entry.accountId, jiraEmail: entry.email, email: entry.email, accountId: entry.accountId },
                        [],
                        true
                    );
                });

                return Array.from(optionsByKey.values()).map(entry => ({
                    email: entry.email,
                    accountId: entry.accountId,
                    name: entry.name,
                    projectNames: Array.from(entry.projectNames),
                    isProjectMember: entry.isProjectMember
                }));
            }

            refreshJiraAssigneeDropdown() {
                const assigneeSelect = document.getElementById('jiraDetailAssignee');
                if (!assigneeSelect) return;

                const currentAssignee = this.jiraSelectedTask?.assignee || null;
                const selectedOption = assigneeSelect.selectedOptions?.[0];
                const rawSelectedValue = assigneeSelect.value || '';
                const currentAssigneeEmail =
                    selectedOption?.getAttribute('data-email') ||
                    (this.looksLikeEmail(rawSelectedValue) ? rawSelectedValue : '') ||
                    currentAssignee?.email ||
                    '';
                const currentAssigneeAccountId =
                    selectedOption?.getAttribute('data-account-id') ||
                    (!this.looksLikeEmail(rawSelectedValue) && rawSelectedValue ? rawSelectedValue : '') ||
                    currentAssignee?.accountId ||
                    '';
                const currentAssigneeLabel = this.getJiraAssigneeLabel(currentAssignee);
                const assigneeOptions = this.getJiraAssigneeOptions();
                const enrichedAssigneeOptions = [...assigneeOptions];
                const assigneeExists = assigneeOptions.some(option =>
                    (currentAssigneeEmail && option.email === currentAssigneeEmail) ||
                    (currentAssigneeAccountId && option.accountId === currentAssigneeAccountId)
                );

                if ((currentAssigneeEmail || currentAssigneeAccountId) && !assigneeOptions.some(option =>
                    (currentAssigneeEmail && option.email === currentAssigneeEmail) ||
                    (currentAssigneeAccountId && option.accountId === currentAssigneeAccountId)
                )) {
                    enrichedAssigneeOptions.unshift({
                        email: currentAssigneeEmail,
                        accountId: currentAssigneeAccountId,
                        name: currentAssigneeLabel || currentAssigneeEmail,
                        projectNames: [],
                        isProjectMember: false
                    });
                }

                const options = [
                    `<option value="" ${!currentAssigneeEmail && !currentAssigneeAccountId ? 'selected' : ''}>Unassigned</option>`,
                ];

                if (!assigneeExists && !currentAssigneeEmail && currentAssignee) {
                    options.push(`<option value="${currentAssigneeAccountId || ''}" data-email="${currentAssigneeEmail}" data-account-id="${currentAssigneeAccountId || ''}" selected>${currentAssigneeLabel} (view only)</option>`);
                }

                options.push(
                    ...enrichedAssigneeOptions.map(option => {
                        const projectsLabel = option.projectNames && option.projectNames.length
                            ? ` â€” ${option.projectNames.join(', ')}`
                            : '';
                        const identifier = option.email || option.accountId || '';
                        const labelId = option.email ? `(${option.email})` : '';
                        const label = `${option.name} ${labelId}${projectsLabel}${option.isProjectMember ? ' â€” Project teammate' : ''}`;
                        const isSelected =
                            (currentAssigneeEmail && option.email && currentAssigneeEmail === option.email) ||
                            (!currentAssigneeEmail && currentAssigneeAccountId && option.accountId && currentAssigneeAccountId === option.accountId);
                        return `<option value="${identifier}" data-email="${option.email || ''}" data-account-id="${option.accountId || ''}" ${isSelected ? 'selected' : ''}>${label}</option>`;
                    })
                );

                assigneeSelect.innerHTML = options.join('');
            }

            removeUser(userId) {
                this.users = this.users.filter(user => user.id != userId);
                // Also remove this user from any projects they might be assigned to
                this.projects.forEach(project => {
                    project.selectedMemberIds = project.selectedMemberIds.filter(memberId => memberId != userId);
                });
                this.saveData();
                this.updateUI();
                showStatus('userStatus', 'Team member removed successfully!', 'success');
            }

            removeProject(projectId) {
                // This method is kept for backward compatibility but now calls backend
                const project = this.projects.find(p => p.id === projectId);
                if (!project) return;

                const currentUserId = this.currentUser ? String(this.currentUser.id) : null;
                const projectOwnerId = project.owner_id ? String(project.owner_id) : null;
                const isOwner = currentUserId && projectOwnerId && currentUserId === projectOwnerId;

                if (isOwner) {
                    // Owner deletes the project
                    vscode.postMessage({
                        type: 'deleteProject',
                        payload: { projectId }
                    });
                } else {
                    // Non-owner leaves the project
                    vscode.postMessage({
                        type: 'leaveProject',
                        payload: { projectId }
                    });
                }
            }

            openEditModal(projectId) {
                const project = this.projects.find(p => p.id === projectId);
                if (!project) return;

                const currentUserId = this.currentUser ? String(this.currentUser.id) : null;
                const projectOwnerId = project.owner_id ? String(project.owner_id) : null;
                const isOwner = currentUserId && projectOwnerId && currentUserId === projectOwnerId;

                // Populate form
                document.getElementById('editProjectId').value = project.id;
                document.getElementById('editProjectName').value = project.name;
                document.getElementById('editProjectDescription').value = project.description || '';
                document.getElementById('editProjectGoals').value = project.goals || '';
                document.getElementById('editProjectRequirements').value = project.requirements || '';

                // Populate members list (only show if owner)
                const membersSection = document.getElementById('memberManagementSection');
                const membersContainer = document.getElementById('editProjectMembers');

                if (isOwner) {
                    membersSection.style.display = 'block';
                    // Create a set of valid user IDs for efficient lookup
                    const validUserIds = new Set(this.users.map(u => String(u.id)));
                    // Filter to only valid member IDs and then get corresponding users
                    const validMemberIds = (project.selectedMemberIds || []).filter(id => validUserIds.has(String(id)));
                    const teamMembers = this.users.filter(user => validMemberIds.includes(String(user.id)));
                    membersContainer.innerHTML = teamMembers.map(member => `
                        <div style="display: flex; justify-content: space-between; align-items: center; padding: 10px; margin: 5px 0; background: #f1f5f9; border-radius: 8px;">
                            <div>
                                <strong>${member.name}</strong>
                                ${String(member.id) === String(project.owner_id) ? '<span style="background: #10b981; color: white; padding: 2px 6px; border-radius: 12px; font-size: 0.7rem; margin-left: 8px;">Owner</span>' : ''}
                            </div>
                            ${String(member.id) !== String(project.owner_id) ? `<button class="btn remove-member-btn" data-project-id="${project.id}" data-member-id="${member.id}" style="padding: 4px 8px; font-size: 0.75rem; background: #ef4444; color: white; border: none; border-radius: 4px; cursor: pointer;">Remove</button>` : ''}
                        </div>
                    `).join('');
                } else {
                    membersSection.style.display = 'none';
                }

                // Show modal
                document.getElementById('editProjectModal').style.display = 'block';
            }

            closeEditModal() {
                const modal = document.getElementById('editProjectModal');
                if (modal) {
                    modal.style.display = 'none';
                }
            }
        }

        // === GLOBAL TIMELINE FUNCTIONS - ADD THESE ===
        
        window.openFileTimeline = function(filePath, fileName) {
            console.log('Opening timeline for:', filePath);
            
            const timelineList = document.getElementById('timelineList');
            const viewer = document.getElementById('timelineViewer');
            const fileNameDisplay = document.getElementById('timelineFileName');
            
            if (!viewer || !timelineList || !fileNameDisplay) {
                console.error('Timeline elements not found');
                return;
            }
            
            // Hide file list, show viewer
            timelineList.style.display = 'none';
            viewer.style.display = 'block';
            viewer.classList.add('active');
            
            // Update header
            fileNameDisplay.textContent = `ðŸ“„ ${fileName}`;
            
            // Show loading state
            const pointsContainer = document.getElementById('timelinePoints');
            if (pointsContainer) {
                pointsContainer.innerHTML = '<p style="text-align: center; color: #64748b; padding: 20px;">Loading timeline...</p>';
            }
            
            // Request timeline data from extension
            vscode.postMessage({ 
                type: 'getFileTimeline', 
                payload: { filePath } 
            });
        };

        window.closeTimelineViewer = function() {
            console.log('Closing timeline viewer');
            
            const viewer = document.getElementById('timelineViewer');
            const list = document.getElementById('timelineList');
            
            if (!viewer || !list) {
                console.error('Timeline elements not found');
                return;
            }
            
            viewer.classList.remove('active');
            viewer.style.display = 'none';
            list.style.display = 'block';
        };

        function displayTimelinePoints(timelineData) {
            const pointsContainer = document.getElementById('timelinePoints');
            const pointCountBadge = document.getElementById('timelinePointCount');
            
            if (!pointsContainer) {
                console.error('Timeline points container not found');
                return;
            }
            
            if (!timelineData || timelineData.length === 0) {
                pointsContainer.innerHTML = `
                    <div class="timeline-empty">
                        <div class="timeline-empty-icon">ðŸ“­</div>
                        <p>No timeline history available for this file</p>
                    </div>
                `;
                if (pointCountBadge) {
                    pointCountBadge.textContent = '0 points';
                }
                return;
            }
            
            // Update point count
            if (pointCountBadge) {
                pointCountBadge.textContent = `${timelineData.length} points`;
            }
            
            // Create timeline line
            let html = '<div class="timeline-line"></div>';
            
            // Add timeline points
            timelineData.forEach(point => {
                const isMajor = point.changeType === 'major';
                const timeAgo = formatTimeAgo(point.timestamp);
                
                // Get category badge info
                const categoryInfo = {
                    feature: { label: 'FEATURE', color: '#10b981' },
                    bugfix: { label: 'BUG FIX', color: '#ef4444' },
                    refactor: { label: 'REFACTOR', color: '#3b82f6' },
                    style: { label: 'STYLE', color: '#8b5cf6' },
                    docs: { label: 'DOCS', color: '#f59e0b' },
                    test: { label: 'TEST', color: '#06b6d4' }
                };

                const category = categoryInfo[point.category] || categoryInfo.feature;

                html += `
                    <div class="timeline-item" data-point-id="${point.id}">
                        <div class="timeline-dot ${isMajor ? 'major' : ''}"></div>
                        <div class="timeline-content">
                            <div class="timeline-time">${timeAgo}</div>
                            <div class="timeline-description">
                                <span class="timeline-category-badge" style="background-color: ${category.color}">
                                    ${category.label}
                                </span>
                                ${point.description}
                                ${isMajor ? '<span class="timeline-badge">MAJOR</span>' : ''}
                            </div>
                            ${point.changeTypes && point.changeTypes.length > 0 ? `
                                <div class="timeline-change-types">
                                    ${point.changeTypes.map(ct => `
                                        <div class="change-type-item">â€¢ ${ct}</div>
                                    `).join('')}
                                </div>
                            ` : ''}
                            
                            <div class="timeline-stats">
                                <span class="timeline-stat added">+${point.linesAdded} lines</span>
                                <span class="timeline-stat removed">-${point.linesRemoved} lines</span>
                            </div>
                        </div>
                    </div>
                `;
            });
            
            pointsContainer.innerHTML = html;

            // Attach click listeners to timeline items
            document.querySelectorAll('.timeline-item').forEach(item => {
                item.addEventListener('click', function() {
                    const pointId = this.getAttribute('data-point-id');
                    if (pointId) {
                        viewTimelinePoint(pointId);
                    }
                });
            });
        }

        function formatTimeAgo(timestamp) {
            const now = new Date();
            const then = new Date(timestamp);
            const diffMs = now - then;
            const diffMins = Math.floor(diffMs / 60000);
            const diffHours = Math.floor(diffMs / 3600000);
            const diffDays = Math.floor(diffMs / 86400000);
            
            if (diffMins < 1) return 'Just now';
            if (diffMins < 60) return `${diffMins} minute${diffMins > 1 ? 's' : ''} ago`;
            if (diffHours < 24) return `${diffHours} hour${diffHours > 1 ? 's' : ''} ago`;
            if (diffDays < 7) return `${diffDays} day${diffDays > 1 ? 's' : ''} ago`;
            
            return then.toLocaleDateString();
        }

        function viewTimelinePoint(pointId) {
            console.log('ðŸ‘ï¸ Requesting timeline point:', pointId);
            vscode.postMessage({ 
                type: 'viewTimelinePoint', 
                payload: { pointId } 
            });
        }

        function showDiffViewer(point) {
            console.log('ðŸ“Š Showing diff viewer for point:', point.id);
            
            const modal = document.getElementById('diffViewerModal');
            const title = document.getElementById('diffViewerTitle');
            const body = document.getElementById('diffViewerBody');
            
            if (!modal || !title || !body) {
                console.error('Diff viewer elements not found');
                return;
            }
            
            // Update title
            title.textContent = `ðŸ“ ${point.description} - ${point.details}`;
            
            // Calculate stats
            const linesBefore = point.codeBefore.split('\n').length;
            const linesAfter = point.codeAfter.split('\n').length;
            const netChange = linesAfter - linesBefore;
            
            // Format timestamp
            const date = new Date(point.timestamp);
            const timeStr = date.toLocaleString();
            
            // Build diff viewer content
            let html = `
                <div class="diff-info">
                    <p><strong>File:</strong> ${point.filePath}</p>
                    <p><strong>When:</strong> ${timeStr}</p>
                    <p><strong>Trigger:</strong> ${(point.trigger_type || point.trigger || 'unknown').replace(/_/g, ' ')}</p>
                </div>

                <div class="diff-stats">
                    <div class="diff-stat added">
                        <span class="diff-stat-icon">+</span>
                        <span>${point.linesAdded} lines added</span>
                    </div>
                    <div class="diff-stat removed">
                        <span class="diff-stat-icon">âˆ’</span>
                        <span>${point.linesRemoved} lines removed</span>
                    </div>
                    <div class="diff-stat">
                        <span class="diff-stat-icon">ðŸ“Š</span>
                        <span>Net: ${netChange > 0 ? '+' : ''}${netChange} lines</span>
                    </div>
                </div>

                <div class="diff-comparison">
                    <div class="diff-panel">
                        <div class="diff-panel-header before">âŒ Before</div>
                        <div class="diff-code">
                            ${point.codeBefore ? escapeHtml(point.codeBefore) : '<div class="diff-empty">File was just created</div>'}
                        </div>
                    </div>
                    
                    <div class="diff-panel">
                        <div class="diff-panel-header after">âœ… After</div>
                        <div class="diff-code">
                            ${point.codeAfter ? escapeHtml(point.codeAfter) : '<div class="diff-empty">No content</div>'}
                        </div>
                    </div>
                </div>
            `;
            
            body.innerHTML = html;
            modal.classList.add('active');
        }

        function closeDiffViewer() {
            const modal = document.getElementById('diffViewerModal');
            if (modal) {
                modal.classList.remove('active');
            }
        }

        function escapeHtml(text) {
            const div = document.createElement('div');
            div.textContent = text;
            return div.innerHTML;
        }

        function refreshWorkspaceFiles() {
            vscode.postMessage({ type: 'getWorkspaceFiles' });
            const status = document.getElementById('timelineStatus');
            if (status) {
                status.textContent = 'Refreshing files...';
                status.className = 'status-message';
                status.style.display = 'block';
                setTimeout(() => { status.style.display = 'none'; }, 2000);
            }
        }

        function clearTimelineFilters() {
            document.getElementById('timelineSearch').value = '';
            document.getElementById('timelineFilter').value = '';
            app.filteredFiles = [...app.workspaceFiles];
            app.updateTimelineList();
            app.updateFileCount();
        }

        function updateFileCount() {
            const fileCount = document.getElementById('fileCount');
            if (fileCount && app.filteredFiles) {
                fileCount.textContent = `(${app.filteredFiles.length} files)`;
            }
        }

        // === END GLOBAL TIMELINE FUNCTIONS ===

        // Global app instance
        const app = new TeamCollaborationApp();

        // Render AI Analysis Visualization
        function renderAnalysisVisualization(data, projectName) {
            if (!data) return '<p>No analysis data available</p>';

            let html = `<div style="margin-bottom: 15px;">
                <h2 style="color: #1e293b; font-size: 1.3rem; margin-bottom: 3px;">${projectName || 'Project'} Analysis</h2>
                <p style="color: #64748b; font-size: 0.8rem;">AI-powered team analysis and task delegation</p>
            </div>`;

            // Team Analysis Section (Collapsible)
            if (data.teamAnalysis) {
                const gapsCount = data.teamAnalysis.gaps?.length || 0;
                html += `<details class="analysis-details" open>
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ‘¥ Team Analysis</span>
                        ${gapsCount > 0 ? `<span class="summary-badge warning">${gapsCount} gap${gapsCount > 1 ? 's' : ''}</span>` : '<span class="summary-badge success">âœ“ Balanced</span>'}
                    </summary>
                    <div class="analysis-content">
                        ${data.teamAnalysis.summary ? `<p style="margin-bottom: 12px; line-height: 1.5; font-size: 0.85rem; color: #1e293b;">${data.teamAnalysis.summary}</p>` : ''}
                    ${data.teamAnalysis.gaps && data.teamAnalysis.gaps.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #dc2626; font-size: 0.8rem;">Skill Gaps:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.teamAnalysis.gaps.map(gap => `<li style="margin: 4px 0; color: #475569;">${gap}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    </div>
                </details>`;
            }

            // Feasibility Section (Collapsible)
            if (data.feasibility) {
                const isFeasible = data.feasibility.isFeasible !== false;
                const challengesCount = data.feasibility.challenges?.length || 0;
                html += `<details class="analysis-details" open>
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸŽ¯ Project Feasibility</span>
                        <span class="summary-badge ${isFeasible ? 'success' : 'warning'}">${isFeasible ? 'âœ“ Feasible' : 'âš  Attention'}</span>
                        ${challengesCount > 0 ? `<span class="summary-badge info">${challengesCount} challenge${challengesCount > 1 ? 's' : ''}</span>` : ''}
                    </summary>
                    <div class="analysis-content">
                        ${data.feasibility.assessment ? `<p style="margin-bottom: 10px; line-height: 1.5; font-size: 0.85rem; color: #1e293b;">${data.feasibility.assessment}</p>` : ''}
                    ${data.feasibility.challenges && data.feasibility.challenges.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #f59e0b; font-size: 0.8rem;">Challenges:</strong>
                            ${data.feasibility.challenges.map(challenge => `
                                    <div style="padding: 8px 10px; background: #fef3c7; border-radius: 4px; margin-top: 6px; font-size: 0.8rem; color: #92400e; border-left: 2px solid #f59e0b;">${challenge}</div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${data.feasibility.timeline ? `
                            <div style="margin-top: 10px; padding: 8px 10px; background: #dbeafe; border-radius: 4px; border-left: 2px solid #3b82f6; font-size: 0.8rem; color: #1e40af;">
                            <strong>Timeline:</strong> ${data.feasibility.timeline}
                        </div>
                    ` : ''}
                    </div>
                </details>`;
            }

            // Role Assignments Section (Collapsible with member count)
            if (data.roleAssignments && data.roleAssignments.length > 0) {
                html += `<details class="analysis-details" open>
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ‘¤ Role Assignments & Tasks</span>
                        <span class="summary-badge info">${data.roleAssignments.length} member${data.roleAssignments.length > 1 ? 's' : ''}</span>
                    </summary>
                    <div class="analysis-content">
                    ${data.roleAssignments.map(member => `
                            <div class="member-card-compact">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;">
                                    <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem;">${member.memberName || 'Team Member'}</div>
                                    <div style="font-size: 0.75rem; padding: 3px 8px; background: #e0e7ff; color: #3730a3; border-radius: 3px; font-weight: 600;">${member.role || 'Team Member'}</div>
                            </div>
                            ${member.tasks && (member.tasks.immediate && member.tasks.immediate.length > 0 || member.tasks.future && member.tasks.future.length > 0) ? `
                                ${member.tasks.immediate && member.tasks.immediate.length > 0 ? `
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 0.75rem; font-weight: 600; color: #059669; margin-bottom: 4px;">ðŸš€ Immediate Tasks</div>
                                            <ul style="margin: 0; padding-left: 18px; font-size: 0.8rem;">
                                                ${member.tasks.immediate.map(task => `<li style="margin: 3px 0; color: #475569;">${task}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                                ${member.tasks.future && member.tasks.future.length > 0 ? `
                                        <div style="margin-bottom: 10px;">
                                            <div style="font-size: 0.75rem; font-weight: 600; color: #3b82f6; margin-bottom: 4px;">ðŸ“… Future Tasks</div>
                                            <ul style="margin: 0; padding-left: 18px; font-size: 0.8rem;">
                                                ${member.tasks.future.map(task => `<li style="margin: 3px 0; color: #475569;">${task}</li>`).join('')}
                                        </ul>
                                    </div>
                                ` : ''}
                            ` : ''}
                            ${member.responsibilities && member.responsibilities.length > 0 ? `
                                    <div style="margin-bottom: 10px;">
                                        <div style="font-size: 0.75rem; font-weight: 600; color: #64748b; margin-bottom: 4px;">ðŸ“‹ Responsibilities</div>
                                        <ul style="margin: 0; padding-left: 18px; font-size: 0.8rem;">
                                            ${member.responsibilities.map(resp => `<li style="margin: 3px 0; color: #475569;">${resp}</li>`).join('')}
                                    </ul>
                                </div>
                            ` : ''}
                            ${member.collaboration ? `
                                    <div style="padding: 6px 8px; background: #fef3c7; border-radius: 3px; border-left: 2px solid #f59e0b; font-size: 0.75rem; color: #92400e;">
                                    <strong>ðŸ¤ Collaboration:</strong> ${member.collaboration}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                    </div>
                </details>`;
            }

            // Optimization Section (Collapsible)
            if (data.optimization) {
                const recsCount = data.optimization.recommendations?.length || 0;
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">âš¡ Optimization Recommendations</span>
                        ${recsCount > 0 ? `<span class="summary-badge info">${recsCount} tip${recsCount > 1 ? 's' : ''}</span>` : ''}
                    </summary>
                    <div class="analysis-content">
                    ${data.optimization.recommendations && data.optimization.recommendations.length > 0 ? `
                        ${data.optimization.recommendations.map(rec => `
                                <div style="padding: 8px 10px; background: #f0f9ff; border-radius: 4px; margin-bottom: 6px; font-size: 0.8rem; color: #1e40af; border-left: 2px solid #3b82f6;">${rec}</div>
                        `).join('')}
                    ` : ''}
                    ${data.optimization.structure ? `
                            <div style="margin-top: 10px; padding: 8px 10px; background: #f0fdf4; border-radius: 4px; font-size: 0.8rem; color: #166534;">
                            <strong>Project Structure:</strong> ${data.optimization.structure}
                        </div>
                    ` : ''}
                    </div>
                </details>`;
            }

            // Risks Section (Collapsible)
            if (data.risks) {
                const risksCount = data.risks.identified?.length || 0;
                const successCount = data.risks.successFactors?.length || 0;
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">âš ï¸ Risk Assessment</span>
                        ${risksCount > 0 ? `<span class="summary-badge warning">${risksCount} risk${risksCount > 1 ? 's' : ''}</span>` : ''}
                        ${successCount > 0 ? `<span class="summary-badge success">${successCount} success factor${successCount > 1 ? 's' : ''}</span>` : ''}
                    </summary>
                    <div class="analysis-content">
                    ${data.risks.identified && data.risks.identified.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #dc2626; font-size: 0.8rem;">Identified Risks:</strong>
                            ${data.risks.identified.map(risk => `
                                    <div style="padding: 8px 10px; background: #fee2e2; border-radius: 4px; margin-top: 6px; font-size: 0.8rem; color: #7f1d1d; border-left: 2px solid #dc2626;">${risk}</div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${data.risks.mitigation && data.risks.mitigation.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #3b82f6; font-size: 0.8rem;">Mitigation Strategies:</strong>
                            ${data.risks.mitigation.map(mit => `
                                    <div style="padding: 8px 10px; background: #dbeafe; border-radius: 4px; margin-top: 6px; font-size: 0.8rem; color: #1e40af; border-left: 2px solid #3b82f6;">${mit}</div>
                            `).join('')}
                        </div>
                    ` : ''}
                    ${data.risks.successFactors && data.risks.successFactors.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #059669; font-size: 0.8rem;">Critical Success Factors:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.risks.successFactors.map(factor => `<li style="margin: 3px 0; color: #475569;">${factor}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    </div>
                </details>`;
            }

            // Deliverables Section (Collapsible)
            if (data.deliverables && data.deliverables.length > 0) {
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ“¦ Deliverables Mapping</span>
                        <span class="summary-badge info">${data.deliverables.length} deliverable${data.deliverables.length > 1 ? 's' : ''}</span>
                    </summary>
                    <div class="analysis-content">
                    ${data.deliverables.map(deliverable => `
                            <div style="padding: 10px; background: #f8fafc; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #8b5cf6;">
                                <div style="font-weight: 600; color: #1e293b; font-size: 0.85rem; margin-bottom: 4px;">${deliverable.name || 'Deliverable'}</div>
                                ${deliverable.description ? `<div style="font-size: 0.75rem; color: #64748b; margin-bottom: 6px;">${deliverable.description}</div>` : ''}
                                ${deliverable.assignedTo ? `<div style="font-size: 0.75rem; color: #475569;"><strong>Assigned to:</strong> ${deliverable.assignedTo}</div>` : ''}
                                ${deliverable.timeline ? `<div style="font-size: 0.75rem; color: #475569;"><strong>Timeline:</strong> ${deliverable.timeline}</div>` : ''}
                        </div>
                    `).join('')}
                    </div>
                </details>`;
            }

            // ============================================================================
            // PROGRESS MODE SECTIONS (Agentic Analysis)
            // ============================================================================

            // Summary Section (if available)
            if (data.summary) {
                html += `<div class="analysis-section" style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-left: 4px solid #3b82f6;">
                    <h3>ðŸ“‹ Analysis Summary</h3>
                    <p style="line-height: 1.8; white-space: pre-wrap; margin: 0;">${data.summary}</p>
                </div>`;
            }

            // Completion Status Section
            if (data.completionStatus) {
                const percent = data.completionStatus.percentComplete || 0;
                html += `<div class="analysis-section">
                    <h3>ðŸ“Š Completion Status</h3>
                    <div style="margin-bottom: 20px;">
                        <div style="display: flex; align-items: center; margin-bottom: 10px;">
                            <div style="flex: 1; background: #e2e8f0; border-radius: 8px; height: 24px; overflow: hidden;">
                                <div style="background: linear-gradient(90deg, #10b981, #059669); height: 100%; width: ${percent}%; transition: width 0.3s;"></div>
                            </div>
                            <span style="margin-left: 12px; font-weight: 600; color: #10b981; font-size: 1.1rem;">${percent}%</span>
                        </div>
                        ${data.completionStatus.completedAreas && data.completionStatus.completedAreas.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong style="color: #10b981;">âœ“ Completed:</strong>
                                <ul style="margin-top: 8px; padding-left: 20px;">
                                    ${data.completionStatus.completedAreas.map(area => `<li style="margin: 5px 0;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.completionStatus.inProgress && data.completionStatus.inProgress.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong style="color: #3b82f6;">â³ In Progress:</strong>
                                <ul style="margin-top: 8px; padding-left: 20px;">
                                    ${data.completionStatus.inProgress.map(area => `<li style="margin: 5px 0;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.completionStatus.notStarted && data.completionStatus.notStarted.length > 0 ? `
                            <div style="margin-top: 15px;">
                                <strong style="color: #94a3b8;">â—‹ Not Started:</strong>
                                <ul style="margin-top: 8px; padding-left: 20px;">
                                    ${data.completionStatus.notStarted.map(area => `<li style="margin: 5px 0;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </div>`;
            }

            // Code Quality Section
            if (data.codeQuality) {
                const score = data.codeQuality.overallScore || 5;
                const scoreColor = score >= 8 ? '#10b981' : score >= 6 ? '#3b82f6' : score >= 4 ? '#f59e0b' : '#ef4444';
                html += `<div class="analysis-section">
                    <h3>âœ¨ Code Quality</h3>
                    <div style="display: flex; align-items: center; margin-bottom: 15px;">
                        <span style="font-size: 2rem; font-weight: bold; color: ${scoreColor};">${score}/10</span>
                        <span style="margin-left: 10px; color: #cbd5e1;">Overall Score</span>
                    </div>
                    ${data.codeQuality.strengths && data.codeQuality.strengths.length > 0 ? `
                        <div style="margin-bottom: 15px;">
                            <strong style="color: #10b981;">Strengths:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${data.codeQuality.strengths.map(s => `<li style="margin: 5px 0;">${s}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                    ${data.codeQuality.concerns && data.codeQuality.concerns.length > 0 ? `
                        <div>
                            <strong style="color: #f59e0b;">Concerns:</strong>
                            <ul style="margin-top: 8px; padding-left: 20px;">
                                ${data.codeQuality.concerns.map(c => `<li style="margin: 5px 0;">${c}</li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                </div>`;
            }

            // Team Performance Section
            if (data.teamPerformance && data.teamPerformance.length > 0) {
                html += `<div class="analysis-section">
                    <h3>ðŸ‘¥ Team Performance</h3>
                    ${data.teamPerformance.map(member => `
                        <div class="member-card">
                            <div class="member-header">
                                <div class="member-name">${member.memberName || 'Team Member'}</div>
                            </div>
                            ${member.contributions ? `
                                <div style="margin-top: 10px;">
                                    <strong style="color: #10b981;">Contributions:</strong>
                                    <p style="margin: 5px 0; line-height: 1.6;">${member.contributions}</p>
                                </div>
                            ` : ''}
                            ${member.suggestions ? `
                                <div style="margin-top: 10px;">
                                    <strong style="color: #3b82f6;">Suggestions:</strong>
                                    <p style="margin: 5px 0; line-height: 1.6;">${member.suggestions}</p>
                                </div>
                            ` : ''}
                            ${member.supportNeeded ? `
                                <div style="margin-top: 10px; padding: 10px; background: #fef3c7; border-radius: 6px; border-left: 4px solid #f59e0b;">
                                    <strong style="color: #f59e0b;">Support Needed:</strong>
                                    <p style="margin: 5px 0; line-height: 1.6;">${member.supportNeeded}</p>
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>`;
            }

            // Blockers Section
            if (data.blockers && data.blockers.length > 0) {
                html += `<div class="analysis-section">
                    <h3>ðŸš§ Blockers</h3>
                    ${data.blockers.map(blocker => `
                        <div class="risk-item" style="background: #fee2e2; border-left-color: #ef4444;">
                            <strong>${blocker.issue || 'Issue'}</strong>
                            ${blocker.affectedMembers && blocker.affectedMembers.length > 0 ? `
                                <p style="margin: 8px 0 0 0; color: #cbd5e1;">Affected: ${blocker.affectedMembers.join(', ')}</p>
                            ` : ''}
                            ${blocker.suggestedSolution ? `
                                <div style="margin-top: 8px; padding: 8px; background: #dbeafe; border-radius: 4px;">
                                    <strong style="color: #3b82f6;">Suggested Solution:</strong> ${blocker.suggestedSolution}
                                </div>
                            ` : ''}
                        </div>
                    `).join('')}
                </div>`;
            }

            // Next Priorities Section
            if (data.nextPriorities && data.nextPriorities.length > 0) {
                html += `<div class="analysis-section">
                    <h3>ðŸŽ¯ Next Priorities</h3>
                    <div style="display: flex; flex-direction: column; gap: 12px;">
                        ${data.nextPriorities.map((priority, idx) => `
                            <div style="padding: 15px; background: #334155; border-left: 4px solid #6366f1; border-radius: 8px;">
                                <div style="font-weight: 600; color: #ffffff; margin-bottom: 5px;">${idx + 1}. ${priority.priority || 'Priority'}</div>
                                ${priority.assignTo ? `<p style="margin: 5px 0; color: #cbd5e1;">ðŸ‘¤ Assigned to: ${priority.assignTo}</p>` : ''}
                                ${priority.reasoning ? `<p style="margin: 5px 0; color: #cbd5e1;">ðŸ’¡ ${priority.reasoning}</p>` : ''}
                            </div>
                        `).join('')}
                    </div>
                </div>`;
            }

            return html;
        }

        // Listen to messages from VS Code extension
        window.addEventListener('message', event => {
            const message = event.data;
            switch (message.type) {
                case 'requestData':
                    vscode.postMessage({ type: 'loadData' });
                    break;
                case 'dataLoaded':
                    try {
                        app.loadData(message.payload); // This will re-render everything
                    } catch (error) {
                        console.error('Error handling dataLoaded message:', error);
                        showStatus('userStatus', 'Error loading data. Please try again.', 'error');
                    }
                    break;
                case 'profileUpdated':
                    showStatus('userStatus', 'âœ… Profile updated successfully!', 'success');
                    // Reload data to get fresh profile
                    vscode.postMessage({ type: 'loadData' });
                    break;
                case 'profileUpdateError':
                    showStatus('userStatus', `âŒ Error: ${message.payload.message}`, 'error');
                    break;
                case 'jiraCreated':
                    showStatus('jiraStatus', message.payload?.message || 'âœ… Jira tasks created!', 'success');
                    app.unlockJiraTab(true);
                    break;
                case 'jiraError':
                    showStatus('jiraStatus', `âŒ ${message.payload?.message || 'Failed to create Jira tasks.'}`, 'error');
                    break;
                case 'jiraAssignableLoaded':
                    app.jiraAssignableEmails = message.payload?.users || [];
                    app.renderAssignableEmails();
                    app.refreshJiraAssigneeDropdown(); // Update the assignee dropdown with freshly fetched Jira users
                    break;
                case 'jiraAssignableError':
                    showStatus('jiraStatus', `âŒ ${message.payload?.message || 'Failed to load assignable users.'}`, 'error');
                    break;
                case 'promptGeneratedFromExtension': // NEW: Listen for generated prompt from extension
                    document.getElementById('promptOutput').textContent = message.payload.prompt;
                    showStatus('promptStatus', 'ðŸ¤– AI Prompt generated! See editor for markdown.', 'success');
                    break;
                case 'aiResponseReceived': // NEW: Handle AI response with task delegation
                    setPromptLoading(false); // restore button + cursor
                    
                    // Complete terminal display
                    addTerminalLine('Analysis complete', 'success', 'DONE');
                    completeTerminal(true);
                    
                    const promptOutput = document.getElementById('promptOutput');
                    const visualization = document.getElementById('aiAnalysisVisualization');
                    const resultsSection = document.getElementById('results-section');
                    const { parsed, projectId } = message.payload;

                    if (projectId && parsed) {
                        app.storeAiAnalysis(projectId, parsed);
                    }

                    if (parsed) {
                        // Hide terminal after a moment, show results section
                        setTimeout(() => {
                        if (promptOutput) {
                            promptOutput.style.display = 'none';
                        }
                        }, 2000);
                        
                        if (resultsSection) {
                            resultsSection.style.display = 'block';
                        }
                        
                        if (visualization) {
                            visualization.style.display = 'block';
                            
                            // Determine analysis type badge
                            const isProgressUpdate = parsed.completionStatus || parsed.codeQuality || parsed.teamPerformance;
                            const mode = message.payload.mode || 'initial';
                            const typeBadge = (mode === 'progress' || isProgressUpdate)
                                ? '<span style="display: inline-block; padding: 3px 10px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 10px;">Progress Update</span>'
                                : '<span style="display: inline-block; padding: 3px 10px; background: #ede9fe; color: #6b21a8; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 10px;">Initial Planning</span>';
                            
                            // Add RAG indicator if used
                            let ragBadge = '';
                            if (message.payload.ragUsed && message.payload.ragStats) {
                                ragBadge = `<div style="display: inline-block; padding: 3px 10px; background: #d1fae5; border: 1px solid #10b981; border-radius: 4px; font-size: 0.75rem; color: #065f46; margin-bottom: 10px;">
                                    âœ“ ${message.payload.ragStats.filesUsed} indexed files used
                                </div>`;
                            }
                            
                            // Use minimal light container
                            const projectName = message.payload.projectName || 'Project';
                            let analysisHTML = '';
                            
                            if (mode === 'progress' || isProgressUpdate) {
                                analysisHTML = renderProgressAnalysisVisualization(parsed, projectName);
                            } else {
                                analysisHTML = renderAnalysisVisualization(parsed, projectName);
                            }
                            
                            visualization.innerHTML = `
                                <div style="background: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0;">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                                        <div>
                                            <h3 style="color: #1e293b; margin: 0; font-size: 1.1rem; display: inline-block;">Latest Analysis</h3>
                                            ${typeBadge}
                                        </div>
                                    </div>
                                    ${ragBadge}
                                    ${analysisHTML}
                                </div>
                            `;
                        }
                    } else {
                        // Fallback to text output if no parsed data
                        if (promptOutput) {
                            promptOutput.style.display = 'block';
                            promptOutput.textContent = `${message.payload.prompt}\n\n${"=".repeat(80)}\nAI RESPONSE:\n${"=".repeat(80)}\n\n${message.payload.response}`;
                        }
                        if (visualization) {
                            visualization.style.display = 'none';
                        }
                    }
                    
                    const statusMsg = message.payload.ragUsed 
                        ? `âœ… AI analysis complete with workspace context! (${message.payload.ragStats?.filesUsed} files used)`
                        : 'âœ… AI analysis complete! Tasks delegated to team members.';
                    showStatus('promptStatus', statusMsg, 'success');
                    break;
                case 'promptGenerationError': // NEW: Handle errors from extension
                    setPromptLoading(false); // restore button + cursor
                    addTerminalLine(message.payload.message, 'error', 'ERROR');
                    completeTerminal(false);
                    showStatus('promptStatus', `Error: ${message.payload.message}`, 'error');
                    break;
                
                case 'analysisStatusUpdate': // NEW: Handle real-time status updates
                    const updateMsg = message.payload.message;
                    const statusType = message.payload.type || 'info';
                    const statusIcon = message.payload.icon || '';
                    addTerminalLine(updateMsg, statusType, statusIcon);
                    break;
                
                case 'ragStatsUpdate':
                    console.log('Webview: Received RAG stats:', message.payload);
                    updateRAGStatus(message.payload);
                    updateRAGTooltipContent(message.payload);
                    break;
                
                case 'ragIndexingProgress':
                    const ragStatusBadge = document.getElementById('rag-status-badge');
                    if (ragStatusBadge) {
                        ragStatusBadge.textContent = `Indexing... ${Math.round(message.payload.percent || 0)}%`;
                    }
                    break;
                
                case 'ragIndexingComplete':
                    console.log('Indexing complete:', message.payload);
                    updateRAGStatus(message.payload);
                    showStatus('promptStatus', 'âœ… Workspace indexed successfully!', 'success');
                    const indexBtn = document.getElementById('index-workspace-btn');
                    if (indexBtn) {
                        indexBtn.disabled = false;
                        indexBtn.textContent = 'Re-index';
                    }
                    break;
                
                case 'ragIndexingError':
                    const btn = document.getElementById('index-workspace-btn');
                    if (btn) {
                        btn.textContent = 'Index';
                        btn.disabled = false;
                    }
                    showStatus('promptStatus', `Error: ${message.payload.message}`, 'error');
                    break;
                
                case 'pastAnalysesLoaded':
                    console.log('Past analyses loaded:', message.payload.analyses);
                    displayPastAnalyses(message.payload.analyses);
                    break;
                
                case 'workspaceInfo':
                    handleWorkspaceInfo(message.payload);
                    break;
                
                case 'workspaceLinked':
                    console.log('Workspace linked:', message.payload);
                    currentWorkspaceInfo.linkedProjectId = message.payload.projectId;
                    updateWorkspaceUI();
                    break;
                
                case 'workspaceUnlinked':
                    console.log('Workspace unlinked');
                    currentWorkspaceInfo.linkedProjectId = null;
                    updateWorkspaceUI();
                    break;
                
                case 'workspaceFilesLoaded': {
                    app.loadWorkspaceFiles(message.payload.files);
                    const status = document.getElementById('timelineStatus');
                    if (status) {
                        status.textContent = `âœ… Loaded ${message.payload.files.length} files`;
                        status.className = 'status-message status-success';
                        status.style.display = 'block';
                        setTimeout(() => { status.style.display = 'none'; }, 3000);
                    }
                    break;
                }
                
                case 'workspaceFilesError': {
                    const status = document.getElementById('timelineStatus');
                    if (status) {
                        status.textContent = `âŒ Error: ${message.payload.message}`;
                        status.className = 'status-message status-error';
                        status.style.display = 'block';
                    }
                    break;
                }
                
                case 'timelineDataLoaded': {
                    displayTimelinePoints(message.payload.timeline);
                    break;
                }
                
                case 'timelineError': {
                    const pointsContainer = document.getElementById('timelinePoints');
                    if (pointsContainer) {
                        pointsContainer.innerHTML = `
                            <div class="timeline-empty">
                                <div class="timeline-empty-icon">âš ï¸</div>
                                <p>Error loading timeline: ${message.payload.message}</p>
                            </div>
                        `;
                    }
                    break;
                }

                case 'timelinePointLoaded': {
                    showDiffViewer(message.payload.point);
                    break;
                }

                case 'timelinePointError': {
                    vscode.window.showErrorMessage(message.payload.message);
                    break;
                }
                case 'jiraTasksLoaded': {
                    const requestId = message.payload?.requestId;
                    if (requestId && requestId !== app.jiraActiveRequestId) {
                        console.log('Ignoring stale jiraTasksLoaded response', { requestId, active: app.jiraActiveRequestId });
                        break;
                    }
                    app.jiraLoading = false;
                    const previouslySelectedId = app.jiraSelectedTask?.id || null;
                    app.jiraTasks = message.payload.tasks || [];
                    app.jiraStatuses = message.payload.statuses || [];
                    if (previouslySelectedId) {
                        app.jiraSelectedTask = app.jiraTasks.find((task) => task.id === previouslySelectedId) || null;
                    } else {
                        app.jiraSelectedTask = null;
                    }
                    app.renderJiraBoard();
                    break;
                }
                case 'jiraTasksError': {
                    const requestId = message.payload?.requestId;
                    if (requestId && requestId !== app.jiraActiveRequestId) {
                        console.log('Ignoring stale jiraTasksError response', { requestId, active: app.jiraActiveRequestId });
                        break;
                    }
                    app.jiraLoading = false;
                    app.showJiraStatus(message.payload?.message || 'Failed to load Jira tasks.', 'error');
                    app.renderJiraTaskList();
                    break;
                }
                case 'jiraOperationResult':
                    app.showJiraStatus(message.payload?.message || 'Operation complete.', 'success');
                    app.isCreatingJiraTask = false;
                    // Clear filters to avoid hiding the updated task after status/assignee changes
                    app.jiraFilters = { status: '', search: '' };
                    const statusFilter = document.getElementById('jiraFilterStatus');
                    const searchFilter = document.getElementById('jiraSearchInput');
                    if (statusFilter) statusFilter.value = '';
                    if (searchFilter) searchFilter.value = '';
                    app.loadJiraTasks();
                    break;
                case 'jiraOperationError':
                    app.showJiraStatus(message.payload?.message || 'Operation failed.', 'error');
                    break;
                case 'jiraTransitionsLoaded':
                    if (message.payload?.issueId) {
                        app.jiraTransitions[message.payload.issueId] = message.payload.transitions || [];
                        if (app.jiraSelectedTask && app.jiraSelectedTask.id === message.payload.issueId) {
                            app.renderJiraTaskDetail();
                        }
                    }
                    break;
            }
        });

        // UI Helper Functions
        function showTab(tabName, clickedButton) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });

            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');

            if (clickedButton) {
                clickedButton.classList.add('active');
            }
        }

        function showStatus(elementId, message, type = 'success') {
            const statusElement = document.getElementById(elementId);
            statusElement.textContent = message;
            statusElement.className = 'status-message status-' + type;
            statusElement.style.display = 'block';

            setTimeout(() => {
                statusElement.style.display = 'none';
            }, 5000);

            if (type === 'success') {
                vscode.postMessage({ type: 'showSuccess', payload: { message } });
            } else {
                vscode.postMessage({ type: 'showError', payload: { message } });
            }
        }

        function addUser() {
            try {
                const name = document.getElementById('userName').value.trim();

                // Collect skills from checkboxes
                const selectedSkills = Array.from(document.querySelectorAll('input[name="skills"]:checked'))
                    .map(checkbox => checkbox.value);
                const otherSkills = (document.getElementById('userSkillsOther')?.value || '').trim();
                const allSkills = [...selectedSkills];
                if (otherSkills) {
                    const otherSkillsList = otherSkills.split(',').map(s => s.trim()).filter(s => s);
                    allSkills.push(...otherSkillsList);
                }
                const skills = allSkills.join(', ');

                // Collect languages from checkboxes
                const selectedLanguages = Array.from(document.querySelectorAll('input[name="languages"]:checked'))
                    .map(checkbox => checkbox.value);
                const otherLanguages = (document.getElementById('userLanguagesOther')?.value || '').trim();
                const allLanguages = [...selectedLanguages];
                if (otherLanguages) {
                    const otherLanguagesList = otherLanguages.split(',').map(l => l.trim()).filter(l => l);
                    allLanguages.push(...otherLanguagesList);
                }
                const languages = allLanguages.join(', ');

                const willing = document.getElementById('userWilling').value.trim();

                const user = app.addUser(name, skills, languages, willing);
                clearUserForm();
                showStatus('userStatus', user.name + ' added successfully! Total: ' + app.users.length, 'success');
            } catch (error) {
                showStatus('userStatus', 'Error: ' + error.message, 'error');
            }
        }

        function clearUserForm() {
            document.getElementById('userName').value = '';
            // Clear all skill checkboxes
            document.querySelectorAll('input[name="skills"]').forEach(cb => cb.checked = false);
            document.getElementById('userSkillsOther').value = '';
            // Clear all language checkboxes
            document.querySelectorAll('input[name="languages"]').forEach(cb => cb.checked = false);
            document.getElementById('userLanguagesOther').value = '';
            document.getElementById('userWilling').value = '';
        }

        function createProject() {
            try {
                const name = document.getElementById('projectName').value.trim();
                const description = document.getElementById('projectDescription').value.trim();
                const goals = document.getElementById('projectGoals').value.trim();
                const requirements = document.getElementById('projectRequirements').value.trim();

                if (!name || !description) {
                    showStatus('projectStatus', 'Error: Project name and description are required', 'error');
                    return;
                }

                // Send createProject message to extension
                vscode.postMessage({
                    type: 'createProject',
                    payload: {
                        name,
                        description,
                        goals,
                        requirements
                    }
                });

                clearProjectForm();
                showStatus('projectStatus', 'ðŸš€ Creating project...', 'info');
            } catch (error) {
                showStatus('projectStatus', 'Error: ' + error.message, 'error');
            }
        }

        function clearProjectForm() {
            document.getElementById('projectName').value = '';
            document.getElementById('projectDescription').value = '';
            document.getElementById('projectGoals').value = '';
            document.getElementById('projectRequirements').value = '';

            document.querySelectorAll('#userSelection input[type="checkbox"]').forEach(cb => {
                cb.checked = false;
            });
        }

        function joinProject() {
            try {
                const inviteCode = document.getElementById('inviteCode').value.trim().toUpperCase();

                if (!inviteCode || inviteCode.length !== 6) {
                    showStatus('joinStatus', 'Error: Please enter a valid 6-character invite code', 'error');
                    return;
                }

                // Send joinProject message to extension
                vscode.postMessage({
                    type: 'joinProject',
                    payload: {
                        inviteCode
                    }
                });

                document.getElementById('inviteCode').value = '';
                showStatus('joinStatus', 'ðŸ”— Joining project...', 'info');
            } catch (error) {
                showStatus('joinStatus', 'Error: ' + error.message, 'error');
            }
        }

        function setPromptLoading(isLoading) {
            const btn = document.getElementById('generate-prompt-btn');
            if (!btn) return;

            if (isLoading) {
                btn.disabled = true;
                btn.textContent = 'Generating...';
                document.body.classList.add('ai-loading');
            } else {
                btn.disabled = false;
                btn.textContent = 'Generate AI Prompt';
                document.body.classList.remove('ai-loading');
            }
        }

        // Terminal-like status display functions
        let terminalContainer = null;

        function initTerminalDisplay() {
            const promptOutput = document.getElementById('promptOutput');
            if (!promptOutput) return;

            // Clear existing content and create terminal
            promptOutput.innerHTML = '';
            promptOutput.style.display = 'block';
            
            terminalContainer = document.createElement('div');
            terminalContainer.className = 'terminal-output';
            terminalContainer.id = 'terminalContainer';
            promptOutput.appendChild(terminalContainer);
            
            return terminalContainer;
        }

        function addTerminalLine(message, type = 'info', icon = '') {
            if (!terminalContainer) {
                terminalContainer = document.getElementById('terminalContainer');
                if (!terminalContainer) {
                    initTerminalDisplay();
                }
            }

            const line = document.createElement('div');
            line.className = `terminal-line ${type}`;
            
            const timestamp = document.createElement('span');
            timestamp.className = 'terminal-timestamp';
            const now = new Date();
            timestamp.textContent = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}:${String(now.getSeconds()).padStart(2, '0')}`;
            
            const iconSpan = document.createElement('span');
            iconSpan.className = 'terminal-icon';
            iconSpan.textContent = icon || getIconForType(type);
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'terminal-message';
            messageSpan.textContent = message;
            
            line.appendChild(timestamp);
            line.appendChild(iconSpan);
            line.appendChild(messageSpan);
            
            terminalContainer.appendChild(line);
            
            // Auto-scroll to bottom
            terminalContainer.scrollTop = terminalContainer.scrollHeight;
        }

        function getIconForType(type) {
            const icons = {
                'info': '>>',
                'success': 'OK',
                'warning': '!!',
                'error': 'XX',
                'processing': '..'
            };
            return icons[type] || '>>';
        }

        function clearTerminal() {
            if (terminalContainer) {
                terminalContainer.innerHTML = '';
            }
        }

        function completeTerminal(success = true) {
            if (!terminalContainer) return;
            
            const line = document.createElement('div');
            line.className = `terminal-line ${success ? 'success' : 'error'}`;
            line.style.marginTop = '10px';
            line.style.paddingTop = '10px';
            line.style.borderTop = '1px solid #334155';
            
            const messageSpan = document.createElement('span');
            messageSpan.className = 'terminal-message';
            messageSpan.style.fontWeight = 'bold';
            messageSpan.textContent = success 
                ? '>>> ANALYSIS COMPLETE <<<'
                : '>>> ANALYSIS FAILED <<<';
            
            line.appendChild(messageSpan);
            terminalContainer.appendChild(line);
            terminalContainer.scrollTop = terminalContainer.scrollHeight;
        }

        function generatePrompt() {
            try {
                const projectId = document.getElementById('promptProject').value;
                if (!projectId) {
                    throw new Error('Please select a project');
                }
                
                // Get analysis mode configuration
                const modeConfig = getAnalysisModeConfig();
                
                setPromptLoading(true); // disable button + loading cursor
                
                // Update status message with mode
                showStatus('promptStatus', `${modeConfig.icon} Generating ${modeConfig.name}...`, 'info');
                
                // Send with mode configuration
                app.generateAIPrompt(projectId, modeConfig);
            } catch (error) {
                showStatus('promptStatus', 'Error: ' + error.message, 'error');
                setPromptLoading(false); // restore if something fails
            }
        }

        function copyPrompt() {
            const promptOutput = document.getElementById('promptOutput');
            const text = promptOutput.textContent;

            if (!text || text.trim() === '' || text.includes('Select a project above') || text.includes('Generating AI prompt')) {
                showStatus('promptStatus', 'âŒ No prompt to copy. Generate a prompt first.', 'error');
                return;
            }

            navigator.clipboard.writeText(text).then(() => {
                showStatus('promptStatus', 'ðŸ“‹ Prompt copied to clipboard!', 'success');
            }).catch(() => {
                showStatus('promptStatus', 'âŒ Failed to copy to clipboard', 'error');
            });
        }

        function startProject() {
            try {
                const projectId = document.getElementById('promptProject').value;
                const project = app.projects.find(p => p.id == projectId);

                if (!projectId) {
                    throw new Error('Please select a project to start');
                }

                // Notify the extension to start the project
                vscode.postMessage({ type: 'startProject', payload: { projectId } });

                // Notify the extension to open a new file (e.g., a welcome file or project-specific file)
                vscode.postMessage({ type: 'openFile', payload: { filePath: `projects/${projectId}/README.md` } });

                showStatus('promptStatus', 'Starting ' + (project ? project.name : 'Unknown Project'), 'success');
            } catch (error) {
                showStatus('promptStatus', error.message, 'error');
            }
        }

        function clearLatestAnalysis() {
            // Hide the results section
            const resultsSection = document.getElementById('results-section');
            const visualization = document.getElementById('aiAnalysisVisualization');
            
            if (resultsSection) {
                resultsSection.style.display = 'none';
            }
            
            if (visualization) {
                visualization.innerHTML = '';
            }
            
            // Wait a moment then reload past analyses to include the one we just cleared
            setTimeout(() => {
                const projectSelect = document.getElementById('promptProject');
                if (projectSelect && projectSelect.value) {
                    vscode.postMessage({
                        type: 'getPastAnalyses',
                        payload: { projectId: projectSelect.value }
                    });
                }
            }, 500);
            
            showStatus('promptStatus', 'Analysis cleared. Check Past Analyses below.', 'success');
        }

        function deleteAnalysis(analysisId) {
            try {
                console.log('deleteAnalysis called with ID:', analysisId);
                
                // Get current project for refresh
                const projectSelect = document.getElementById('promptProject');
                const projectId = projectSelect ? projectSelect.value : null;
                
                console.log('Project ID for refresh:', projectId);
                
                // Send delete request to extension
                vscode.postMessage({
                    type: 'deleteAnalysis',
                    payload: { 
                        analysisId: analysisId,
                        projectId: projectId
                    }
                });
                
                console.log('Delete message sent to extension');
                
                // Also hide the past analysis view if this was the selected one
                const viewContainer = document.getElementById('pastAnalysisView');
                if (viewContainer) {
                    viewContainer.style.display = 'none';
                    viewContainer.innerHTML = '';
                    console.log('Past analysis view hidden');
                }
                
                showStatus('promptStatus', 'Analysis deleted', 'success');
            } catch (error) {
                console.error('Error in deleteAnalysis:', error);
                showStatus('promptStatus', 'Failed to delete analysis', 'error');
            }
        }

        // Analysis Mode System
        const analysisModes = {
            'initial': {
                name: 'Initial Planning',
                icon: '',
                description: 'Perfect for <strong>new projects</strong>. Analyzes requirements, breaks down tasks, and assigns roles based on team member skills.',
                features: ['Team composition analysis', 'Task breakdown & priorities', 'Role assignments', 'Deliverables mapping', 'Feasibility assessment'],
                usesRAG: false,
                requiresWorkspace: false
            },
            'progress': {
                name: 'Progress Update',
                icon: '',
                description: 'Agentic AI that <strong>reads your actual codebase</strong>. Analyzes what\'s been built, compares against plan, identifies blockers, and recommends next steps.',
                features: ['Live code analysis', 'Completion status', 'Quality assessment', 'Blocker identification', 'Team performance review', 'Next priorities'],
                usesRAG: true,
                requiresWorkspace: true
            }
        };

        let currentAnalysisMode = 'initial';

        function updateModeDescription() {
            const modeSelect = document.getElementById('analysis-mode');
            const descText = document.getElementById('mode-desc-text');
            const ragRequirement = document.getElementById('mode-rag-requirement');
            const modeSummary = document.getElementById('mode-summary-text');
            
            if (!modeSelect || !descText) return;
            
            const mode = analysisModes[modeSelect.value];
            currentAnalysisMode = modeSelect.value;
            
            // Update summary text
            if (modeSummary) {
                modeSummary.textContent = mode.name;
            }
            
            // Update compact description
            let html = `<div style="margin-bottom: 8px; color: #000000;"><strong style="font-size: 0.85rem; color: #000000;">${mode.name}:</strong> ${mode.description}</div>`;
            html += '<div style="font-size: 0.75rem; color: #1e293b; margin-top: 8px; line-height: 1.6;"><strong style="color: #000000;">Includes:</strong> ';
            html += mode.features.map(f => `<span style="color: #000000;">${f}</span>`).join(' â€¢ ');
            html += '</div>';
            descText.innerHTML = html;
            
            // Show RAG requirement
            if (ragRequirement) {
                ragRequirement.style.display = mode.usesRAG ? 'block' : 'none';
            }
        }

        // Add details toggle animation
        document.addEventListener('DOMContentLoaded', () => {
            const detailsElements = document.querySelectorAll('details');
            detailsElements.forEach(details => {
                details.addEventListener('toggle', (e) => {
                    const arrow = e.target.querySelector('summary span:first-child');
                    if (arrow) {
                        arrow.style.transform = details.open ? 'rotate(90deg)' : 'rotate(0deg)';
                    }
                });
            });
        });

        function getAnalysisModeConfig() {
            const mode = analysisModes[currentAnalysisMode];
            return {
                mode: currentAnalysisMode,
                name: mode.name,
                icon: mode.icon,
                usesRAG: mode.usesRAG,
                requiresWorkspace: mode.requiresWorkspace
            };
        }

        // RAG Functions
        function updateRAGStatus(stats) {
            const toggle = document.getElementById('rag-toggle-switch');
            const statusBadge = document.getElementById('rag-status-badge');
            const indexBtn = document.getElementById('index-workspace-btn');
            
            if (!stats) {
                if (toggle) toggle.disabled = true;
                if (statusBadge) statusBadge.textContent = '(Not indexed)';
                if (indexBtn) indexBtn.style.display = 'none';
                updateRAGAnalysisBadge(null);
                return;
            }
            
            if (toggle) {
                toggle.disabled = false;
                toggle.checked = stats.enabled || false;
            }
            
            if (statusBadge) {
                if (stats.totalFiles > 0) {
                    statusBadge.textContent = `(${stats.totalFiles} files)`;
                    statusBadge.style.color = '#059669';
                } else if (stats.enabled) {
                    statusBadge.textContent = '(Ready to index)';
                    statusBadge.style.color = '#f59e0b';
                } else {
                    statusBadge.textContent = '(Not indexed)';
                    statusBadge.style.color = '#64748b';
                }
            }
            
            if (indexBtn) {
                if (stats.enabled && stats.totalFiles === 0) {
                    indexBtn.style.display = 'block';
                    indexBtn.textContent = 'Index';
                } else if (stats.enabled && stats.totalFiles > 0) {
                    indexBtn.style.display = 'block';
                    indexBtn.textContent = 'Re-index';
                } else {
                    indexBtn.style.display = 'none';
                }
            }
            
            // Update the analysis badge
            updateRAGAnalysisBadge(stats);
        }

        // Update the RAG status badge near "Generate AI Analysis" button
        function updateRAGAnalysisBadge(stats) {
            const badge = document.getElementById('rag-analysis-badge');
            const icon = document.getElementById('rag-analysis-icon');
            const text = document.getElementById('rag-analysis-text');
            const quickToggle = document.getElementById('rag-quick-toggle');
            
            if (!stats || !stats.enabled) {
                // RAG is disabled or no stats
                if (badge) badge.style.display = 'none';
                return;
            }
            
            // Show badge if RAG is enabled
            if (badge) badge.style.display = 'flex';
            
            // Update badge appearance based on status
            if (stats.totalFiles > 0) {
                // RAG is active and will be used
                if (icon) icon.textContent = 'âœ¨';
                if (text) {
                    text.textContent = 'Smart Context ON';
                    text.style.color = '#10b981';
                }
                badge.querySelector('.rag-analysis-indicator').style.background = 'rgba(16, 185, 129, 0.1)';
                badge.querySelector('.rag-analysis-indicator').style.borderColor = 'rgba(16, 185, 129, 0.3)';
            } else {
                // RAG is enabled but not indexed
                if (icon) icon.textContent = 'âš ï¸';
                if (text) {
                    text.textContent = 'Not Indexed';
                    text.style.color = '#f59e0b';
                }
                badge.querySelector('.rag-analysis-indicator').style.background = 'rgba(245, 158, 11, 0.1)';
                badge.querySelector('.rag-analysis-indicator').style.borderColor = 'rgba(245, 158, 11, 0.3)';
            }
            
            // Sync quick toggle with current state
            if (quickToggle) {
                quickToggle.checked = stats.enabled || false;
            }
        }

        // Show/hide RAG analysis tooltip
        let ragTooltipVisible = false;
        function toggleRAGAnalysisTooltip() {
            const tooltip = document.getElementById('rag-analysis-tooltip');
            const content = document.getElementById('rag-tooltip-content');
            const projectId = document.getElementById('promptProject')?.value;
            
            if (!tooltip || !projectId) return;
            
            ragTooltipVisible = !ragTooltipVisible;
            tooltip.style.display = ragTooltipVisible ? 'block' : 'none';
            
            if (ragTooltipVisible && content) {
                // Get current RAG stats
                vscode.postMessage({
                    type: 'getRAGStats',
                    payload: { projectId }
                });
                
                // Show loading state
                content.innerHTML = '<div style="color: #94a3b8;">Loading...</div>';
            }
        }

        function updateRAGTooltipContent(stats) {
            const content = document.getElementById('rag-tooltip-content');
            if (!content) return;
            
            if (!stats || !stats.enabled) {
                content.innerHTML = `
                    <div style="color: #94a3b8;">
                        Smart Context is <strong style="color: #ef4444;">disabled</strong> for this project.
                        <br><br>
                        Enable it below to send relevant code snippets to AI.
                    </div>
                `;
                return;
            }
            
            if (stats.totalFiles === 0) {
                content.innerHTML = `
                    <div style="color: #f59e0b;">
                        âš ï¸ Smart Context is enabled but <strong>not indexed</strong>.
                        <br><br>
                        Click the <strong>"Index"</strong> button above to scan your workspace.
                    </div>
                `;
            } else {
                const lastIndexed = stats.lastIndexed ? new Date(stats.lastIndexed).toLocaleString() : 'Unknown';
                content.innerHTML = `
                    <div style="color: #10b981;">
                        âœ¨ Smart Context is <strong>active</strong>!
                        <br><br>
                        <div style="color: #cbd5e1; margin-top: 8px;">
                            ðŸ“ <strong>${stats.totalFiles}</strong> files indexed<br>
                            ðŸ“¦ <strong>${stats.totalChunks}</strong> code chunks<br>
                            ðŸ•’ Last indexed: <span style="font-size: 0.7rem;">${lastIndexed}</span>
                        </div>
                        <br>
                        <div style="color: #94a3b8; font-size: 0.7rem;">
                            Your AI analysis will include relevant code context from your workspace.
                        </div>
                    </div>
                `;
            }
        }

        function indexWorkspace() {
            try {
                const projectId = document.getElementById('promptProject').value;
                if (!projectId) {
                    throw new Error('Please select a project first');
                }

                // Show loading state
                const btn = document.getElementById('index-workspace-btn');
                const statusBadge = document.getElementById('rag-status-badge');
                
                if (btn) {
                    btn.disabled = true;
                    btn.textContent = 'Indexing...';
                }
                if (statusBadge) {
                    statusBadge.textContent = 'Indexing...';
                    statusBadge.style.color = '#3b82f6';
                }

                // Send message to extension
                vscode.postMessage({
                    type: 'indexWorkspace',
                    payload: { projectId }
                });

            } catch (error) {
                showStatus('promptStatus', 'Error: ' + error.message, 'error');
            }
        }

        function toggleRAG(enabled) {
            const projectId = document.getElementById('promptProject').value;
            
            if (!projectId) {
                showStatus('promptStatus', 'Please select a project first', 'error');
                const toggle = document.getElementById('rag-toggle-switch');
                if (toggle) toggle.checked = !enabled;
                return;
            }

            vscode.postMessage({
                type: 'toggleRAG',
                payload: { projectId, enabled }
            });
        }

        // Past Analyses Functions
        function loadPastAnalyses(projectId) {
            console.log('loadPastAnalyses called with projectId:', projectId);
            // Request past analyses from extension
            vscode.postMessage({
                type: 'loadPastAnalyses',
                payload: { projectId }
            });
        }

        function displayPastAnalyses(analyses) {
            console.log('displayPastAnalyses called with:', analyses);
            const listContainer = document.getElementById('pastAnalysisList');
            const itemsContainer = document.getElementById('pastAnalysisItems');
            
            console.log('Elements found:', { listContainer: !!listContainer, itemsContainer: !!itemsContainer });
            
            if (!analyses || analyses.length === 0) {
                console.log('No analyses to display');
                if (listContainer) listContainer.style.display = 'none';
                return;
            }

            console.log('Displaying', analyses.length, 'analyses');
            if (listContainer) listContainer.style.display = 'block';
            
            if (itemsContainer) {
                itemsContainer.innerHTML = analyses.map((analysis, index) => {
                    const date = new Date(analysis.created_at);
                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                    
                    // Try to parse the response to get a better preview
                    let preview = '';
                    try {
                        const parsed = JSON.parse(analysis.ai_response);
                        if (parsed.summary) {
                            preview = parsed.summary.substring(0, 80);
                        } else if (parsed.teamAnalysis && parsed.teamAnalysis.summary) {
                            preview = parsed.teamAnalysis.summary.substring(0, 80);
                        } else {
                            preview = analysis.ai_response.substring(0, 80).replace(/\n/g, ' ');
                        }
                    } catch (e) {
                        preview = analysis.ai_response.substring(0, 80).replace(/\n/g, ' ');
                    }
                    
                    return `
                        <div class="past-analysis-item" data-analysis-id="${analysis.id}" data-index="${index}" style="position: relative; padding: 10px; margin-bottom: 6px; background: #ffffff; border-radius: 6px; cursor: pointer; border: 1px solid #e2e8f0; transition: all 0.15s;">
                            <button 
                                class="delete-analysis-btn" 
                                data-analysis-id="${analysis.id}"
                                style="position: absolute; top: 8px; right: 8px; background: #fee2e2; border: 1px solid #fca5a5; color: #ef4444; cursor: pointer; font-size: 1.2rem; font-weight: bold; padding: 0px 6px; border-radius: 3px; z-index: 10; line-height: 1; transition: all 0.2s; pointer-events: auto;" 
                                title="Delete this analysis">Ã—</button>
                            <div style="color: #3b82f6; font-size: 0.75rem; font-weight: 600; margin-bottom: 3px; padding-right: 30px;">${dateStr}</div>
                            <div style="color: #475569; font-size: 0.8rem; line-height: 1.4; padding-right: 30px;">${preview}...</div>
                        </div>
                    `;
                }).join('');

                // Add click handlers for viewing
                itemsContainer.querySelectorAll('.past-analysis-item').forEach((item, index) => {
                    // Click on item to view (but not on delete button)
                    item.addEventListener('click', (e) => {
                        // Check if click is on delete button or inside it
                        if (e.target.classList.contains('delete-analysis-btn') || 
                            e.target.closest('.delete-analysis-btn')) {
                            return; // Don't view if clicking delete button
                        }
                        
                        // Remove selected class from all
                        itemsContainer.querySelectorAll('.past-analysis-item').forEach(i => {
                            i.style.borderColor = '#e2e8f0';
                            i.style.background = '#ffffff';
                        });
                        // Add to clicked
                        item.style.borderColor = '#3b82f6';
                        item.style.background = '#eff6ff';
                        // Display the analysis
                        displaySelectedAnalysis(analyses[index]);
                    });
                });
                
                // Add delete button handlers
                itemsContainer.querySelectorAll('.delete-analysis-btn').forEach((btn) => {
                    btn.addEventListener('click', function(e) {
                        e.stopPropagation();
                        e.preventDefault();
                        
                        try {
                            const analysisId = this.getAttribute('data-analysis-id');
                            console.log('Delete button clicked for:', analysisId);
                            // Directly delete without confirm because confirm dialogs may be blocked in VS Code webviews
                            deleteAnalysis(analysisId);
                        } catch (err) {
                            console.error('Error in delete button handler:', err);
                        }
                    });
                    
                    // Hover effects
                    btn.addEventListener('mouseenter', function() {
                        this.style.background = '#fca5a5';
                        this.style.transform = 'scale(1.1)';
                    });
                    btn.addEventListener('mouseleave', function() {
                        this.style.background = '#fee2e2';
                        this.style.transform = 'scale(1)';
                    });
                });
            }
        }

        function displaySelectedAnalysis(analysis) {
            const viewContainer = document.getElementById('pastAnalysisView');
            if (!viewContainer) return;
            
            viewContainer.style.display = 'block';
            
            // Try to parse the analysis response
            let parsed = null;
            let isProgressUpdate = false;
            try {
                parsed = JSON.parse(analysis.ai_response);
                // Detect if it's a progress update by checking for progress-specific fields
                isProgressUpdate = parsed.completionStatus || parsed.codeQuality || parsed.teamPerformance;
            } catch (e) {
                console.log('Could not parse analysis as JSON, displaying as text');
            }
            
            // Determine analysis type badge
            const typeBadge = isProgressUpdate 
                ? '<span style="display: inline-block; padding: 3px 10px; background: #dbeafe; color: #1e40af; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 10px;">Progress Update</span>'
                : '<span style="display: inline-block; padding: 3px 10px; background: #ede9fe; color: #6b21a8; border-radius: 4px; font-size: 0.75rem; font-weight: 600; margin-left: 10px;">Initial Planning</span>';
            
            // Use the same rendering logic as live results
            if (parsed) {
                const projectName = analysis.project_name || 'Project';
                
                // Use appropriate rendering based on analysis type
                if (isProgressUpdate) {
                    // Render progress update
            viewContainer.innerHTML = `
                        <div style="background: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                                <div>
                                    <h3 style="color: #1e293b; margin: 0; font-size: 1.1rem; display: inline-block;">Analysis from ${new Date(analysis.created_at).toLocaleString()}</h3>
                                    ${typeBadge}
                                </div>
                            </div>
                            ${renderProgressAnalysisVisualization(parsed, projectName)}
                        </div>
                    `;
                } else {
                    // Render initial planning
                    viewContainer.innerHTML = `
                        <div style="background: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0;">
                            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid #e2e8f0;">
                                <div>
                                    <h3 style="color: #1e293b; margin: 0; font-size: 1.1rem; display: inline-block;">Analysis from ${new Date(analysis.created_at).toLocaleString()}</h3>
                                    ${typeBadge}
                                </div>
                            </div>
                            ${renderAnalysisVisualization(parsed, projectName)}
                        </div>
                    `;
                }
            } else {
                // Fallback to text display with better styling
                viewContainer.innerHTML = `
                    <div style="background: #f8fafc; border-radius: 8px; padding: 20px; border: 1px solid #e2e8f0;">
                        <h3 style="color: #1e293b; margin-bottom: 15px; font-size: 1.1rem;">Analysis from ${new Date(analysis.created_at).toLocaleString()}</h3>
                        <div style="background: #ffffff; color: #1e293b; padding: 15px; border-radius: 6px; white-space: pre-wrap; max-height: 500px; overflow-y: auto; font-family: monospace; font-size: 0.85rem; line-height: 1.6; border: 1px solid #e2e8f0;">
${analysis.ai_response}
                    </div>
                </div>
            `;
            }
        }

        // Render progress analysis visualization (for progress updates)
        function renderProgressAnalysisVisualization(data, projectName) {
            if (!data) return '<p>No analysis data available</p>';

            let html = `<div style="margin-bottom: 15px;">
                <h2 style="color: #1e293b; font-size: 1.3rem; margin-bottom: 3px;">${projectName || 'Project'} Progress Update</h2>
                <p style="color: #64748b; font-size: 0.8rem;">Real-time codebase analysis and progress tracking</p>
            </div>`;

            // Completion Status Section (Always visible, shows progress bar)
            if (data.completionStatus) {
                const percent = data.completionStatus.percentComplete || 0;
                const percentColor = percent >= 75 ? '#10b981' : percent >= 50 ? '#f59e0b' : percent >= 25 ? '#3b82f6' : '#ef4444';
                const completedCount = data.completionStatus.completedAreas?.length || 0;
                const inProgressCount = data.completionStatus.inProgress?.length || 0;
                const notStartedCount = data.completionStatus.notStarted?.length || 0;
                
                html += `<details class="analysis-details" open>
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ“Š Completion Status</span>
                        <span class="summary-badge" style="background: ${percentColor}20; color: ${percentColor}; font-weight: 700;">${percent}%</span>
                        ${completedCount > 0 ? `<span class="summary-badge success">${completedCount} done</span>` : ''}
                        ${inProgressCount > 0 ? `<span class="summary-badge info">${inProgressCount} active</span>` : ''}
                    </summary>
                    <div class="analysis-content">
                        <div style="margin-bottom: 15px;">
                            <div style="display: flex; align-items: center; justify-content: space-between; margin-bottom: 8px;">
                                <span style="font-size: 1.5rem; font-weight: 700; color: ${percentColor};">${percent}%</span>
                                <span style="color: #64748b; font-size: 0.8rem;">Complete</span>
                            </div>
                            <div style="width: 100%; background: #e2e8f0; border-radius: 6px; height: 10px; overflow: hidden;">
                                <div style="width: ${percent}%; background: ${percentColor}; height: 100%; transition: width 0.3s;"></div>
                            </div>
                        </div>
                        ${data.completionStatus.completedAreas && data.completionStatus.completedAreas.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #10b981; font-size: 0.8rem;">âœ“ Completed:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.completionStatus.completedAreas.map(area => `<li style="margin: 3px 0; color: #475569;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.completionStatus.inProgress && data.completionStatus.inProgress.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #3b82f6; font-size: 0.8rem;">âš¡ In Progress:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.completionStatus.inProgress.map(area => `<li style="margin: 3px 0; color: #475569;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.completionStatus.notStarted && data.completionStatus.notStarted.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #64748b; font-size: 0.8rem;">â—‹ Not Started:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.completionStatus.notStarted.map(area => `<li style="margin: 3px 0; color: #64748b;">${area}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                    </div>
                </details>`;
            }

            // Code Quality Section (Collapsible)
            if (data.codeQuality) {
                const score = data.codeQuality.overallScore || 0;
                const scoreColor = score >= 8 ? '#10b981' : score >= 6 ? '#3b82f6' : score >= 4 ? '#f59e0b' : '#ef4444';
                const strengthsCount = data.codeQuality.strengths?.length || 0;
                const concernsCount = data.codeQuality.concerns?.length || 0;
                
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ’Ž Code Quality</span>
                        <span class="summary-badge" style="background: ${scoreColor}20; color: ${scoreColor}; font-weight: 700;">${score}/10</span>
                        ${strengthsCount > 0 ? `<span class="summary-badge success">${strengthsCount} strength${strengthsCount > 1 ? 's' : ''}</span>` : ''}
                        ${concernsCount > 0 ? `<span class="summary-badge warning">${concernsCount} concern${concernsCount > 1 ? 's' : ''}</span>` : ''}
                    </summary>
                    <div class="analysis-content">
                        ${data.codeQuality.strengths && data.codeQuality.strengths.length > 0 ? `
                            <div style="margin-bottom: 10px;">
                                <strong style="color: #10b981; font-size: 0.8rem;">âœ“ Strengths:</strong>
                                <ul style="margin-top: 6px; padding-left: 18px; font-size: 0.8rem;">
                                    ${data.codeQuality.strengths.map(strength => `<li style="margin: 3px 0; color: #475569;">${strength}</li>`).join('')}
                                </ul>
                            </div>
                        ` : ''}
                        ${data.codeQuality.concerns && data.codeQuality.concerns.length > 0 ? `
                            <div style="margin-top: 10px;">
                                <strong style="color: #f59e0b; font-size: 0.8rem;">âš  Concerns:</strong>
                                ${data.codeQuality.concerns.map(concern => `
                                    <div style="padding: 8px 10px; background: #fef3c7; border-radius: 4px; margin-top: 6px; font-size: 0.8rem; color: #92400e; border-left: 2px solid #f59e0b;">${concern}</div>
                                `).join('')}
                            </div>
                        ` : ''}
                    </div>
                </details>`;
            }

            // Team Performance Section (Collapsible)
            if (data.teamPerformance && data.teamPerformance.length > 0) {
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸ‘¥ Team Performance</span>
                        <span class="summary-badge info">${data.teamPerformance.length} member${data.teamPerformance.length > 1 ? 's' : ''}</span>
                    </summary>
                    <div class="analysis-content">
                        ${data.teamPerformance.map(member => `
                            <div class="member-card-compact">
                                <div style="font-weight: 600; color: #1e293b; font-size: 0.9rem; margin-bottom: 8px;">${member.memberName || 'Team Member'}</div>
                                ${member.contributions ? `
                                    <div style="margin-bottom: 8px;">
                                        <strong style="font-size: 0.75rem; color: #059669;">ðŸ“ Contributions:</strong>
                                        <div style="font-size: 0.8rem; color: #475569; margin-top: 3px;">${member.contributions}</div>
                                    </div>
                                ` : ''}
                                ${member.suggestions ? `
                                    <div style="margin-bottom: 8px;">
                                        <strong style="font-size: 0.75rem; color: #3b82f6;">ðŸ’¡ Suggestions:</strong>
                                        <div style="font-size: 0.8rem; color: #475569; margin-top: 3px;">${member.suggestions}</div>
                                    </div>
                                ` : ''}
                                ${member.supportNeeded ? `
                                    <div style="padding: 6px 8px; background: #fef3c7; border-radius: 3px; border-left: 2px solid #f59e0b; font-size: 0.75rem; color: #92400e;">
                                        <strong>ðŸ†˜ Support Needed:</strong> ${member.supportNeeded}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </details>`;
            }

            // Blockers Section (Collapsible)
            if (data.blockers && data.blockers.length > 0) {
                html += `<details class="analysis-details">
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸš§ Blockers</span>
                        <span class="summary-badge warning">${data.blockers.length} blocker${data.blockers.length > 1 ? 's' : ''}</span>
                    </summary>
                    <div class="analysis-content">
                        ${data.blockers.map(blocker => `
                            <div style="padding: 10px; background: #fee2e2; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #dc2626;">
                                <div style="font-weight: 600; color: #7f1d1d; font-size: 0.85rem; margin-bottom: 6px;">${blocker.issue}</div>
                                ${blocker.affectedMembers && blocker.affectedMembers.length > 0 ? `
                                    <div style="font-size: 0.75rem; color: #991b1b; margin-bottom: 4px;">
                                        <strong>Affected:</strong> ${blocker.affectedMembers.join(', ')}
                                    </div>
                                ` : ''}
                                ${blocker.suggestedSolution ? `
                                    <div style="font-size: 0.75rem; color: #991b1b;">
                                        <strong>Solution:</strong> ${blocker.suggestedSolution}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </details>`;
            }

            // Next Priorities Section (Collapsible)
            if (data.nextPriorities && data.nextPriorities.length > 0) {
                html += `<details class="analysis-details" open>
                    <summary class="analysis-summary">
                        <span class="summary-arrow">â–¶</span>
                        <span class="summary-title">ðŸŽ¯ Next Priorities</span>
                        <span class="summary-badge info">${data.nextPriorities.length} task${data.nextPriorities.length > 1 ? 's' : ''}</span>
                    </summary>
                    <div class="analysis-content">
                        ${data.nextPriorities.map((priority, index) => `
                            <div style="padding: 10px; background: #dbeafe; border-radius: 4px; margin-bottom: 8px; border-left: 2px solid #3b82f6;">
                                <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 4px;">
                                    <span style="font-weight: 700; color: #1e40af; font-size: 0.75rem;">#${index + 1}</span>
                                    <span style="font-weight: 600; color: #1e40af; font-size: 0.85rem; flex: 1;">${priority.priority}</span>
                                </div>
                                ${priority.assignTo ? `
                                    <div style="font-size: 0.75rem; color: #1e40af; margin-bottom: 3px;">
                                        <strong>Assign to:</strong> ${priority.assignTo}
                                    </div>
                                ` : ''}
                                ${priority.reasoning ? `
                                    <div style="font-size: 0.75rem; color: #1e40af;">
                                        <strong>Why:</strong> ${priority.reasoning}
                                    </div>
                                ` : ''}
                            </div>
                        `).join('')}
                    </div>
                </details>`;
            }

            // Summary Section (if available)
            if (data.summary) {
                html += `<div style="margin-top: 15px; padding: 12px; background: #f0fdf4; border-radius: 6px; border-left: 3px solid #10b981;">
                    <div style="font-weight: 600; color: #065f46; font-size: 0.85rem; margin-bottom: 6px;">ðŸ“ Summary</div>
                    <div style="color: #166534; font-size: 0.8rem; line-height: 1.5;">${data.summary}</div>
                </div>`;
            }

            return html;
        }

        // Workspace-Project Linking Functions
        let currentWorkspaceInfo = {
            workspacePath: null,
            linkedProjectId: null,
            lastSelectedProjectId: null,
            hasWorkspace: false
        };

        function updateWorkspaceUI() {
            const linkInfo = document.getElementById('workspace-link-info');
            const linkContainer = document.getElementById('link-workspace-container');
            const linkText = document.getElementById('workspace-link-text');
            const projectSelect = document.getElementById('promptProject');
            const selectedProjectId = projectSelect?.value?.trim();

            if (!currentWorkspaceInfo.hasWorkspace) {
                // No workspace folder open
                if (linkInfo) linkInfo.style.display = 'none';
                if (linkContainer) linkContainer.style.display = 'none';
                return;
            }

            if (currentWorkspaceInfo.linkedProjectId) {
                // Show linked info
                if (linkInfo) {
                    linkInfo.style.display = 'flex';
                    if (linkText) {
                        const projectName = getProjectNameById(currentWorkspaceInfo.linkedProjectId) || currentWorkspaceInfo.linkedProjectId;
                        linkText.textContent = `This workspace is linked to "${projectName}"`;
                    }
                }
                if (linkContainer) linkContainer.style.display = 'none';
            } else if (selectedProjectId) {
                // Show link button (only if a project is selected)
                if (linkInfo) linkInfo.style.display = 'none';
                if (linkContainer) linkContainer.style.display = 'block';
            } else {
                // No project selected, hide all
                if (linkInfo) linkInfo.style.display = 'none';
                if (linkContainer) linkContainer.style.display = 'none';
            }
        }

        function getProjectNameById(projectId) {
            // Helper to get project name from the projects list
            if (!app.projects) return null;
            const project = app.projects.find(p => p.id === projectId);
            return project?.name || null;
        }

        function linkProjectToWorkspace() {
            const projectSelect = document.getElementById('promptProject');
            const projectId = projectSelect?.value?.trim();
            
            if (!projectId) {
                alert('Please select a project first');
                return;
            }

            vscode.postMessage({
                type: 'linkProjectToWorkspace',
                payload: { projectId }
            });
        }

        function unlinkWorkspace() {
            vscode.postMessage({
                type: 'unlinkWorkspace',
                payload: {}
            });
        }

        function requestWorkspaceInfo() {
            vscode.postMessage({
                type: 'getWorkspaceInfo',
                payload: {}
            });
        }

        function handleWorkspaceInfo(info) {
            currentWorkspaceInfo = info;
            console.log('Workspace info received:', info);

            // Auto-restore project selection if linked or last selected
            const projectSelect = document.getElementById('promptProject');
            
            if (projectSelect && !projectSelect.value) {
                // Priority: linked project > last selected
                const projectToRestore = info.linkedProjectId || info.lastSelectedProjectId;
                
                if (projectToRestore) {
                    console.log('Auto-restoring project:', projectToRestore);
                    
                    // Wait a tiny bit to ensure dropdown is populated
                    setTimeout(() => {
                        projectSelect.value = projectToRestore;
                        console.log('Set project value to:', projectToRestore, 'Current value:', projectSelect.value);
                        
                        // Trigger change event to load RAG stats, past analyses, and other project-specific data
                        const changeEvent = new Event('change', { bubbles: true });
                        projectSelect.dispatchEvent(changeEvent);
                        
                        // Update workspace UI after restoration
                        updateWorkspaceUI();
                    }, 100);
                } else {
                    // No project to restore, just update UI
                    updateWorkspaceUI();
                }
            } else {
                // Project already selected or no dropdown, just update UI
                updateWorkspaceUI();
            }
        }

        // Profile dropdown helpers
        function updateProfileDropdown() {
            const dropdownName = document.getElementById('dropdownUserName');
            const dropdownSkills = document.getElementById('dropdownSkills');
            const dropdownLanguages = document.getElementById('dropdownLanguages');
            const dropdownWilling = document.getElementById('dropdownWilling');
            const profileBtnName = document.getElementById('profileBtnName');

            const profile = app?.currentUser;

            const name = profile?.name || 'User';
            if (dropdownName) dropdownName.textContent = name;
            if (profileBtnName) profileBtnName.textContent = name;
            if (dropdownSkills) dropdownSkills.textContent = profile?.skills || 'Not specified';
            if (dropdownLanguages) dropdownLanguages.textContent = profile?.programmingLanguages || 'Not specified';
            if (dropdownWilling) dropdownWilling.textContent = profile?.willingToWorkOn || 'Not specified';
        }

        function toggleProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown?.classList.toggle('show');
        }

        function closeProfileDropdown() {
            const dropdown = document.getElementById('profileDropdown');
            dropdown?.classList.remove('show');
        }

        // Add form validation animations
        document.addEventListener('input', (e) => {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                if (e.target.value.trim() !== '') {
                    e.target.style.borderColor = '#10b981';
                    e.target.style.boxShadow = '0 0 0 3px rgba(16, 185, 129, 0.1)';
                } else if (e.target.hasAttribute('required')) {
                    e.target.style.borderColor = '#ef4444';
                    e.target.style.boxShadow = '0 0 0 3px rgba(239, 68, 68, 0.1)';
                } else {
                    e.target.style.borderColor = '#e5e7eb';
                    e.target.style.boxShadow = 'none';
                }
            }
        });

            // Centralized Event Handling & Initialization
            document.addEventListener('DOMContentLoaded', () => { // Ensure DOM is loaded
            document.getElementById('update-profile-btn')?.addEventListener('click', () => app.updateProfile());
            document.getElementById('clear-profile-form-btn')?.addEventListener('click', () => app.resetProfileForm());
            document.getElementById('create-project-btn')?.addEventListener('click', createProject);
            document.getElementById('clear-project-form-btn')?.addEventListener('click', clearProjectForm);
            document.getElementById('join-project-btn')?.addEventListener('click', joinProject);
            document.getElementById('generate-prompt-btn')?.addEventListener('click', generatePrompt);
            document.getElementById('copy-prompt-btn')?.addEventListener('click', copyPrompt);
            document.getElementById('start-project')?.addEventListener('click', startProject);
            document.getElementById('clear-analysis-btn')?.addEventListener('click', clearLatestAnalysis);
            
            // Analysis mode dropdown
            document.getElementById('analysis-mode')?.addEventListener('change', updateModeDescription);
            // Initialize mode description on load
            setTimeout(() => updateModeDescription(), 100);
            
            document.getElementById('promptProject')?.addEventListener('change', (e) => {
                const selectedProjectId = e.target.value;
                
                // Save the selected project
                if (selectedProjectId) {
                    vscode.postMessage({
                        type: 'projectSelected',
                        payload: { projectId: selectedProjectId }
                    });
                    
                    // Request RAG stats for the selected project
                    vscode.postMessage({
                        type: 'getRAGStats',
                        payload: { projectId: selectedProjectId }
                    });
                } else {
                    // Reset RAG UI when no project selected
                    updateRAGStatus(null);
                }
                
                // Update workspace UI to show/hide link button
                updateWorkspaceUI();
                
                app.renderJiraTaskDetail();
            });
            
            // RAG event listeners
            document.getElementById('rag-toggle-switch')?.addEventListener('change', (e) => {
                toggleRAG(e.target.checked);
            });
            
            document.getElementById('index-workspace-btn')?.addEventListener('click', () => {
                indexWorkspace();
            });
            
            // RAG Analysis Badge event listeners
            document.querySelector('.rag-analysis-indicator')?.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleRAGAnalysisTooltip();
            });
            
            document.getElementById('rag-tooltip-close')?.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleRAGAnalysisTooltip();
            });
            
            document.getElementById('rag-quick-toggle')?.addEventListener('change', (e) => {
                toggleRAG(e.target.checked);
            });
            
            // Close tooltip when clicking outside
            document.addEventListener('click', (e) => {
                const badge = document.getElementById('rag-analysis-badge');
                const tooltip = document.getElementById('rag-analysis-tooltip');
                if (ragTooltipVisible && badge && !badge.contains(e.target)) {
                    ragTooltipVisible = false;
                    if (tooltip) tooltip.style.display = 'none';
                }
            });
            
            // Main project dropdown - also load past analyses when project changes
            document.getElementById('promptProject')?.addEventListener('change', (e) => {
                const projectId = e.target.value;
                if (projectId) {
                    // Load past analyses for this project
                    loadPastAnalyses(projectId);
                } else {
                    // Hide past analyses if no project selected
                    document.getElementById('pastAnalysisList').style.display = 'none';
                    document.getElementById('pastAnalysisView').style.display = 'none';
                }
            });
            
            // Workspace linking event listeners
            document.getElementById('link-workspace-btn')?.addEventListener('click', () => {
                linkProjectToWorkspace();
            });
            
            document.getElementById('unlink-workspace-btn')?.addEventListener('click', () => {
                unlinkWorkspace();
            });
            
            // Request workspace info on load
            requestWorkspaceInfo();
            
            document.getElementById('profileBtn')?.addEventListener('click', (e) => {
                e.stopPropagation();
                toggleProfileDropdown();
            });
            document.getElementById('editProfileLink')?.addEventListener('click', () => {
                closeProfileDropdown();
                showTab('users');
            });
            document.addEventListener('click', (event) => {
                if (!event.target.closest('.profile-dropdown-container')) {
                    closeProfileDropdown();
                }
            });
            document.getElementById('signOutBtn')?.addEventListener('click', () => {
                vscode.postMessage({ type: 'signOut' });
            });
            document.getElementById('refresh-projects-btn')?.addEventListener('click', () => {
                showStatus('projectStatus', 'ðŸ”„ Refreshing projects...', 'info');
                vscode.postMessage({ type: 'loadData' });
            });

            document.getElementById('jira-profile-create-btn')?.addEventListener('click', () => app.createJiraTasksFromProfile());
            document.getElementById('jira-use-ai-prompt-btn')?.addEventListener('click', () => app.useAiAnalysisForJira());
            const jiraToggleBtn = document.getElementById('toggle-jira-credentials-btn');
            const jiraCredentialsCard = document.getElementById('jiraCredentialsCard');
            const jiraCredentialsBody = document.getElementById('jiraCredentialsBody');
            jiraToggleBtn?.addEventListener('click', () => {
                if (!jiraCredentialsCard || !jiraCredentialsBody) return;
                const collapsed = jiraCredentialsCard.classList.toggle('collapsed');
                jiraCredentialsBody.classList.toggle('hidden', collapsed);
                jiraToggleBtn.textContent = collapsed ? 'Show Jira setup' : 'Hide Jira setup';
                jiraToggleBtn.setAttribute('aria-expanded', String(!collapsed));
                if (!collapsed) {
                    document.getElementById('jiraBaseUrl')?.focus();
                }
            });
            document.getElementById('jiraQuickRefreshBtn')?.addEventListener('click', () => app.loadJiraTasks());
            document.getElementById('jiraJumpToBoardBtn')?.addEventListener('click', () => {
                const board = document.getElementById('jiraBoard');
                if (board) {
                    board.classList.remove('hidden');
                    board.scrollIntoView({ behavior: 'smooth', block: 'start' });
                }
            });
            const toggleAssignableCardBtn = document.getElementById('toggleAssignableCardBtn');
            const jiraAssignableCard = document.getElementById('jiraAssignableCard');
            toggleAssignableCardBtn?.addEventListener('click', () => {
                if (!jiraAssignableCard) return;
                const collapsed = jiraAssignableCard.classList.toggle('collapsed');
                toggleAssignableCardBtn.textContent = collapsed ? 'Show' : 'Hide';
                toggleAssignableCardBtn.setAttribute('aria-expanded', String(!collapsed));
            });
            document.getElementById('jiraRefreshBtn')?.addEventListener('click', () => app.loadJiraTasks());
            document.getElementById('jiraNewTaskBtn')?.addEventListener('click', () => {
                const jiraTabBtn = document.querySelector('.tab-button[data-tab="jira"]');
                showTab('jira', jiraTabBtn);
                if (!app.hasJiraCredentials()) {
                    app.showJiraStatus('Add Jira credentials in the setup card first.', 'error');
                    return;
                }
                app.startCreatingJiraTask();
            });
            document.getElementById('jiraSaveAssignableBtn')?.addEventListener('click', () => app.refreshAssignableFromJira());
            document.getElementById('jiraClearAssignableBtn')?.addEventListener('click', () => app.clearAssignableList());
            document.getElementById('jiraRefreshAssignableBtn')?.addEventListener('click', () => app.fetchAssignableFromJira());
            document.getElementById('jiraFilterStatus')?.addEventListener('change', (event) => {
                app.jiraFilters.status = event.target.value;
                app.loadJiraTasks();
            });
            let jiraSearchTimer = null;
            document.getElementById('jiraSearchInput')?.addEventListener('input', (event) => {
                const value = event.target.value;
                if (jiraSearchTimer) {
                    clearTimeout(jiraSearchTimer);
                }
                jiraSearchTimer = setTimeout(() => {
                    app.jiraFilters.search = value.trim();
                    app.loadJiraTasks();
                }, 400);
            });
            document.getElementById('jiraTaskList')?.addEventListener('click', (event) => {
                const row = event.target.closest('.jira-task-row');
                if (row?.dataset?.issueId) {
                    app.selectJiraTask(row.dataset.issueId);
                }
            });

            document.body.addEventListener('click', (event) => {
                try {
                    const target = event.target;

                    if (target.matches('.tab-button')) {
                        showTab(target.dataset.tab, target);
                        return;
                    }

                    if (target.matches('.remove-user-btn')) {
                        const userId = target.dataset.userId;
                        if (userId) {
                            app.removeUser(userId);
                        }
                        return;
                    }

                    // Handle remove member button FIRST - use closest() to handle nested elements
                    // This must be checked before other handlers to prevent event bubbling issues
                    const removeMemberBtn = target.closest('.remove-member-btn');
                    if (removeMemberBtn) {
                        event.preventDefault();
                        event.stopPropagation();
                        event.stopImmediatePropagation(); // Prevent any other handlers from running
                        
                        // Ensure modal stays open
                        const modal = document.getElementById('editProjectModal');
                        if (modal) {
                            modal.style.display = 'block';
                        }
                        
                        const projectId = removeMemberBtn.dataset.projectId;
                        const memberId = removeMemberBtn.dataset.memberId;
                        if (projectId && memberId) {
                            // Send message directly - extension will handle confirmation
                            console.log('Sending removeProjectMember message:', { projectId, memberId });
                            try {
                                vscode.postMessage({
                                    type: 'removeProjectMember',
                                    payload: { projectId, memberId }
                                });
                                // Keep modal open - don't close it here
                            } catch (err) {
                                console.error('Error posting message:', err);
                                showStatus('userStatus', 'Error sending request. Please try again.', 'error');
                            }
                        } else {
                            console.error('Missing projectId or memberId:', { projectId, memberId });
                            showStatus('userStatus', 'Error: Missing project or member information.', 'error');
                        }
                        return false; // Important: stop processing other handlers
                    }

                    // Handle delete/leave project buttons - use closest() to handle nested elements
                    const deleteBtn = target.closest('.delete-project-btn');
                    const leaveBtn = target.closest('.leave-project-btn');
                    const removeBtn = target.closest('.remove-project-btn');
                    
                    if (deleteBtn || leaveBtn || removeBtn) {
                        const button = deleteBtn || leaveBtn || removeBtn;
                        const projectId = button.dataset.projectId;
                        console.log('Button clicked:', { type: deleteBtn ? 'delete' : leaveBtn ? 'leave' : 'remove', projectId });
                        
                        if (projectId) {
                            if (deleteBtn) {
                                // Send message directly - extension will handle confirmation
                                console.log('Sending deleteProject message:', { projectId });
                                vscode.postMessage({
                                    type: 'deleteProject',
                                    payload: { projectId }
                                });
                            } else if (leaveBtn) {
                                // Send message directly - extension will handle confirmation
                                console.log('Sending leaveProject message:', { projectId });
                                vscode.postMessage({
                                    type: 'leaveProject',
                                    payload: { projectId }
                                });
                            } else if (removeBtn) {
                                // Fallback for old remove-project-btn
                                app.removeProject(projectId);
                            }
                        } else {
                            console.error('No projectId found on button:', button);
                        }
                        return;
                    }

                    if (target.matches('.edit-project-btn')) {
                        const projectId = target.dataset.projectId;
                        if (projectId) {
                            app.openEditModal(projectId);
                        }
                        return;
                    }
                } catch (error) {
                    console.error('Error in click handler:', error);
                    // Don't let errors crash the UI
                }

                if (target.id === 'jiraSaveTaskBtn' || target.id === 'jiraCreateTaskBtn') {
                    app.submitJiraTaskForm();
                }

                if (target.id === 'jiraDeleteTaskBtn') {
                    app.deleteSelectedJiraTask();
                }

                if (target.id === 'jiraCancelCreateBtn') {
                    app.isCreatingJiraTask = false;
                    app.renderJiraTaskDetail();
                }

            });

            // Edit modal handlers
            document.getElementById('closeEditModal')?.addEventListener('click', () => app.closeEditModal());
            document.getElementById('cancelEditBtn')?.addEventListener('click', () => app.closeEditModal());
            document.getElementById('saveProjectBtn')?.addEventListener('click', () => {
                const projectId = document.getElementById('editProjectId').value;
                const name = document.getElementById('editProjectName').value.trim();
                const description = document.getElementById('editProjectDescription').value;
                const goals = document.getElementById('editProjectGoals').value;
                const requirements = document.getElementById('editProjectRequirements').value;

                if (!name) {
                    showStatus('projectStatus', 'Error: Project name is required', 'error');
                    return;
                }

                if (!description.trim()) {
                    showStatus('projectStatus', 'Error: Description is required', 'error');
                    return;
                }

                vscode.postMessage({
                    type: 'updateProject',
                    payload: { projectId, name, description, goals, requirements }
                });

                app.closeEditModal();
            });

            // === TIMELINE EVENT LISTENERS - ADD THESE ===
            
            document.getElementById('refresh-files-btn')?.addEventListener('click', refreshWorkspaceFiles);
            document.getElementById('clear-timeline-search-btn')?.addEventListener('click', clearTimelineFilters);
            
            document.getElementById('timelineSearch')?.addEventListener('input', (e) => {
                app.searchFiles(e.target.value);
            });
            
            document.getElementById('timelineFilter')?.addEventListener('change', (e) => {
                app.filterFilesByType(e.target.value);
            });

            // Close button listener
            const closeBtn = document.getElementById('closeTimelineBtn');
            if (closeBtn) {
                closeBtn.addEventListener('click', function(e) {
                    e.preventDefault();
                    e.stopPropagation();
                    console.log('Close button clicked');
                    window.closeTimelineViewer();
                });
                console.log('âœ… Close button listener attached');
            }
            
            // === END TIMELINE EVENT LISTENERS ===

            // Close modal when clicking outside
            // Close modal when clicking outside (but not on buttons or interactive elements)
            document.getElementById('editProjectModal')?.addEventListener('click', (e) => {
                // Don't close if clicking on buttons, inputs, or other interactive elements
                if (e.target.closest('button') || e.target.closest('input') || e.target.closest('textarea') || e.target.closest('.modal-content')) {
                    return;
                }
                // Only close if clicking directly on the modal backdrop
                if (e.target === document.getElementById('editProjectModal')) {
                    app.closeEditModal();
                }
            });

            // Close diff viewer button
            document.getElementById('closeDiffViewer')?.addEventListener('click', closeDiffViewer);

            // Close diff viewer when clicking outside
            document.getElementById('diffViewerModal')?.addEventListener('click', function(e) {
                if (e.target === this) {
                    closeDiffViewer();
                }
            });  // â† ADD THIS LINE

            // Global error handler to prevent blank screens
            window.addEventListener('error', (event) => {
                console.error('Global error caught:', event.error, event.message, event.filename, event.lineno);
                
                // Just log to console, don't spam user with notifications
                // The extension will handle critical errors explicitly
                
                // Don't let errors crash the UI
                event.preventDefault();
                return true;
            });

            window.addEventListener('unhandledrejection', (event) => {
                console.error('Unhandled promise rejection:', event.reason);
                
                // Just log to console, don't spam user with notifications
                // The extension will handle critical errors explicitly
                
                event.preventDefault();
            });

            // Initial UI setup and tab selection
            app.updateUI();
            showTab('projects', document.querySelector('.tab-button[data-tab="projects"]'));

            // Load workspace files on startup
            vscode.postMessage({ type: 'getWorkspaceFiles' });
            console.log('Pallas AI - Team Platform initialized!');
        });
    </script>
</body>
</html>
